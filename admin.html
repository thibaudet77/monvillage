<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration MonVillage</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <style>
        .modal { 
            transition: opacity 0.3s ease-in-out;
            opacity: 0; 
            pointer-events: none; 
        }
        .modal.show { 
            opacity: 1; 
            pointer-events: auto; 
        }
        .sidebar a.active { 
            background-color: #1d4ed8; 
            color: white; 
        }
        .map-container { 
            height: 300px; 
            border-radius: 0.5rem; 
            border: 1px solid #e5e7eb; 
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen">
        <aside class="w-64 bg-white shadow-md">
            <div class="p-4">
                <h1 class="text-2xl font-bold text-gray-800">MonVillage Admin</h1>
            </div>
            <nav class="mt-4">
                <ul>
                    <li><a href="#dashboard" class="block p-4 text-gray-700 hover:bg-blue-100 active">Tableau de bord</a></li>
                    <li><a href="#villages" class="block p-4 text-gray-700 hover:bg-blue-100">Villages</a></li>
                    <li><a href="#poi" class="block p-4 text-gray-700 hover:bg-blue-100">Points d'intérêt</a></li>
                    <li><a href="#geonames" class="block p-4 text-gray-700 hover:bg-blue-100">Géonymes</a></li>
                    <li><a href="#users" class="block p-4 text-gray-700 hover:bg-blue-100">Utilisateurs</a></li>
                </ul>
            </nav>
            <div class="p-4">
                <span id="admin-name" class="text-gray-700"></span>
                <button id="logout-btn" class="block w-full mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Déconnexion</button>
            </div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto">
            <section id="dashboard" class="active">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Statistiques générales</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium">Villages</h3>
                            <p id="villages-count" class="text-2xl">-</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium">Points d'intérêt</h3>
                            <p id="poi-count" class="text-2xl">-</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium">Géonymes</h3>
                            <p id="geonames-count" class="text-2xl">-</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium">Descriptions</h3>
                            <p id="descriptions-count" class="text-2xl">-</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="villages" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Gestion des Villages</h2>
                        <button id="new-village-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Nouveau Village</button>
                    </div>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left">Nom</th>
                                <th class="p-2 text-left">Arrondissement</th>
                                <th class="p-2 text-left">Chef</th>
                                <th class="p-2 text-left">Population</th>
                                <th class="p-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="villages-table"></tbody>
                    </table>
                </div>

                <div id="village-form" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="modal-content bg-white p-6 rounded-lg max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <h2 id="village-form-title" class="text-xl font-semibold mb-4">Ajouter un Village</h2>
                        <button class="close-modal float-right px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Annuler</button>
                        <form>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Nom du village *</label>
                                    <input type="text" id="village-name" class="w-full p-2 border rounded" required>
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Arrondissement *</label>
                                    <select id="arrondissement-id" class="w-full p-2 border rounded" required></select>
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Nom du chef</label>
                                    <input type="text" id="chief-name" class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Date de prise de service</label>
                                    <input type="date" id="chief-start-date" class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Email</label>
                                    <input type="email" id="village-email" class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Téléphone</label>
                                    <input type="tel" id="village-telephone" class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Population estimée</label>
                                    <input type="number" id="village-population" class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Méthode de saisie de la géométrie *</label>
                                    <select id="geom-method" class="w-full p-2 border rounded" required>
                                        <option value="upload">Upload SQL</option>
                                        <option value="draw">Dessiner</option>
                                    </select>
                                </div>
                                <div id="geom-upload" class="form-group">
                                    <label class="block mb-1 font-medium">Format de géométrie *</label>
                                    <select id="geom-format" class="w-full p-2 border rounded">
                                        <option value="wkt">WKT</option>
                                        <option value="geojson">GeoJSON</option>
                                    </select>
                                    <label class="block mb-1 font-medium">Géométrie</label>
                                    <textarea id="geom-text" class="w-full p-2 border rounded" placeholder="Format: MULTIPOLYGON ou POLYGON en WKT/GeoJSON"></textarea>
                                </div>
                                <div id="geom-draw" class="form-group hidden">
                                    <div id="map" class="map-container"></div>
                                    <div class="flex gap-2 mt-2">
                                        <button type="button" id="start-draw" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Commencer le dessin</button>
                                        <button type="button" id="clear-draw" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Effacer</button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Photo du chef (optionnel)</label>
                                    <input type="file" id="chief-photo" accept="image/*" class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group">
                                    <label class="block mb-1 font-medium">Photos du village (max 2)</label>
                                    <input type="file" id="village-photos" accept="image/*" multiple class="w-full p-2 border rounded">
                                </div>
                                <div class="form-group col-span-2">
                                    <label class="block mb-1 font-medium">Description détaillée du village</label>
                                    <button type="button" id="add-description-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ajouter une description détaillée</button>
                                    <div id="description-form" class="mt-4 hidden">
                                        <h3 class="font-semibold">1. Présentation générale</h3>
                                        <textarea id="histoire-origine" class="w-full p-2 border rounded" placeholder="Histoire ou origine du nom"></textarea>
                                        <textarea id="description-limites" class="w-full p-2 border rounded" placeholder="Description des limites"></textarea>
                                        <textarea id="importance-region" class="w-full p-2 border rounded" placeholder="Importance dans la région"></textarea>
                                        <h3 class="font-semibold mt-4">2. Culture & Traditions</h3>
                                        <textarea id="danses-musiques-rites" class="w-full p-2 border rounded" placeholder="Danses, musiques, rites"></textarea>
                                        <textarea id="gastronomie-locale" class="w-full p-2 border rounded" placeholder="Gastronomie locale"></textarea>
                                        <textarea id="fetes-traditionnelles" class="w-full p-2 border rounded" placeholder="Fêtes traditionnelles"></textarea>
                                        <h3 class="font-semibold mt-4">3. Population</h3>
                                        <textarea id="structure-demographique" class="w-full p-2 border rounded" placeholder="Structure démographique"></textarea>
                                        <textarea id="groupes-ethniques" class="w-full p-2 border rounded" placeholder="Groupes ethniques"></textarea>
                                        <h3 class="font-semibold mt-4">4. Économie locale</h3>
                                        <textarea id="activites-generatrices" class="w-full p-2 border rounded" placeholder="Activités génératrices de revenus"></textarea>
                                        <textarea id="produits-terroir" class="w-full p-2 border rounded" placeholder="Produits typiques du terroir"></textarea>
                                        <h3 class="font-semibold mt-4">5. Infrastructures</h3>
                                        <textarea id="infrastructures-scolaires" class="w-full p-2 border rounded" placeholder="Écoles"></textarea>
                                        <textarea id="infrastructures-sante" class="w-full p-2 border rounded" placeholder="Centres de santé"></textarea>
                                        <textarea id="infrastructures-routes" class="w-full p-2 border rounded" placeholder="Routes et transport"></textarea>
                                        <textarea id="acces-electricite-eau" class="w-full p-2 border rounded" placeholder="Accès à l'électricité/eau"></textarea>
                                        <h3 class="font-semibold mt-4">6. Tourisme & Attractions</h3>
                                        <textarea id="sites-naturels" class="w-full p-2 border rounded" placeholder="Sites naturels"></textarea>
                                        <textarea id="sites-culturels" class="w-full p-2 border rounded" placeholder="Sites culturels"></textarea>
                                        <h3 class="font-semibold mt-4">7. Personnalités</h3>
                                        <textarea id="personnalites-originaires" class="w-full p-2 border rounded" placeholder="Personnalités originaires du village"></textarea>
                                        <label class="flex items-center mt-2">
                                            <input type="checkbox" id="is-published" class="mr-2">
                                            Publier cette description (visible au public)
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" id="save-village-btn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Enregistrer le Village</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="poi" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Gestion des Points d'Intérêt</h2>
                        <button id="new-poi-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Nouveau POI</button>
                    </div>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left">Nom</th>
                                <th class="p-2 text-left">Type</th>
                                <th class="p-2 text-left">Village</th>
                                <th class="p-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="poi-table"></tbody>
                    </table>
                </div>

                <div id="poi-form" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="modal-content bg-white p-6 rounded-lg max-w-lg w-full">
                        <h2 id="poi-form-title" class="text-xl font-semibold mb-4">Ajouter un Point d'Intérêt</h2>
                        <button class="close-modal float-right px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Annuler</button>
                        <form>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Nom du POI *</label>
                                <input type="text" id="poi-name" class="w-full p-2 border rounded" required>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Village associé</label>
                                <select id="poi-village-id" class="w-full p-2 border rounded"></select>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Type de POI *</label>
                                <select id="poi-type" class="w-full p-2 border rounded" required></select>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Description</label>
                                <textarea id="poi-description" class="w-full p-2 border rounded"></textarea>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Méthode de positionnement *</label>
                                <select id="poi-geom-method" class="w-full p-2 border rounded" required>
                                    <option value="coords">Coordonnées</option>
                                    <option value="click">Clic sur carte</option>
                                </select>
                            </div>
                            <div id="poi-coords" class="form-group mb-4">
                                <label class="block mb-1 font-medium">Latitude *</label>
                                <input type="number" id="poi-lat" class="w-full p-2 border rounded" step="0.000001">
                                <label class="block mb-1 font-medium mt-2">Longitude *</label>
                                <input type="number" id="poi-lon" class="w-full p-2 border rounded" step="0.000001">
                            </div>
                            <div id="poi-map" class="form-group hidden map-container"></div>
                            <button type="submit" id="save-poi-btn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Enregistrer le POI</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="geonames" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Gestion des Géonymes</h2>
                        <button id="new-geoname-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Nouveau Géonyme</button>
                    </div>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left">Nom</th>
                                <th class="p-2 text-left">Type</th>
                                <th class="p-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="geonames-table"></tbody>
                    </table>
                </div>

                <div id="geoname-form" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="modal-content bg-white p-6 rounded-lg max-w-lg w-full">
                        <h2 id="geoname-form-title" class="text-xl font-semibold mb-4">Ajouter un Géonyme</h2>
                        <button class="close-modal float-right px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Annuler</button>
                        <form>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Nom du géonyme *</label>
                                <input type="text" id="geoname-nom" class="w-full p-2 border rounded" required>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Type *</label>
                                <select id="geoname-type" class="w-full p-2 border rounded" required>
                                    <option value="Montagne">Montagne</option>
                                    <option value="Colline">Colline</option>
                                    <option value="Rivière">Rivière</option>
                                    <option value="Lac">Lac</option>
                                    <option value="Forêt">Forêt</option>
                                    <option value="Plateau">Plateau</option>
                                    <option value="Vallée">Vallée</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Description</label>
                                <textarea id="geoname-description" class="w-full p-2 border rounded"></textarea>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Méthode de positionnement *</label>
                                <select id="geoname-geom-method" class="w-full p-2 border rounded" required>
                                    <option value="coords">Coordonnées</option>
                                    <option value="click">Clic sur carte</option>
                                </select>
                            </div>
                            <div id="geoname-coords" class="form-group mb-4">
                                <label class="block mb-1 font-medium">Latitude *</label>
                                <input type="number" id="geoname-lat" class="w-full p-2 border rounded" step="0.000001">
                                <label class="block mb-1 font-medium mt-2">Longitude *</label>
                                <input type="number" id="geoname-lon" class="w-full p-2 border rounded" step="0.000001">
                            </div>
                            <div id="geoname-map" class="form-group hidden map-container"></div>
                            <button type="submit" id="save-geoname-btn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Enregistrer le Géonyme</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="users" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Gestion des Utilisateurs</h2>
                        <button id="new-user-btn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Nouvel Utilisateur</button>
                    </div>
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-200">
                                <th class="p-2 text-left">Nom</th>
                                <th class="p-2 text-left">Rôle</th>
                                <th class="p-2 text-left">Actif</th>
                                <th class="p-2 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table"></tbody>
                    </table>
                </div>

                <div id="user-form" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                    <div class="modal-content bg-white p-6 rounded-lg max-w-lg w-full">
                        <h2 id="user-form-title" class="text-xl font-semibold mb-4">Ajouter un Utilisateur</h2>
                        <button class="close-modal float-right px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Annuler</button>
                        <form>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Nom complet</label>
                                <input type="text" id="user-full-name" class="w-full p-2 border rounded" required>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Rôle</label>
                                <select id="user-role" class="w-full p-2 border rounded" required>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="form-group mb-4">
                                <label class="block mb-1 font-medium">Actif</label>
                                <input type="checkbox" id="user-active" class="mr-2" checked>
                            </div>
                            <button type="submit" id="save-user-btn" class="mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Enregistrer l'Utilisateur</button>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const supabaseUrl = 'https://hrlufnjhwhgddxkpyzst.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybHVmbmpod2hnZGR4a3B5enN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MzIwMzcsImV4cCI6MjA2ODMwODAzN30.0gMYonFDAU84i3boEIKZDK4OQhDrAXXJySGDa80wTZ8';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        const mapboxToken = 'pk.eyJ1IjoiZWthbnNvbiIsImEiOiJjbWUyeDFxZDUwMTVrMmlvcHMzaDlwOXRvIn0.r7nOAUE0YU8c4miQFeJZWg';

        let currentSection = 'dashboard';
        let editingId = null;
        let map, drawControl, drawnLayer;
        let poiMap, geonameMap;

        async function checkAuth() {
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    window.location.href = 'login.html';
                } else {
                    document.getElementById('admin-name').textContent = user.email || 'Admin connecté';
                }
            } catch (error) {
                console.error('Auth error:', error);
                alert('Erreur d\'authentification');
            }
        }

        function showSection(sectionId) {
            document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.querySelector(`nav a[href="#${sectionId}"]`).classList.add('active');
            currentSection = sectionId;
            loadData();
        }

        function showModal(modalId) {
            console.log(`Showing modal: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                if (modalId === 'village-form' && !map) map = initMap('map');
                if (modalId === 'poi-form' && !poiMap) poiMap = initMap('poi-map', true);
                if (modalId === 'geoname-form' && !geonameMap) geonameMap = initMap('geoname-map', true);
            } else {
                console.error(`Modal ${modalId} not found`);
            }
        }

        function hideModal(modalId) {
            console.log(`Hiding modal: ${modalId}`);
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                resetForm(modalId);
            }
        }

        function resetForm(modalId) {
            const form = document.querySelector(`#${modalId} form`);
            form.reset();
            editingId = null;
            if (modalId === 'village-form') {
                document.getElementById('village-form-title').textContent = 'Ajouter un Village';
                document.getElementById('description-form').classList.add('hidden');
                if (drawnLayer) map.removeLayer(drawnLayer);
                drawnLayer = null;
            } else if (modalId === 'poi-form') {
                document.getElementById('poi-form-title').textContent = 'Ajouter un Point d\'Intérêt';
                if (drawnLayer) poiMap.removeLayer(drawnLayer);
                drawnLayer = null;
            } else if (modalId === 'geoname-form') {
                document.getElementById('geoname-form-title').textContent = 'Ajouter un Géonyme';
                if (drawnLayer) geonameMap.removeLayer(drawnLayer);
                drawnLayer = null;
            } else if (modalId === 'user-form') {
                document.getElementById('user-form-title').textContent = 'Ajouter un Utilisateur';
            }
        }

        async function loadArrondissements() {
            try {
                const { data, error } = await supabase.from('arrondissements').select('id_arrondissement, nom_arrondissement');
                if (error) throw error;
                const select = document.getElementById('arrondissement-id');
                select.innerHTML = '<option value="">Sélectionner...</option>';
                data.forEach(a => {
                    select.innerHTML += `<option value="${a.id_arrondissement}">${a.nom_arrondissement}</option>`;
                });
            } catch (error) {
                console.error('Error loading arrondissements:', error);
            }
        }

        async function loadVillagesForSelect(selectId) {
            try {
                const { data, error } = await supabase.from('villages').select('id, village_name');
                if (error) throw error;
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Aucun village spécifique</option>';
                data.forEach(v => {
                    select.innerHTML += `<option value="${v.id}">${v.village_name}</option>`;
                });
            } catch (error) {
                console.error('Error loading villages for select:', error);
            }
        }

        async function loadPoiTypes() {
            try {
                const { data, error } = await supabase.from('poi_types').select('type, label');
                if (error) throw error;
                const select = document.getElementById('poi-type');
                select.innerHTML = '';
                data.forEach(t => {
                    select.innerHTML += `<option value="${t.type}">${t.label}</option>`;
                });
            } catch (error) {
                console.error('Error loading POI types:', error);
            }
        }

        function initMap(mapId, forPoint = false) {
            const m = L.map(mapId).setView([5.0, 12.0], 6);
            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + mapboxToken, {
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1
            }).addTo(m);

            if (!forPoint) {
                drawControl = new L.Draw.Polygon(m);
            } else {
                drawControl = new L.Draw.Marker(m);
            }

            return m;
        }

        async function loadDashboard() {
            try {
                const [villages, poi, geonames, descriptions] = await Promise.all([
                    supabase.from('villages').select('count', { count: 'exact' }),
                    supabase.from('poi').select('count', { count: 'exact' }),
                    supabase.from('geonames').select('count', { count: 'exact' }),
                    supabase.from('village_descriptions').select('count', { count: 'exact' })
                ]);

                document.getElementById('villages-count').textContent = villages.data.count;
                document.getElementById('poi-count').textContent = poi.data.count;
                document.getElementById('geonames-count').textContent = geonames.data.count;
                document.getElementById('descriptions-count').textContent = descriptions.data.count;
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Erreur lors du chargement du tableau de bord');
            }
        }

        async function loadVillages() {
            try {
                const { data, error } = await supabase.from('villages_complete').select('*');
                if (error) throw error;
                const tbody = document.querySelector('#villages-table');
                tbody.innerHTML = '';
                data.forEach(v => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">${v.village_name}</td>
                            <td class="p-2">${v.arrondissement_name}</td>
                            <td class="p-2">${v.chief_name || '-'}</td>
                            <td class="p-2">${v.population || '-'}</td>
                            <td class="p-2">
                                <button onclick="editVillage('${v.id}')" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Éditer</button>
                                <button onclick="deleteVillage('${v.id}')" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading villages:', error);
                alert('Erreur lors du chargement des villages');
            }
        }

        async function loadPoi() {
            try {
                const { data, error } = await supabase.from('poi_with_location').select('*');
                if (error) throw error;
                const tbody = document.querySelector('#poi-table');
                tbody.innerHTML = '';
                data.forEach(p => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">${p.name}</td>
                            <td class="p-2">${p.type}</td>
                            <td class="p-2">${p.village_name || '-'}</td>
                            <td class="p-2">
                                <button onclick="editPoi('${p.id}')" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Éditer</button>
                                <button onclick="deletePoi('${p.id}')" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading POI:', error);
                alert('Erreur lors du chargement des POI');
            }
        }

        async function loadGeonames() {
            try {
                const { data, error } = await supabase.from('geonames').select('*');
                if (error) throw error;
                const tbody = document.querySelector('#geonames-table');
                tbody.innerHTML = '';
                data.forEach(g => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">${g.nom}</td>
                            <td class="p-2">${g.type}</td>
                            <td class="p-2">
                                <button onclick="editGeoname('${g.id}')" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Éditer</button>
                                <button onclick="deleteGeoname('${g.id}')" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading geonames:', error);
                alert('Erreur lors du chargement des géonymes');
            }
        }

        async function loadUsers() {
            try {
                const { data, error } = await supabase.from('admin_profiles').select('*');
                if (error) throw error;
                const tbody = document.querySelector('#users-table');
                tbody.innerHTML = '';
                data.forEach(u => {
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-2">${u.full_name}</td>
                            <td class="p-2">${u.role}</td>
                            <td class="p-2">${u.is_active ? 'Oui' : 'Non'}</td>
                            <td class="p-2">
                                <button onclick="editUser('${u.id}')" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Éditer</button>
                                <button onclick="deleteUser('${u.id}')" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Supprimer</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Erreur lors du chargement des utilisateurs');
            }
        }

        function loadData() {
            if (currentSection === 'dashboard') loadDashboard();
            else if (currentSection === 'villages') loadVillages();
            else if (currentSection === 'poi') loadPoi();
            else if (currentSection === 'geonames') loadGeonames();
            else if (currentSection === 'users') loadUsers();
        }

        async function saveVillage(e) {
            e.preventDefault();
            try {
                const data = {
                    village_name: document.getElementById('village-name').value,
                    id_arrondissement: document.getElementById('arrondissement-id').value,
                    chief_name: document.getElementById('chief-name').value || null,
                    chief_start_date: document.getElementById('chief-start-date').value || null,
                    email: document.getElementById('village-email').value || null,
                    telephone: document.getElementById('village-telephone').value || null,
                    population: parseInt(document.getElementById('village-population').value) || null,
                    geom: await getGeom()
                };

                const { user } = await supabase.auth.getUser();
                data.created_by = user.id;
                data.updated_by = user.id;

                let error;
                if (editingId) {
                    ({ error } = await supabase.from('villages').update(data).eq('id', editingId));
                } else {
                    ({ error } = await supabase.from('villages').insert(data));
                }
                if (error) throw error;

                const villageId = editingId || (await supabase.from('villages').select('id').eq('village_name', data.village_name).single()).data.id;

                await uploadChiefPhoto(villageId);
                await uploadVillagePhotos(villageId);
                await saveDescription(villageId);

                hideModal('village-form');
                loadVillages();
            } catch (error) {
                console.error('Error saving village:', error);
                alert('Erreur lors de l\'enregistrement du village');
            }
        }

        async function getGeom() {
            const method = document.getElementById('geom-method').value;
            if (method === 'draw') {
                if (!drawnLayer) throw new Error('Aucune géométrie dessinée');
                const geojson = drawnLayer.toGeoJSON();
                return `ST_GeomFromGeoJSON('${JSON.stringify(geojson.geometry)}')`;
            } else {
                const format = document.getElementById('geom-format').value;
                const text = document.getElementById('geom-text').value;
                if (!text) throw new Error('Géométrie requise');
                if (format === 'wkt') return `ST_GeomFromText('${text}')`;
                else return `ST_GeomFromGeoJSON('${text}')`;
            }
        }

        async function uploadChiefPhoto(villageId) {
            const file = document.getElementById('chief-photo').files[0];
            if (!file) return;
            const { data, error } = await supabase.storage.from('village-photos').upload(`${villageId}/chief_${file.name}`, file);
            if (error) throw error;
            const url = supabase.storage.from('village-photos').getPublicUrl(data.path).data.publicUrl;
            await supabase.from('villages').update({ chief_photo_url: url }).eq('id', villageId);
        }

        async function uploadVillagePhotos(villageId) {
            const files = document.getElementById('village-photos').files;
            if (files.length > 2) {
                alert('Maximum 2 photos');
                return;
            }
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const { data, error } = await supabase.storage.from('village-photos').upload(`${villageId}/photo_${i+1}_${file.name}`, file);
                if (error) throw error;
                const url = supabase.storage.from('village-photos').getPublicUrl(data.path).data.publicUrl;
                await supabase.from('village_photos').insert({
                    village_id: villageId,
                    photo_url: url,
                    photo_name: file.name,
                    photo_order: i + 1
                });
            }
        }

        async function saveDescription(villageId) {
            if (document.getElementById('description-form').classList.contains('hidden')) return;
            const data = {
                village_id: villageId,
                histoire_origine: document.getElementById('histoire-origine').value || null,
                description_limites: document.getElementById('description-limites').value || null,
                importance_region: document.getElementById('importance-region').value || null,
                danses_musiques_rites: document.getElementById('danses-musiques-rites').value || null,
                gastronomie_locale: document.getElementById('gastronomie-locale').value || null,
                fetes_traditionnelles: document.getElementById('fetes-traditionnelles').value || null,
                structure_demographique: document.getElementById('structure-demographique').value || null,
                groupes_ethniques: document.getElementById('groupes-ethniques').value || null,
                activites_generatrices: document.getElementById('activites-generatrices').value || null,
                produits_terroir: document.getElementById('produits-terroir').value || null,
                infrastructures_scolaires: document.getElementById('infrastructures-scolaires').value || null,
                infrastructures_sante: document.getElementById('infrastructures-sante').value || null,
                infrastructures_routes: document.getElementById('infrastructures-routes').value || null,
                acces_electricite_eau: document.getElementById('acces-electricite-eau').value || null,
                sites_naturels: document.getElementById('sites-naturels').value || null,
                sites_culturels: document.getElementById('sites-culturels').value || null,
                personnalites_originaires: document.getElementById('personnalites-originaires').value || null,
                is_published: document.getElementById('is-published').checked
            };

            const { user } = await supabase.auth.getUser();
            data.created_by = user.id;

            const existing = await supabase.from('village_descriptions').select('id').eq('village_id', villageId).single();
            if (existing.data) {
                await supabase.from('village_descriptions').update(data).eq('id', existing.data.id);
            } else {
                await supabase.from('village_descriptions').insert(data);
            }
        }

        async function editVillage(id) {
            editingId = id;
            try {
                const { data, error } = await supabase.from('villages_with_full_info').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('village-form-title').textContent = 'Éditer le Village';
                document.getElementById('village-name').value = data.village_name;
                document.getElementById('arrondissement-id').value = data.id_arrondissement;
                document.getElementById('chief-name').value = data.chief_name || '';
                document.getElementById('chief-start-date').value = data.chief_start_date || '';
                document.getElementById('village-email').value = data.email || '';
                document.getElementById('village-telephone').value = data.telephone || '';
                document.getElementById('village-population').value = data.population || '';

                if (data.description_limites) {
                    document.getElementById('description-form').classList.remove('hidden');
                    document.getElementById('histoire-origine').value = data.histoire_origine || '';
                    document.getElementById('description-limites').value = data.description_limites || '';
                    document.getElementById('importance-region').value = data.importance_region || '';
                    document.getElementById('danses-musiques-rites').value = data.danses_musiques_rites || '';
                    document.getElementById('gastronomie-locale').value = data.gastronomie_locale || '';
                    document.getElementById('fetes-traditionnelles').value = data.fetes_traditionnelles || '';
                    document.getElementById('structure-demographique').value = data.structure_demographique || '';
                    document.getElementById('groupes-ethniques').value = data.groupes_ethniques || '';
                    document.getElementById('activites-generatrices').value = data.activites_generatrices || '';
                    document.getElementById('produits-terroir').value = data.produits_terroir || '';
                    document.getElementById('infrastructures-scolaires').value = data.infrastructures_scolaires || '';
                    document.getElementById('infrastructures-sante').value = data.infrastructures_sante || '';
                    document.getElementById('infrastructures-routes').value = data.infrastructures_routes || '';
                    document.getElementById('acces-electricite-eau').value = data.acces_electricite_eau || '';
                    document.getElementById('sites-naturels').value = data.sites_naturels || '';
                    document.getElementById('sites-culturels').value = data.sites_culturels || '';
                    document.getElementById('personnalites-originaires').value = data.personnalites_originaires || '';
                    document.getElementById('is-published').checked = data.description_published;
                }

                const geom = await supabase.rpc('st_asgeojson', { geom: data.geom });
                document.getElementById('geom-method').value = 'upload';
                document.getElementById('geom-format').value = 'geojson';
                document.getElementById('geom-text').value = geom.data || '';

                showModal('village-form');
            } catch (error) {
                console.error('Error editing village:', error);
                alert('Erreur lors du chargement du village');
            }
        }

        async function deleteVillage(id) {
            if (!confirm('Confirmer la suppression?')) return;
            try {
                await supabase.from('villages').delete().eq('id', id);
                loadVillages();
            } catch (error) {
                console.error('Error deleting village:', error);
                alert('Erreur lors de la suppression du village');
            }
        }

        async function savePoi(e) {
            e.preventDefault();
            try {
                const data = {
                    name: document.getElementById('poi-name').value,
                    type: document.getElementById('poi-type').value,
                    description: document.getElementById('poi-description').value || null,
                    village_id: document.getElementById('poi-village-id').value || null,
                    geom: await getPointGeom('poi')
                };

                const { user } = await supabase.auth.getUser();
                data.created_by = user.id;

                let error;
                if (editingId) {
                    ({ error } = await supabase.from('poi').update(data).eq('id', editingId));
                } else {
                    ({ error } = await supabase.from('poi').insert(data));
                }
                if (error) throw error;

                hideModal('poi-form');
                loadPoi();
            } catch (error) {
                console.error('Error saving POI:', error);
                alert('Erreur lors de l\'enregistrement du POI');
            }
        }

        async function getPointGeom(prefix) {
            const method = document.getElementById(`${prefix}-geom-method`).value;
            if (method === 'coords') {
                const lat = document.getElementById(`${prefix}-lat`).value;
                const lon = document.getElementById(`${prefix}-lon`).value;
                if (!lat || !lon) throw new Error('Coordonnées requises');
                return `ST_Point(${lon}, ${lat})`;
            } else {
                if (!drawnLayer) throw new Error('Aucun point sélectionné');
                const geojson = drawnLayer.toGeoJSON();
                return `ST_GeomFromGeoJSON('${JSON.stringify(geojson.geometry)}')`;
            }
        }

        async function editPoi(id) {
            editingId = id;
            try {
                const { data, error } = await supabase.from('poi').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('poi-name').value = data.name;
                document.getElementById('poi-type').value = data.type;
                document.getElementById('poi-description').value = data.description || '';
                document.getElementById('poi-village-id').value = data.village_id || '';

                const point = await supabase.rpc('st_astext', { geom: data.geom });
                const coords = point.data.match(/POINT\((.*) (.*)\)/);
                if (coords) {
                    document.getElementById('poi-geom-method').value = 'coords';
                    document.getElementById('poi-lat').value = coords[2];
                    document.getElementById('poi-lon').value = coords[1];
                }

                showModal('poi-form');
            } catch (error) {
                console.error('Error editing POI:', error);
                alert('Erreur lors du chargement du POI');
            }
        }

        async function deletePoi(id) {
            if (!confirm('Confirmer la suppression?')) return;
            try {
                await supabase.from('poi').delete().eq('id', id);
                loadPoi();
            } catch (error) {
                console.error('Error deleting POI:', error);
                alert('Erreur lors de la suppression du POI');
            }
        }

        async function saveGeoname(e) {
            e.preventDefault();
            try {
                const data = {
                    nom: document.getElementById('geoname-nom').value,
                    type: document.getElementById('geoname-type').value,
                    description: document.getElementById('geoname-description').value || null,
                    geom: await getPointGeom('geoname')
                };

                const { user } = await supabase.auth.getUser();
                data.created_by = user.id;

                let error;
                if (editingId) {
                    ({ error } = await supabase.from('geonames').update(data).eq('id', editingId));
                } else {
                    ({ error } = await supabase.from('geonames').insert(data));
                }
                if (error) throw error;

                hideModal('geoname-form');
                loadGeonames();
            } catch (error) {
                console.error('Error saving geoname:', error);
                alert('Erreur lors de l\'enregistrement du géonyme');
            }
        }

        async function editGeoname(id) {
            editingId = id;
            try {
                const { data, error } = await supabase.from('geonames').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('geoname-nom').value = data.nom;
                document.getElementById('geoname-type').value = data.type;
                document.getElementById('geoname-description').value = data.description || '';

                const point = await supabase.rpc('st_astext', { geom: data.geom });
                const coords = point.data.match(/POINT\((.*) (.*)\)/);
                if (coords) {
                    document.getElementById('geoname-geom-method').value = 'coords';
                    document.getElementById('geoname-lat').value = coords[2];
                    document.getElementById('geoname-lon').value = coords[1];
                }

                showModal('geoname-form');
            } catch (error) {
                console.error('Error editing geoname:', error);
                alert('Erreur lors du chargement du géonyme');
            }
        }

        async function deleteGeoname(id) {
            if (!confirm('Confirmer la suppression?')) return;
            try {
                await supabase.from('geonames').delete().eq('id', id);
                loadGeonames();
            } catch (error) {
                console.error('Error deleting geoname:', error);
                alert('Erreur lors de la suppression du géonyme');
            }
        }

        async function saveUser(e) {
            e.preventDefault();
            try {
                const data = {
                    full_name: document.getElementById('user-full-name').value,
                    role: document.getElementById('user-role').value,
                    is_active: document.getElementById('user-active').checked
                };

                let error;
                if (editingId) {
                    ({ error } = await supabase.from('admin_profiles').update(data).eq('id', editingId));
                } else {
                    ({ error } = await supabase.from('admin_profiles').insert(data));
                }
                if (error) throw error;

                hideModal('user-form');
                loadUsers();
            } catch (error) {
                console.error('Error saving user:', error);
                alert('Erreur lors de l\'enregistrement de l\'utilisateur');
            }
        }

        async function editUser(id) {
            editingId = id;
            try {
                const { data, error } = await supabase.from('admin_profiles').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('user-full-name').value = data.full_name;
                document.getElementById('user-role').value = data.role;
                document.getElementById('user-active').checked = data.is_active;

                showModal('user-form');
            } catch (error) {
                console.error('Error editing user:', error);
                alert('Erreur lors du chargement de l\'utilisateur');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Confirmer la suppression?')) return;
            try {
                await supabase.from('admin_profiles').delete().eq('id', id);
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Erreur lors de la suppression de l\'utilisateur');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await checkAuth();
                await loadArrondissements();
                await loadPoiTypes();
                await loadVillagesForSelect('poi-village-id');
                loadDashboard();

                map = initMap('map');
                poiMap = initMap('poi-map', true);
                geonameMap = initMap('geoname-map', true);

                document.querySelectorAll('nav a').forEach(a => {
                    a.addEventListener('click', e => {
                        e.preventDefault();
                        showSection(a.getAttribute('href').slice(1));
                    });
                });

                document.getElementById('logout-btn').addEventListener('click', async () => {
                    await supabase.auth.signOut();
                    window.location.href = 'login.html';
                });

                document.getElementById('new-village-btn').addEventListener('click', () => {
                    console.log('New village button clicked');
                    showModal('village-form');
                });
                document.getElementById('new-poi-btn').addEventListener('click', () => {
                    console.log('New POI button clicked');
                    showModal('poi-form');
                });
                document.getElementById('new-geoname-btn').addEventListener('click', () => {
                    console.log('New geoname button clicked');
                    showModal('geoname-form');
                });
                document.getElementById('new-user-btn').addEventListener('click', () => {
                    console.log('New user button clicked');
                    showModal('user-form');
                });

                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => hideModal(btn.closest('.modal').id));
                });

                document.querySelector('#village-form form').addEventListener('submit', saveVillage);
                document.querySelector('#poi-form form').addEventListener('submit', savePoi);
                document.querySelector('#geoname-form form').addEventListener('submit', saveGeoname);
                document.querySelector('#user-form form').addEventListener('submit', saveUser);

                document.getElementById('geom-method').addEventListener('change', e => {
                    document.getElementById('geom-upload').classList.toggle('hidden', e.target.value !== 'upload');
                    document.getElementById('geom-draw').classList.toggle('hidden', e.target.value !== 'draw');
                });

                document.getElementById('poi-geom-method').addEventListener('change', e => {
                    document.getElementById('poi-coords').classList.toggle('hidden', e.target.value !== 'coords');
                    document.getElementById('poi-map').classList.toggle('hidden', e.target.value !== 'click');
                });

                document.getElementById('geoname-geom-method').addEventListener('change', e => {
                    document.getElementById('geoname-coords').classList.toggle('hidden', e.target.value !== 'coords');
                    document.getElementById('geoname-map').classList.toggle('hidden', e.target.value !== 'click');
                });

                document.getElementById('start-draw').addEventListener('click', () => drawControl.enable());
                document.getElementById('clear-draw').addEventListener('click', () => {
                    if (drawnLayer) map.removeLayer(drawnLayer);
                    drawnLayer = null;
                });

                map.on('draw:created', e => {
                    if (drawnLayer) map.removeLayer(drawnLayer);
                    drawnLayer = e.layer;
                    map.addLayer(drawnLayer);
                });

                poiMap.on('draw:created', e => {
                    if (drawnLayer) poiMap.removeLayer(drawnLayer);
                    drawnLayer = e.layer;
                    poiMap.addLayer(drawnLayer);
                });

                geonameMap.on('draw:created', e => {
                    if (drawnLayer) geonameMap.removeLayer(drawnLayer);
                    drawnLayer = e.layer;
                    geonameMap.addLayer(drawnLayer);
                });

                document.getElementById('add-description-btn').addEventListener('click', () => {
                    document.getElementById('description-form').classList.remove('hidden');
                });
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Erreur lors de l\'initialisation de la page');
            }
        });
    </script>
</body>
</html>