<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonVillage - Cartographie des Villages du Cameroun</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin="" defer></script>
    
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <!-- Leaflet Draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" defer></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2" defer></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; background: #1a1a1a; color: #333; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        .header { background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; padding: 8px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; position: relative; }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; height: 50px; }
        .logo-section { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .logo { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .app-title { font-size: 20px; font-weight: bold; margin: 0; line-height: 1; }
        .search-container { position: relative; flex: 1; max-width: 450px; margin: 0 20px; }
        .search-input { width: 100%; padding: 8px 35px 8px 12px; border: none; border-radius: 20px; font-size: 13px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); height: 34px; }
        .search-btn { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: #4a7c59; border: none; color: white; padding: 6px 10px; border-radius: 50%; cursor: pointer; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .admin-access { color: rgba(255,255,255,0.9); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 15px; transition: background 0.2s; height: 34px; flex-shrink: 0; }
        .admin-access:hover { background: rgba(255,255,255,0.1); }

        /* Main Content */
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s ease; }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .sidebar { width: 300px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: transform 0.3s ease; z-index: 1000; overflow-y: auto; position: relative; }
        .sidebar.collapsed { transform: translateX(-280px); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e0e0e0; background: #f8f9fa; position: relative; }
        .sidebar-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c5530; }
        .sidebar-close-btn { background: none; border: none; font-size: 18px; color: #666; cursor: pointer; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: none; align-items: center; justify-content: center; transition: all 0.2s; position: absolute; top: 15px; right: 15px; }
        .sidebar-close-btn:hover { background: #e0e0e0; color: #333; }
        .layer-controls { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .layer-control-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .layer-toggle { position: relative; width: 50px; height: 25px; background: #ccc; border-radius: 25px; cursor: pointer; transition: background 0.2s; }
        .layer-toggle.active { background: #4a7c59; }
        .layer-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: white; border-radius: 50%; transition: transform 0.2s; }
        .layer-toggle.active::after { transform: translateX(25px); }
        .legend-section { padding: 15px 20px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .legend-item:hover { background: #f0f0f0; }
        .legend-symbol { width: 20px; height: 20px; margin-right: 10px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .legend-label { font-size: 14px; color: #333; }

        /* Map Container */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .toolbar { position: absolute; top: 70px; right: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 600; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { background: none; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; color: #666; transition: all 0.2s; min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .tool-btn:hover { background: #f0f0f0; color: #333; }
        .tool-btn.active { background: #4a7c59; color: white; }
        .toggle-sidebar { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 18px; cursor: pointer; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 600; color: #4a7c59; transition: all 0.2s ease; }
        .toggle-sidebar:hover { background: rgba(255,255,255,1); transform: scale(1.05); }

        /* Locate Button - Style discret SW Maps */
        .locate-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; width: 32px; height: 32px; font-size: 14px; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.15); z-index: 600; color: #666; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .locate-btn:hover { background: rgba(255,255,255,1); color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .locate-btn.locating { background: #007bff; color: white; animation: pulse-button 1s infinite; }
        .locate-btn.located { background: #007bff; color: white; }

        /* Notification System */
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10000; transform: translateX(400px); transition: transform 0.3s ease; max-width: 350px; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #4CAF50; color: white; }
        .notification.error { background: #F44336; color: white; }
        .notification.warning { background: #FF9800; color: white; }
        .notification.info { background: #2196F3; color: white; }

        /* Print Modal Styles */
        .print-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; backdrop-filter: blur(3px); }
        .print-modal.active { display: flex; align-items: center; justify-content: center; }
        .print-modal-content { background: white; border-radius: 15px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .print-modal-header { padding: 20px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 15px 15px 0 0; }
        .print-modal-title { font-size: 24px; font-weight: bold; color: #2c5530; margin: 0; }
        .print-modal-close { background: none; border: none; font-size: 24px; color: #666; cursor: pointer; padding: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .print-modal-close:hover { background: #e0e0e0; }
        .print-modal-body { padding: 30px; }
        
        .print-config { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .print-options { }
        .print-preview { background: #f8f9fa; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #4a7c59; }
        
        .format-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
        .format-option { border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.2s; background: white; }
        .format-option:hover { border-color: #4a7c59; background: #f0f8f1; }
        .format-option.selected { border-color: #4a7c59; background: #4a7c59; color: white; }
        .format-size { font-weight: bold; margin-bottom: 5px; }
        .format-price { font-size: 12px; opacity: 0.8; }
        
        .scale-input-group { display: flex; align-items: center; gap: 10px; }
        .scale-input { flex: 1; }
        .scale-preset { background: #f0f0f0; border: 1px solid #ccc; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .scale-preset:hover { background: #e0e0e0; }
        
        .preview-container { width: 250px; height: 350px; border: 2px solid #ddd; border-radius: 8px; background: white; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .preview-header { background: #f8f9fa; padding: 8px; text-align: center; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd; }
        .preview-map { width: 100%; height: 250px; background: linear-gradient(45deg, #e8f5e8, #d4e6d4); position: relative; display: flex; align-items: center; justify-content: center; }
        .preview-footer { padding: 8px; background: #f8f9fa; text-align: center; font-size: 10px; border-top: 1px solid #ddd; }
        .preview-north-arrow { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .preview-scale { position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 10px; }
        
        .print-summary { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .summary-label { font-weight: 600; }
        .summary-value { color: #4a7c59; font-weight: bold; }
        .total-price { font-size: 18px; color: #2c5530; }
        
        .print-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 120px; }
        .btn-primary { background: #4a7c59; color: white; }
        .btn-primary:hover { background: #3d6249; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        
        .payment-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10002; }
        .payment-modal.active { display: flex; align-items: center; justify-content: center; }
        .payment-content { background: white; border-radius: 15px; padding: 30px; max-width: 400px; width: 90%; text-align: center; }
        .payment-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #2c5530; }
        .payment-amount { font-size: 24px; color: #4a7c59; font-weight: bold; margin-bottom: 20px; }
        .payment-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4a7c59; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Loading overlay */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .loading-content { background: white; padding: 40px; border-radius: 15px; text-align: center; }

        /* Geolocation styles */
        .user-location-marker { 
            background: #007bff; 
            border: 3px solid white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            animation: pulse-location 2s infinite;
        }
        
        .user-location-accuracy { 
            border: 2px solid rgba(0, 123, 255, 0.3); 
            background: rgba(0, 123, 255, 0.1); 
        }

        @keyframes pulse-location {
            0% { box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 123, 255, 0.8); }
            100% { box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
        }

        .tool-btn.locating {
            background: #007bff !important;
            color: white !important;
            animation: pulse-button 1s infinite;
        }

        @keyframes pulse-button {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Measurement styles */
        .measurement-tooltip { background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 5px; font-size: 13px; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* Footer */
        .footer { background: #2c5530; color: white; padding: 15px 20px; text-align: center; font-size: 14px; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .contact-info { display: flex; gap: 20px; align-items: center; }
        .contact-item { display: flex; align-items: center; gap: 5px; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content { flex-direction: row; gap: 8px; padding: 4px 8px; height: 45px; justify-content: space-between; }
            .logo { width: 28px; height: 28px; font-size: 12px; }
            .app-title { font-size: 14px; }
            .search-container { flex: 1; margin: 0 10px; }
            .search-input { height: 32px; font-size: 12px; padding: 6px 30px 6px 10px; }
            .search-btn { width: 24px; height: 24px; font-size: 11px; }
            .admin-access { font-size: 11px; height: 32px; padding: 6px 8px; gap: 4px; }
            .admin-access span { display: none; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); }
            .sidebar-close-btn { display: flex !important; }
            .sidebar-header { padding-top: 25px; }
            .toolbar { flex-direction: row; top: auto; bottom: 20px; right: 30px; left: 30px; justify-content: center; max-width: calc(100% - 80px); }
            .footer-content { flex-direction: column; gap: 10px; text-align: center; }
            .contact-info { flex-direction: column; gap: 10px; }
            .print-config { grid-template-columns: 1fr; gap: 20px; }
            .format-grid { grid-template-columns: repeat(3, 1fr); }
            /* Locate button mobile - reste visible */
            .locate-btn { top: 15px; right: 15px; width: 36px; height: 36px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo"><i class="fas fa-map-marked-alt"></i></div>
                    <h1 class="app-title">MonVillage</h1>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Rechercher un village..." id="searchInput">
                    <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="admin-access" onclick="checkAdminAccess()">
                    <i class="fas fa-cog"></i>
                    <span>Admin</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="sidebar-close-btn" id="closeSidebar"><i class="fas fa-times"></i></button>
                    <div><h3 class="sidebar-title">Légende</h3><p>Couches cartographiques</p></div>
                </div>
                <div class="layer-controls">
                    <div class="layer-control-item"><span>Régions</span><div class="layer-toggle active" data-layer="regions"></div></div>
                    <div class="layer-control-item"><span>Départements</span><div class="layer-toggle active" data-layer="departements"></div></div>
                    <div class="layer-control-item"><span>Arrondissements</span><div class="layer-toggle active" data-layer="arrondissements"></div></div>
                    <div class="layer-control-item"><span>Villages</span><div class="layer-toggle active" data-layer="villages"></div></div>
                    <div class="layer-control-item"><span>Points d'intérêt</span><div class="layer-toggle active" data-layer="poi"></div></div>
                    <div class="layer-control-item"><span>Géonymes</span><div class="layer-toggle active" data-layer="geonames"></div></div>
                </div>
                <div class="legend-section">
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 3px solid #d62728;"></div><span class="legend-label">Régions</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px solid #000000;"></div><span class="legend-label">Départements</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px dashed #8B008B;"></div><span class="legend-label">Arrondissements</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: rgba(74, 124, 89, 0.3); border: 2px solid #4a7c59;"></div><span class="legend-label">Villages</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FFD700;"><i class="fas fa-crown" style="font-size: 10px; color: #333;"></i></div><span class="legend-label">Chefferie 1er degré</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FFA500;"><i class="fas fa-crown" style="font-size: 10px; color: #333;"></i></div><span class="legend-label">Chefferie 2ème degré</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FF6347;"><i class="fas fa-crown" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Chefferie 3ème degré</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #4CAF50;"><i class="fas fa-school" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Écoles</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #F44336;"><i class="fas fa-hospital" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Centres de santé</span></div>
                </div>
            </aside>

            <!-- Map Container -->
            <div class="map-container">
                <button class="toggle-sidebar" id="toggleSidebar"><i class="fas fa-bars"></i></button>
                <div class="toolbar">
                    <button class="tool-btn" id="measureDistance" title="Mesurer une distance"><i class="fas fa-ruler"></i></button>
                    <button class="tool-btn" id="measureArea" title="Mesurer une surface"><i class="fas fa-draw-polygon"></i></button>
                    <button class="tool-btn" id="clearMeasurements" title="Effacer les mesures"><i class="fas fa-eraser"></i></button>
                    <button class="tool-btn" id="printMap" title="Imprimer la carte"><i class="fas fa-print"></i></button>
                    <button class="tool-btn" id="zoomHome" title="Vue d'ensemble"><i class="fas fa-home"></i></button>
                    <button class="tool-btn" id="toggleSatellite" title="Vue satellite"><i class="fas fa-satellite"></i></button>
                </div>
                <button class="locate-btn" id="locateUser" title="Ma position"><i class="fas fa-crosshairs"></i></button>
                <div id="map"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="contact-info">
                    <div class="contact-item"><i class="fas fa-envelope"></i><span>monvillage.cm@gmail.com</span></div>
                    <div class="contact-item"><i class="fas fa-phone"></i><span>+237 697 182 925</span></div>
                </div>
                <div>© 2024 MonVillage - Cartographie des Villages du Cameroun</div>
            </div>
        </footer>

        <!-- Print Modal -->
        <div id="printModal" class="print-modal">
            <div class="print-modal-content">
                <div class="print-modal-header">
                    <h2 class="print-modal-title"><i class="fas fa-print"></i> Exporter la Carte</h2>
                    <button class="print-modal-close" id="closePrintModal"><i class="fas fa-times"></i></button>
                </div>
                <div class="print-modal-body">
                    <div class="print-config">
                        <div class="print-options">
                            <div class="form-group">
                                <label class="form-label">Titre de la carte</label>
                                <input type="text" class="form-input" id="mapTitle" placeholder="Carte des Villages - MonVillage" value="Carte des Villages - MonVillage">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Format de sortie</label>
                                <select class="form-select" id="outputFormat">
                                    <option value="pdf">PDF (recommandé)</option>
                                    <option value="png">PNG (image)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Taille du papier</label>
                                <div class="format-grid">
                                    <div class="format-option" data-format="A4" data-price="500">
                                        <div class="format-size">A4</div>
                                        <div class="format-price">500 XAF</div>
                                    </div>
                                    <div class="format-option" data-format="A3" data-price="1000">
                                        <div class="format-size">A3</div>
                                        <div class="format-price">1000 XAF</div>
                                    </div>
                                    <div class="format-option selected" data-format="A2" data-price="2000">
                                        <div class="format-size">A2</div>
                                        <div class="format-price">2000 XAF</div>
                                    </div>
                                    <div class="format-option" data-format="A1" data-price="4000">
                                        <div class="format-size">A1</div>
                                        <div class="format-price">4000 XAF</div>
                                    </div>
                                    <div class="format-option" data-format="A0" data-price="6000">
                                        <div class="format-size">A0</div>
                                        <div class="format-price">6000 XAF</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Échelle numérique</label>
                                <div class="scale-input-group">
                                    <span>1:</span>
                                    <input type="number" class="form-input scale-input" id="mapScale" value="50000" min="1000" max="10000000">
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                    <span class="scale-preset" data-scale="25000">1:25,000</span>
                                    <span class="scale-preset" data-scale="50000">1:50,000</span>
                                    <span class="scale-preset" data-scale="100000">1:100,000</span>
                                    <span class="scale-preset" data-scale="250000">1:250,000</span>
                                    <span class="scale-preset" data-scale="500000">1:500,000</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Options d'affichage</label>
                                <label><input type="checkbox" id="showNorthArrow" checked> Flèche Nord</label><br>
                                <label><input type="checkbox" id="showScale" checked> Échelle graphique</label><br>
                                <label><input type="checkbox" id="showLegend" checked> Légende</label><br>
                                <label><input type="checkbox" id="showCoordinates" checked> Coordonnées</label>
                            </div>
                        </div>
                        
                        <div class="print-preview">
                            <h4 style="margin-bottom: 15px; color: #2c5530;">Aperçu</h4>
                            <div class="preview-container" id="previewContainer">
                                <div class="preview-header" id="previewTitle">Carte des Villages - MonVillage</div>
                                <div class="preview-map">
                                    <div class="preview-north-arrow" id="previewNorthArrow">⬆</div>
                                    <div class="preview-scale" id="previewScale">1:50,000</div>
                                    <div style="color: #666; font-size: 12px;">Aperçu de la carte</div>
                                </div>
                                <div class="preview-footer">
                                    Format: <span id="previewFormat">A2</span> | 
                                    <span id="previewDate"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-summary">
                        <div class="summary-row">
                            <span class="summary-label">Format sélectionné:</span>
                            <span class="summary-value" id="summaryFormat">A2</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Type de fichier:</span>
                            <span class="summary-value" id="summaryFileType">PDF</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Échelle:</span>
                            <span class="summary-value" id="summaryScale">1:50,000</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label total-price">Prix total:</span>
                            <span class="summary-value total-price" id="summaryPrice">2,000 XAF</span>
                        </div>
                    </div>
                    
                    <div class="print-actions">
                        <button class="btn btn-secondary" id="cancelPrint">Annuler</button>
                        <button class="btn btn-primary" id="proceedToPay">Payer et Exporter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Modal -->
        <div id="paymentModal" class="payment-modal">
            <div class="payment-content">
                <h3 class="payment-title">Paiement sécurisé</h3>
                <div class="payment-amount" id="paymentAmount">2,000 XAF</div>
                <div class="payment-info">
                    <strong>Détails de l'exportation:</strong><br>
                    <span id="paymentDetails">Format A2 - PDF</span>
                </div>
                <div id="paymentSpinner" class="spinner" style="display: none;"></div>
                <div id="paymentStatus"></div>
                <div class="print-actions">
                    <button class="btn btn-secondary" id="cancelPayment">Annuler</button>
                    <button class="btn btn-primary" id="confirmPayment">Payer maintenant</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3>Génération de votre carte...</h3>
                <p>Veuillez patienter pendant que nous préparons votre exportation.</p>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification" class="notification"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    
    <script>
        console.log('🚀 MonVillage - Initialisation complète avec système d\'impression');
        
        // =================================================================
        // GÉOLOCALISATION
        // =================================================================

        function locateUser() {
            console.log('📍 Demande de géolocalisation utilisateur');
            
            const button = document.getElementById('locateUser');
            
            if (isLocating) {
                // Arrêter la localisation en cours
                stopLocationTracking();
                return;
            }

            // Si déjà localisé, désactiver la localisation
            if (userLocationMarker && !isLocating) {
                clearUserLocation();
                showNotification('Localisation désactivée', 'info', 2000);
                return;
            }

            if (!navigator.geolocation) {
                showNotification('Géolocalisation non supportée par ce navigateur', 'error');
                return;
            }

            // Commencer la localisation
            isLocating = true;
            button.classList.add('locating');
            showNotification('Recherche de votre position...', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                onLocationSuccess,
                onLocationError,
                options
            );
        }

        function onLocationSuccess(position) {
            console.log('✅ Position trouvée:', position.coords);
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            // Supprimer les marqueurs précédents
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            if (userLocationAccuracy) {
                map.removeLayer(userLocationAccuracy);
            }

            // Ajouter le cercle de précision
            userLocationAccuracy = L.circle([lat, lng], {
                radius: accuracy,
                className: 'user-location-accuracy'
            }).addTo(map);

            // Créer l'icône de position personnalisée
            const locationIcon = L.divIcon({
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // Ajouter le marqueur de position
            userLocationMarker = L.marker([lat, lng], {
                icon: locationIcon
            }).addTo(map);

            // Popup avec informations de position
            userLocationMarker.bindPopup(`
                <div style="font-family: inherit; text-align: center;">
                    <h4 style="color: #007bff; margin-bottom: 8px;">
                        <i class="fas fa-crosshairs"></i> Votre Position
                    </h4>
                    <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
                    <p><strong>Longitude:</strong> ${lng.toFixed(6)}</p>
                    <p><strong>Précision:</strong> ±${Math.round(accuracy)}m</p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString('fr-FR')}
                    </p>
                </div>
            `);

            // Centrer la carte sur la position
            map.setView([lat, lng], Math.max(map.getZoom(), 15));

            // Mettre le bouton en état "localisé"
            const button = document.getElementById('locateUser');
            button.classList.remove('locating');
            button.classList.add('located');
            isLocating = false;
            
            showNotification(`Position trouvée avec précision de ±${Math.round(accuracy)}m`, 'success');
            
            // Ouvrir automatiquement le popup
            setTimeout(() => {
                userLocationMarker.openPopup();
            }, 500);
        }

        function onLocationError(error) {
            console.error('❌ Erreur de géolocalisation:', error);
            
            let message = 'Impossible de déterminer votre position';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Autorisation de géolocalisation refusée';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Position non disponible';
                    break;
                case error.TIMEOUT:
                    message = 'Délai de géolocalisation dépassé';
                    break;
            }
            
            showNotification(message, 'error');
            stopLocationTracking();
        }

        function stopLocationTracking() {
            isLocating = false;
            const button = document.getElementById('locateUser');
            button.classList.remove('locating');
            // Ne pas supprimer la classe 'located' pour garder l'indicateur visuel
        }

        function clearUserLocation() {
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            if (userLocationAccuracy) {
                map.removeLayer(userLocationAccuracy);
                userLocationAccuracy = null;
            }
            
            // Remettre le bouton à l'état normal
            const button = document.getElementById('locateUser');
            button.classList.remove('locating', 'located');
            isLocating = false;
        }
        // CONFIGURATION ET VARIABLES GLOBALES
        // =================================================================
        
        // Configuration
        const CONFIG = {
            supabase: {
                url: 'https://your-project.supabase.co',
                anonKey: 'your-anon-key-here'
            },
            mapbox: {
                accessToken: 'pk.your-mapbox-token-here'
            },
            flutterwave: {
                publicKey: 'FLWPUBK-your-key-here'
            },
            adminCredentials: {
                email: 'admin@monvillage.cm',
                password: 'admin123'
            },
            map: { center: [4.1485, 9.504], zoom: 7 },
            print: {
                formats: {
                    A4: { price: 500, width: 210, height: 297 },
                    A3: { price: 1000, width: 297, height: 420 },
                    A2: { price: 2000, width: 420, height: 594 },
                    A1: { price: 4000, width: 594, height: 841 },
                    A0: { price: 6000, width: 841, height: 1189 }
                }
            }
        };

        // Vérification de l'environnement
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        
        // Configuration spécifique à la production
        if (isProduction) {
            console.log('🚀 Mode production détecté');
            // Désactiver les logs de debug en production
            const originalLog = console.log;
            console.log = (...args) => {
                if (args[0] && args[0].includes('🐛')) return;
                originalLog.apply(console, args);
            };
        }

        let map, supabase;
        let mapLayers = { regions: null, departements: null, arrondissements: null, villages: null, poi: null, geonames: null };
        let baseLayers = { standard: null, satellite: null };
        let currentBaseLayer = 'standard';
        
        let measurementLayer;
        let isDistanceMeasuring = false;
        let isAreaMeasuring = false;
        let distanceMarkers = [];
        let measurementLines = [];
        let measurementPolygons = [];
        let polygonPoints = [];
        let tempPolygon = null;

        // Variables pour l'impression
        let printConfig = {
            title: 'Carte des Villages - MonVillage',
            format: 'A2',
            scale: 50000,
            outputFormat: 'pdf',
            showNorthArrow: true,
            showScale: true,
            showLegend: true,
            showCoordinates: true,
            price: 2000
        };

        // Variables pour la géolocalisation
        let userLocationMarker = null;
        let userLocationAccuracy = null;
        let isLocating = false;

        // =================================================================
        // FONCTIONS UTILITAIRES (existantes)
        // =================================================================

        function parseGeometry(geom) {
            if (!geom) return null;
            try {
                return typeof geom === 'object' ? geom : JSON.parse(geom);
            } catch (error) {
                console.error('Erreur parsing géométrie:', error);
                return null;
            }
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function calculateDistance(latlng1, latlng2) {
            const R = 6371000;
            const lat1 = latlng1.lat * Math.PI / 180;
            const lat2 = latlng2.lat * Math.PI / 180;
            const deltaLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
            const deltaLng = (latlng2.lng - latlng1.lng) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function calculatePolygonArea(latlngs) {
            if (latlngs.length < 3) return 0;
            
            const R = 6371000;
            let area = 0;
            const n = latlngs.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                const lat1 = latlngs[i].lat * Math.PI / 180;
                const lat2 = latlngs[j].lat * Math.PI / 180;
                const deltaLng = (latlngs[j].lng - latlngs[i].lng) * Math.PI / 180;
                
                area += deltaLng * (2 + Math.sin(lat1) + Math.sin(lat2));
            }
            
            area = Math.abs(area) * R * R / 2;
            return area;
        }

        function calculateAreaFromGeometry(geometry) {
            if (!geometry || !geometry.coordinates) {
                console.log('Géométrie invalide pour calcul superficie');
                return 'Non calculé';
            }
            
            try {
                console.log('Calcul superficie pour géométrie:', geometry.type);
                
                let coordinates;
                if (geometry.type === 'Polygon') {
                    coordinates = geometry.coordinates[0];
                } else if (geometry.type === 'MultiPolygon') {
                    let totalArea = 0;
                    geometry.coordinates.forEach(polygon => {
                        const polygonCoords = polygon[0].map(coord => ({lat: coord[1], lng: coord[0]}));
                        totalArea += calculatePolygonArea(polygonCoords);
                    });
                    console.log('Superficie MultiPolygon calculée:', totalArea);
                    return totalArea;
                }
                
                if (coordinates && coordinates.length > 3) {
                    const latlngs = coordinates.map(coord => ({lat: coord[1], lng: coord[0]}));
                    const area = calculatePolygonArea(latlngs);
                    console.log('Superficie Polygon calculée:', area);
                    return area;
                }
                
                console.log('Coordonnées insuffisantes pour calcul');
                return 0;
            } catch (error) {
                console.error('Erreur calcul superficie:', error);
                return 'Erreur calcul';
            }
        }

        function formatDistance(distance) {
            if (distance < 1000) {
                return `${Math.round(distance)} m`;
            } else {
                return `${(distance / 1000).toFixed(2)} km`;
            }
        }

        function formatArea(area) {
            if (area < 1000) {
                return `${Math.round(area)} m²`;
            } else if (area < 10000) {
                return `${(area / 1000).toFixed(2)} k m²`;
            } else if (area < 1000000) {
                const hectares = area / 10000;
                return `${hectares.toFixed(2)} ha`;
            } else {
                const km2 = area / 1000000;
                if (km2 < 10) {
                    return `${km2.toFixed(3)} km²`;
                } else if (km2 < 1000) {
                    return `${km2.toFixed(2)} km²`;
                } else {
                    return `${Math.round(km2).toLocaleString()} km²`;
                }
            }
        }

        // =================================================================
        // FONCTIONS D'IMPRESSION - NOUVELLES
        // =================================================================

        function openPrintModal() {
            console.log('🖨️ Ouverture du modal d\'impression');
            
            const modal = document.getElementById('printModal');
            modal.classList.add('active');
            
            // Mettre à jour la date dans l'aperçu
            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('fr-FR');
            
            // Initialiser l'aperçu
            updatePrintPreview();
            
            showNotification('Configurez vos options d\'impression', 'info');
        }

        function closePrintModal() {
            const modal = document.getElementById('printModal');
            modal.classList.remove('active');
        }

        function updatePrintPreview() {
            // Mise à jour du titre
            const title = document.getElementById('mapTitle').value || 'Carte des Villages - MonVillage';
            document.getElementById('previewTitle').textContent = title;
            printConfig.title = title;
            
            // Mise à jour de l'échelle
            const scale = document.getElementById('mapScale').value || 50000;
            document.getElementById('previewScale').textContent = `1:${parseInt(scale).toLocaleString()}`;
            printConfig.scale = parseInt(scale);
            
            // Mise à jour du format
            document.getElementById('previewFormat').textContent = printConfig.format;
            
            // Mise à jour des éléments d'affichage
            const northArrow = document.getElementById('previewNorthArrow');
            const scaleElement = document.getElementById('previewScale');
            
            northArrow.style.display = document.getElementById('showNorthArrow').checked ? 'flex' : 'none';
            scaleElement.style.display = document.getElementById('showScale').checked ? 'block' : 'none';
            
            // Mise à jour du résumé
            document.getElementById('summaryFormat').textContent = printConfig.format;
            document.getElementById('summaryFileType').textContent = document.getElementById('outputFormat').value.toUpperCase();
            document.getElementById('summaryScale').textContent = `1:${parseInt(scale).toLocaleString()}`;
            document.getElementById('summaryPrice').textContent = `${printConfig.price.toLocaleString()} XAF`;
            
            console.log('✅ Aperçu mis à jour:', printConfig);
        }

        function selectFormat(format, price) {
            // Désélectionner tous les formats
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Sélectionner le nouveau format
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');
            
            printConfig.format = format;
            printConfig.price = price;
            
            updatePrintPreview();
            
            console.log(`📄 Format sélectionné: ${format} - ${price} XAF`);
        }

        function setScale(scale) {
            document.getElementById('mapScale').value = scale;
            updatePrintPreview();
        }

        async function proceedToPayment() {
            console.log('💳 Début du processus de paiement');
            
            // Collecter les informations finales
            printConfig.title = document.getElementById('mapTitle').value;
            printConfig.outputFormat = document.getElementById('outputFormat').value;
            printConfig.showNorthArrow = document.getElementById('showNorthArrow').checked;
            printConfig.showScale = document.getElementById('showScale').checked;
            printConfig.showLegend = document.getElementById('showLegend').checked;
            printConfig.showCoordinates = document.getElementById('showCoordinates').checked;
            
            // Ouvrir le modal de paiement
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.add('active');
            
            // Mettre à jour les détails du paiement
            document.getElementById('paymentAmount').textContent = `${printConfig.price.toLocaleString()} XAF`;
            document.getElementById('paymentDetails').textContent = 
                `Format ${printConfig.format} - ${printConfig.outputFormat.toUpperCase()}`;
            
            // Fermer le modal d'impression
            closePrintModal();
        }

        function cancelPayment() {
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.remove('active');
            
            // Rouvrir le modal d'impression
            openPrintModal();
        }

        async function processPayment() {
            console.log('🔄 Traitement du paiement Flutterwave');
            
            try {
                // Afficher le spinner
                document.getElementById('paymentSpinner').style.display = 'block';
                document.getElementById('confirmPayment').disabled = true;
                
                // Générer un ID de transaction unique
                const txRef = `PRINT_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Configuration Flutterwave
                FlutterwaveCheckout({
                    public_key: CONFIG.flutterwave.publicKey,
                    tx_ref: txRef,
                    amount: printConfig.price,
                    currency: "XAF",
                    payment_options: "card, mobilemoney, ussd",
                    customer: {
                        email: "client@monvillage.cm",
                        phone_number: "+237000000000",
                        name: "Client MonVillage"
                    },
                    customizations: {
                        title: "MonVillage - Exportation de Carte",
                        description: `Exportation ${printConfig.format} - ${printConfig.outputFormat.toUpperCase()}`,
                        logo: "https://via.placeholder.com/150x50?text=MonVillage"
                    },
                    callback: function(data) {
                        console.log('✅ Paiement réussi:', data);
                        handlePaymentSuccess(data, txRef);
                    },
                    onclose: function() {
                        console.log('❌ Paiement fermé par l\'utilisateur');
                        handlePaymentCancel();
                    }
                });
                
            } catch (error) {
                console.error('❌ Erreur lors du paiement:', error);
                showNotification('Erreur lors du traitement du paiement', 'error');
                
                document.getElementById('paymentSpinner').style.display = 'none';
                document.getElementById('confirmPayment').disabled = false;
            }
        }

        async function handlePaymentSuccess(paymentData, txRef) {
            console.log('🎉 Paiement confirmé, génération de la carte');
            
            try {
                // Enregistrer le paiement dans la base de données
                if (supabase) {
                    const { error } = await supabase.from('payments').insert({
                        transaction_id: txRef,
                        amount: printConfig.price,
                        currency: 'XAF',
                        status: 'success',
                        payment_method: 'flutterwave',
                        flutterwave_tx_ref: txRef,
                        flutterwave_tx_id: paymentData.transaction_id,
                        print_format: printConfig.format,
                        print_title: printConfig.title,
                        map_bounds: JSON.stringify(map.getBounds())
                    });
                    
                    if (error) {
                        console.error('Erreur enregistrement paiement:', error);
                    } else {
                        console.log('✅ Paiement enregistré en base');
                    }
                }
                
                // Fermer le modal de paiement
                document.getElementById('paymentModal').classList.remove('active');
                
                // Démarrer la génération
                await generateMapExport();
                
            } catch (error) {
                console.error('Erreur post-paiement:', error);
                showNotification('Paiement réussi mais erreur lors de la génération', 'warning');
            }
        }

        function handlePaymentCancel() {
            console.log('❌ Paiement annulé');
            
            document.getElementById('paymentSpinner').style.display = 'none';
            document.getElementById('confirmPayment').disabled = false;
            
            showNotification('Paiement annulé', 'warning');
        }

        async function generateMapExport() {
            console.log('🗺️ Génération de l\'exportation en cours...');
            
            // Afficher l'overlay de chargement
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            try {
                // Simuler la génération (en production, ceci appellerait une API de génération)
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                // Récupérer la vue actuelle de la carte
                const bounds = map.getBounds();
                const center = map.getCenter();
                const zoom = map.getZoom();
                
                // Créer les métadonnées d'exportation
                const exportData = {
                    config: printConfig,
                    mapView: {
                        center: [center.lat, center.lng],
                        bounds: [
                            [bounds.getSouth(), bounds.getWest()],
                            [bounds.getNorth(), bounds.getEast()]
                        ],
                        zoom: zoom
                    },
                    layers: getActiveLayers(),
                    timestamp: new Date().toISOString()
                };
                
                console.log('📊 Données d\'exportation:', exportData);
                
                // Simuler la génération du fichier
                const fileName = generateFileName();
                
                // En production, ici on appellerait l'API de génération
                // const response = await generateMapFile(exportData);
                
                // Pour la démo, on simule un téléchargement
                simulateFileDownload(fileName);
                
                loadingOverlay.classList.remove('active');
                showNotification(`Exportation réussie: ${fileName}`, 'success', 6000);
                
            } catch (error) {
                console.error('❌ Erreur lors de la génération:', error);
                loadingOverlay.classList.remove('active');
                showNotification('Erreur lors de la génération de la carte', 'error');
            }
        }

        function getActiveLayers() {
            const activeLayers = [];
            
            document.querySelectorAll('.layer-toggle.active').forEach(toggle => {
                activeLayers.push(toggle.dataset.layer);
            });
            
            return activeLayers;
        }

        function generateFileName() {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const title = printConfig.title.replace(/[^a-zA-Z0-9]/g, '_');
            
            return `${title}_${printConfig.format}_${timestamp}.${printConfig.outputFormat}`;
        }

        function simulateFileDownload(fileName) {
            // Créer un lien de téléchargement simulé
            const link = document.createElement('a');
            link.href = '#';
            link.download = fileName;
            
            // Simuler le clic sur le lien
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`📥 Téléchargement simulé: ${fileName}`);
        }

        // =================================================================
        // FONCTIONS D'INITIALISATION (existantes)
        // =================================================================

        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                console.log('✅ Supabase initialisé');
            } catch (error) {
                console.error('❌ Erreur Supabase:', error);
                showNotification('Mode hors ligne - données démo', 'warning');
            }
        }

        // Initialisation de la carte
        function initMap() {
            try {
                console.log('🗺️ Initialisation de la carte...');
                
                // Vérifier que Leaflet est chargé
                if (typeof L === 'undefined') {
                    console.error('❌ Leaflet non chargé');
                    setTimeout(initMap, 1000);
                    return;
                }
                
                map = L.map('map', {
                    center: [7.3697, 12.3547],
                    zoom: 6,
                    zoomControl: false,
                    renderer: L.canvas(),
                    preferCanvas: true,
                    attributionControl: true
                });

                console.log('✅ Carte créée');

                // Contrôles de zoom personnalisés
                L.control.zoom({
                    position: 'topright'
                }).addTo(map);

                // Couches de base avec fallback
                let baseLayer;
                
                if (CONFIG.mapbox.accessToken && CONFIG.mapbox.accessToken !== 'pk.your-mapbox-token-here') {
                    console.log('🗺️ Chargement Mapbox...');
                    baseLayer = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${CONFIG.mapbox.accessToken}`, {
                        attribution: '© Mapbox © OpenStreetMap',
                        tileSize: 512,
                        zoomOffset: -1,
                        crossOrigin: true,
                        maxZoom: 18
                    });
                } else {
                    console.log('🗺️ Fallback OpenStreetMap...');
                    baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors',
                        maxZoom: 18,
                        crossOrigin: true
                    });
                }

                baseLayer.addTo(map);
                
                // Attendre que la carte soit prête
                map.whenReady(() => {
                    console.log('✅ Carte prête');
                    setTimeout(() => {
                        map.invalidateSize();
                        console.log('✅ Taille de carte invalidée');
                    }, 100);
                });

                // Initialiser les couches
                initLayers();

                console.log('✅ Carte initialisée');
            } catch (error) {
                console.error('❌ Erreur initialisation carte:', error);
                showNotification('Erreur de chargement de la carte', 'error');
                
                // Retry après délai
                setTimeout(() => {
                    console.log('🔄 Nouvelle tentative d\'initialisation...');
                    initMap();
                }, 2000);
            }
        }

        function initializeNativeMeasurementTools() {
            console.log('📏 Initialisation des outils de mesure natifs');
            
            measurementLayer = new L.FeatureGroup();
            map.addLayer(measurementLayer);
            
            console.log('✅ Outils de mesure prêts');
        }

        // =================================================================
        // CHARGEMENT DES DONNÉES ULTRA-OPTIMISÉ
        // =================================================================

        // Chargement des données initiales
        async function loadInitialData() {
            try {
                console.log('📊 Chargement des données...');
                
                // Vérifier la configuration Supabase
                if (!CONFIG.supabase.url || CONFIG.supabase.url === 'https://your-project.supabase.co') {
                    console.warn('⚠️ Supabase non configuré, mode démo activé');
                    loadDemoData();
                    return;
                }

                // Test de connectivité Supabase
                try {
                    const healthCheck = await fetch(`${CONFIG.supabase.url}/rest/v1/`, {
                        method: 'HEAD',
                        headers: {
                            'apikey': CONFIG.supabase.anonKey,
                            'Authorization': `Bearer ${CONFIG.supabase.anonKey}`
                        }
                    });
                    
                    if (!healthCheck.ok) {
                        throw new Error('Supabase non accessible');
                    }
                    console.log('✅ Supabase accessible');
                } catch (error) {
                    console.warn('⚠️ Supabase inaccessible:', error.message);
                    loadDemoData();
                    return;
                }

                // Charger les données depuis Supabase
                await Promise.all([
                    loadRegions(),
                    loadDepartements(),
                    loadArrondissements(),
                    loadVillages()
                ]);

                console.log('✅ Données chargées');
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                console.log('🔄 Basculement vers les données de démonstration...');
                loadDemoData();
            }
        }

        // Données de démonstration
        function loadDemoData() {
            console.log('🎭 Chargement des données de démonstration...');
            
            // Villages de démonstration
            const demoVillages = [
                {
                    id: 'demo-1',
                    village_name: 'Yaoundé Centre',
                    chief_name: 'Chef Démo',
                    population: 50000,
                    centroid: { coordinates: [11.5174, 3.8480] }
                },
                {
                    id: 'demo-2', 
                    village_name: 'Douala Akwa',
                    chief_name: 'Chef Démo 2',
                    population: 75000,
                    centroid: { coordinates: [9.7043, 4.0511] }
                }
            ];
            
            // Ajouter les marqueurs de démonstration
            demoVillages.forEach(village => {
                if (village.centroid && village.centroid.coordinates) {
                    const [lng, lat] = village.centroid.coordinates;
                    const marker = L.marker([lat, lng]).addTo(villagesLayer);
                    marker.bindPopup(`
                        <div class="popup-content">
                            <h3>${village.village_name}</h3>
                            <p><strong>Chef:</strong> ${village.chief_name}</p>
                            <p><strong>Population:</strong> ${village.population?.toLocaleString() || 'N/A'}</p>
                            <p><em>Données de démonstration</em></p>
                        </div>
                    `);
                }
            });
            
            showNotification('Mode démonstration activé', 'info');
            console.log('✅ Données de démonstration chargées');
        }

        async function loadRegionsOptimized() {
            try {
                // Chargement complet sans limite
                const { data, error } = await supabase
                    .from('regions')
                    .select('id_region, nom_region, geom');
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.regions = L.layerGroup();
                
                data.forEach(region => {
                    if (region.geom) {
                        const geometry = parseGeometry(region.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#d62728', 
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0 
                            },
                            interactive: true
                        }).addTo(mapLayers.regions);

                        // Calcul immédiat de la superficie
                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #d62728; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${region.nom_region}
                                </h4>
                                <p><strong>Type:</strong> Région</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function(e) {
                            if (!isDistanceMeasuring && !isAreaMeasuring) {
                                layer.openPopup();
                            }
                        });
                    }
                });
                
                map.addLayer(mapLayers.regions);
                console.log(`✅ ${data.length} régions chargées complètement`);
                
            } catch (error) {
                console.error('Erreur régions:', error);
                throw error;
            }
        }

        async function loadDepartementsOptimized() {
            try {
                // Chargement complet sans limite
                const { data, error } = await supabase
                    .from('departements')
                    .select('id_departement, nom_departement, geom');
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.departements = L.layerGroup();
                
                data.forEach(departement => {
                    if (departement.geom) {
                        const geometry = parseGeometry(departement.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#000000', 
                                weight: 1.5,
                                opacity: 0.7,
                                fillOpacity: 0 
                            },
                            interactive: true
                        }).addTo(mapLayers.departements);

                        // Calcul immédiat de la superficie
                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #000000; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${departement.nom_departement}
                                </h4>
                                <p><strong>Type:</strong> Département</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function(e) {
                            if (!isDistanceMeasuring && !isAreaMeasuring) {
                                layer.openPopup();
                            }
                        });
                    }
                });
                
                map.addLayer(mapLayers.departements);
                console.log(`✅ ${data.length} départements chargés complètement`);
                
            } catch (error) {
                console.error('Erreur départements:', error);
                throw error;
            }
        }

        async function loadArrondissementsOptimized() {
            try {
                // Chargement complet SANS LIMITE pour avoir tous les arrondissements
                const { data, error } = await supabase
                    .from('arrondissements')
                    .select('id_arrondissement, nom_arrondissement, geom');
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.arrondissements = L.layerGroup();
                
                data.forEach(arrondissement => {
                    if (arrondissement.geom) {
                        const geometry = parseGeometry(arrondissement.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#8B008B', 
                                weight: 1,
                                opacity: 0.6,
                                fillOpacity: 0, 
                                dashArray: '4, 4'
                            },
                            interactive: true
                        }).addTo(mapLayers.arrondissements);

                        // Calcul immédiat de la superficie
                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #8B008B; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${arrondissement.nom_arrondissement}
                                </h4>
                                <p><strong>Type:</strong> Arrondissement</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function(e) {
                            if (!isDistanceMeasuring && !isAreaMeasuring) {
                                L.DomEvent.stopPropagation(e);
                                layer.openPopup();
                            }
                        });
                    }
                });
                
                map.addLayer(mapLayers.arrondissements);
                console.log(`✅ TOUS les ${data.length} arrondissements chargés complètement`);
                
            } catch (error) {
                console.error('Erreur arrondissements:', error);
                throw error;
            }
        }

        // Calcul de superficie à la demande uniquement
        function calculateAreaOnDemand(element, geometry) {
            if (element.dataset.calculated) return;
            
            element.textContent = 'Calcul...';
            
            setTimeout(() => {
                const area = calculateAreaFromGeometry(geometry);
                const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';
                element.textContent = areaText;
                element.dataset.calculated = 'true';
            }, 10);
        }

        // Gestionnaire pour calcul de superficie à la demande
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('calc-area') && !e.target.dataset.calculated) {
                const geometry = JSON.parse(e.target.dataset.geom);
                calculateAreaOnDemand(e.target, geometry);
            }
        });

        // Fonction de chargement conditionnel ultra-simplifiée
        function loadLayersByZoom() {
            const zoom = map.getZoom();
            
            if (zoom < 6) {
                // Masquer départements et arrondissements
                if (mapLayers.departements && map.hasLayer(mapLayers.departements)) {
                    map.removeLayer(mapLayers.departements);
                }
                if (mapLayers.arrondissements && map.hasLayer(mapLayers.arrondissements)) {
                    map.removeLayer(mapLayers.arrondissements);
                }
            } else if (zoom < 9) {
                // Afficher départements, masquer arrondissements
                if (mapLayers.departements && !map.hasLayer(mapLayers.departements)) {
                    map.addLayer(mapLayers.departements);
                }
                if (mapLayers.arrondissements && map.hasLayer(mapLayers.arrondissements)) {
                    map.removeLayer(mapLayers.arrondissements);
                }
            } else {
                // Afficher toutes les couches
                if (mapLayers.departements && !map.hasLayer(mapLayers.departements)) {
                    map.addLayer(mapLayers.departements);
                }
                if (mapLayers.arrondissements && !map.hasLayer(mapLayers.arrondissements)) {
                    map.addLayer(mapLayers.arrondissements);
                }
            }
        }

        // =================================================================
        // OUTILS DE MESURE
        // =================================================================

        function disableAdministrativeLayers() {
            console.log('Désactivation temporaire des popups administratives');
            
            if (mapLayers.regions) {
                mapLayers.regions.eachLayer(layer => {
                    layer.off('click');
                });
            }
            if (mapLayers.departements) {
                mapLayers.departements.eachLayer(layer => {
                    layer.off('click');
                });
            }
            if (mapLayers.arrondissements) {
                mapLayers.arrondissements.eachLayer(layer => {
                    layer.off('click');
                });
            }
        }

        function enableAdministrativeLayers() {
            console.log('Réactivation des popups administratives');
            
            if (mapLayers.regions) {
                mapLayers.regions.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
            if (mapLayers.departements) {
                mapLayers.departements.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
            if (mapLayers.arrondissements) {
                mapLayers.arrondissements.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
        }

        function clearActiveMeasurements() {
            if (isDistanceMeasuring) {
                stopDistanceMeasurement();
            }
            if (isAreaMeasuring) {
                stopAreaMeasurement();
            }

            distanceMarkers.forEach(marker => {
                if (map.hasLayer(marker)) map.removeLayer(marker);
            });
            distanceMarkers = [];

            measurementLines.forEach(line => {
                if (map.hasLayer(line)) map.removeLayer(line);
            });
            measurementLines = [];

            map.closePopup();
        }

        function clearAllMeasurements() {
            clearActiveMeasurements();
            
            measurementPolygons.forEach(item => {
                if (map.hasLayer(item)) map.removeLayer(item);
            });
            measurementPolygons = [];
            
            measurementLayer.clearLayers();
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
            
            // Optionnel: Effacer aussi la position utilisateur
            // clearUserLocation();
            
            map.closePopup();
            showNotification('Toutes les mesures effacées', 'info');
        }

        function startDistanceMeasurement() {
            clearActiveMeasurements();
            
            const button = document.getElementById('measureDistance');
            if (isDistanceMeasuring) {
                stopDistanceMeasurement();
                return;
            }

            isDistanceMeasuring = true;
            button.classList.add('active');
            
            showNotification('Cliquez sur deux points pour mesurer la distance', 'info');
            
            disableAdministrativeLayers();
            
            map.on('click', onDistanceClick);
            map.getContainer().style.cursor = 'crosshair';
        }

        function stopDistanceMeasurement() {
            isDistanceMeasuring = false;
            document.getElementById('measureDistance').classList.remove('active');
            map.off('click', onDistanceClick);
            map.getContainer().style.cursor = '';
            
            enableAdministrativeLayers();
            
            if (distanceMarkers.length === 1) {
                map.removeLayer(distanceMarkers[0]);
                distanceMarkers = [];
            }
        }

        function onDistanceClick(e) {
            if (!isDistanceMeasuring) return;

            L.DomEvent.stopPropagation(e);

            const marker = L.circleMarker(e.latlng, {
                radius: 6,
                color: '#ff4757',
                fillColor: '#ff4757',
                fillOpacity: 1,
                weight: 2
            }).addTo(measurementLayer);

            distanceMarkers.push(marker);

            if (distanceMarkers.length === 2) {
                const distance = calculateDistance(
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                );

                const line = L.polyline([
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                ], {
                    color: '#ff4757',
                    weight: 3,
                    dashArray: '8, 12'
                }).addTo(measurementLayer);

                measurementLines.push(line);

                const midPoint = L.latLngBounds([
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                ]).getCenter();

                L.popup({
                    closeButton: true,
                    autoClose: false,
                    className: 'measurement-tooltip'
                })
                .setLatLng(midPoint)
                .setContent(`<strong>Distance: ${formatDistance(distance)}</strong>`)
                .openOn(map);

                showNotification(`Distance: ${formatDistance(distance)}`, 'success');
                stopDistanceMeasurement();
            }
        }

        function startAreaMeasurement() {
            clearActiveMeasurements();
            
            const button = document.getElementById('measureArea');
            if (isAreaMeasuring) {
                stopAreaMeasurement();
                return;
            }

            isAreaMeasuring = true;
            button.classList.add('active');
            polygonPoints = [];
            
            showNotification('Cliquez pour dessiner un polygone. Double-clic pour terminer.', 'info');
            
            disableAdministrativeLayers();
            
            map.on('click', onPolygonClick);
            map.on('dblclick', onPolygonFinish);
            map.on('mousemove', onPolygonMouseMove);
            map.getContainer().style.cursor = 'crosshair';
        }

        function stopAreaMeasurement() {
            isAreaMeasuring = false;
            document.getElementById('measureArea').classList.remove('active');
            
            map.off('click', onPolygonClick);
            map.off('dblclick', onPolygonFinish);
            map.off('mousemove', onPolygonMouseMove);
            map.getContainer().style.cursor = '';
            
            enableAdministrativeLayers();
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
        }

        function onPolygonClick(e) {
            if (!isAreaMeasuring) return;
            
            L.DomEvent.stopPropagation(e);
            
            polygonPoints.push(e.latlng);
            
            const marker = L.circleMarker(e.latlng, {
                radius: 5,
                color: '#4CAF50',
                fillColor: '#4CAF50',
                fillOpacity: 1,
                weight: 2
            }).addTo(measurementLayer);
            
            measurementPolygons.push(marker);
            
            if (polygonPoints.length >= 2) {
                if (tempPolygon) {
                    map.removeLayer(tempPolygon);
                }
                
                tempPolygon = L.polyline(polygonPoints, {
                    color: '#4CAF50',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 10'
                }).addTo(map);
            }
        }

        function onPolygonFinish(e) {
            if (!isAreaMeasuring || polygonPoints.length < 3) return;
            
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
            
            const finalPolygon = L.polygon(polygonPoints, {
                color: '#4CAF50',
                weight: 3,
                fillColor: '#4CAF50',
                fillOpacity: 0.2
            }).addTo(measurementLayer);
            
            measurementPolygons.push(finalPolygon);
            
            const area = calculatePolygonArea(polygonPoints);
            const center = finalPolygon.getBounds().getCenter();
            
            L.popup({
                closeButton: true,
                autoClose: false,
                className: 'measurement-tooltip'
            })
            .setLatLng(center)
            .setContent(`<strong>Surface: ${formatArea(area)}</strong>`)
            .openOn(map);

            showNotification(`Surface: ${formatArea(area)}`, 'success');
            
            stopAreaMeasurement();
        }

        function onPolygonMouseMove(e) {
            if (!isAreaMeasuring || polygonPoints.length === 0) return;
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
            }
            
            const tempPoints = [...polygonPoints, e.latlng];
            tempPolygon = L.polyline(tempPoints, {
                color: '#4CAF50',
                weight: 2,
                opacity: 0.5,
                dashArray: '5, 10'
            }).addTo(map);
        }

        // =================================================================
        // AUTRES FONCTIONS (existantes abrégées)
        // =================================================================

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth <= 768) {
                if (sidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    sidebar.classList.add('open');
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleSatelliteView() {
            const button = document.getElementById('toggleSatellite');
            if (currentBaseLayer === 'standard') {
                map.removeLayer(baseLayers.standard);
                map.addLayer(baseLayers.satellite);
                currentBaseLayer = 'satellite';
                button.classList.add('active');
            } else {
                map.removeLayer(baseLayers.satellite);
                map.addLayer(baseLayers.standard);
                currentBaseLayer = 'standard';
                button.classList.remove('active');
            }
        }

        // =================================================================
        // GESTION DES ÉVÉNEMENTS
        // =================================================================

        function initializeEventListeners() {
            console.log('🎯 Initialisation des événements avec impression');
            
            // Événements existants
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            document.getElementById('zoomHome').addEventListener('click', () => map.setView(CONFIG.map.center, CONFIG.map.zoom));
            document.getElementById('toggleSatellite').addEventListener('click', toggleSatelliteView);
            
            // NOUVEAU: Événement de géolocalisation
            document.getElementById('locateUser').addEventListener('click', locateUser);
            
            document.getElementById('measureDistance').addEventListener('click', startDistanceMeasurement);
            document.getElementById('measureArea').addEventListener('click', startAreaMeasurement);
            document.getElementById('clearMeasurements').addEventListener('click', clearAllMeasurements);
            
            // NOUVEAU: Événement d'impression
            document.getElementById('printMap').addEventListener('click', openPrintModal);

            // Événements du modal d'impression
            document.getElementById('closePrintModal').addEventListener('click', closePrintModal);
            document.getElementById('cancelPrint').addEventListener('click', closePrintModal);
            document.getElementById('proceedToPay').addEventListener('click', proceedToPayment);

            // Événements du modal de paiement
            document.getElementById('cancelPayment').addEventListener('click', cancelPayment);
            document.getElementById('confirmPayment').addEventListener('click', processPayment);

            // Événements de configuration d'impression
            document.getElementById('mapTitle').addEventListener('input', updatePrintPreview);
            document.getElementById('outputFormat').addEventListener('change', updatePrintPreview);
            document.getElementById('mapScale').addEventListener('input', updatePrintPreview);
            document.getElementById('showNorthArrow').addEventListener('change', updatePrintPreview);
            document.getElementById('showScale').addEventListener('change', updatePrintPreview);
            document.getElementById('showLegend').addEventListener('change', updatePrintPreview);
            document.getElementById('showCoordinates').addEventListener('change', updatePrintPreview);

            // Sélection des formats
            document.querySelectorAll('.format-option').forEach(option => {
                option.addEventListener('click', function() {
                    const format = this.dataset.format;
                    const price = parseInt(this.dataset.price);
                    selectFormat(format, price);
                });
            });

            // Presets d'échelle
            document.querySelectorAll('.scale-preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    const scale = this.dataset.scale;
                    setScale(scale);
                });
            });

            // Contrôles des couches
            document.querySelectorAll('.layer-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const layer = this.dataset.layer;
                    if (mapLayers[layer]) {
                        if (map.hasLayer(mapLayers[layer])) {
                            map.removeLayer(mapLayers[layer]);
                        } else {
                            map.addLayer(mapLayers[layer]);
                        }
                    }
                });
            });

            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    startDistanceMeasurement();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    startAreaMeasurement();
                } else if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    openPrintModal();
                } else if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    locateUser();
                } else if (e.key === 'Escape') {
                    // Fermer les modaux ouverts
                    if (document.getElementById('printModal').classList.contains('active')) {
                        closePrintModal();
                    } else if (document.getElementById('paymentModal').classList.contains('active')) {
                        cancelPayment();
                    } else if (isLocating) {
                        stopLocationTracking();
                    }
                }
            });
            
            console.log('✅ Événements d\'impression initialisés');
        }

        // =================================================================
        // ADMINISTRATION (existante)
        // =================================================================

        window.checkAdminAccess = function() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px; color: #2c5530;">Accès Administrateur</h3>
                        <div id="loginError" style="display: none; background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 14px;"></div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" id="adminEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="admin@monvillage.cm" required>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mot de passe:</label>
                            <input type="password" id="adminPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" required>
                        </div>
                        <div id="loginSpinner" style="display: none; text-align: center; margin: 20px 0;">
                            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #4a7c59; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                            <p style="margin-top: 10px; color: #666;">Connexion en cours...</p>
                        </div>
                        <div style="text-align: center;">
                            <button id="loginButton" onclick="processRealAdminLogin()" style="background: #4a7c59; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Se connecter</button>
                            <button onclick="closeAdminModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            modal.id = 'adminModal';
            document.body.appendChild(modal);
        };

        window.closeAdminModal = function() {
            const modal = document.getElementById('adminModal');
            if (modal) {
                modal.remove();
            }
            // Nettoyer aussi les autres modaux potentiels
            const dashboardModal = document.getElementById('dashboardModal');
            if (dashboardModal) {
                dashboardModal.remove();
            }
        };

        window.processRealAdminLogin = async function() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;
            const errorDiv = document.getElementById('loginError');
            const spinner = document.getElementById('loginSpinner');
            const loginButton = document.getElementById('loginButton');
            
            if (!email || !password) {
                showError('Veuillez saisir email et mot de passe');
                return;
            }

            // Afficher le spinner
            spinner.style.display = 'block';
            loginButton.disabled = true;
            errorDiv.style.display = 'none';

            console.log('Tentative de connexion avec email:', email);

            try {
                // Tentative de connexion via Supabase Auth
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                console.log('Résultat auth:', { data, error });

                if (error) {
                    console.error('Erreur auth:', error);
                    throw error;
                }

                console.log('Utilisateur connecté:', data.user.id);

                // Vérifier si l'utilisateur est admin avec plus de débuggage
                const { data: adminProfile, error: profileError } = await supabase
                    .from('admin_profiles')
                    .select('*')
                    .eq('id', data.user.id)
                    .eq('is_active', true)
                    .single();

                console.log('Recherche profil admin pour ID:', data.user.id);
                console.log('Résultat profil:', { adminProfile, profileError });

                if (profileError) {
                    console.error('Erreur profil:', profileError);
                    
                    // Si l'erreur est "No rows found", essayer sans le .single()
                    if (profileError.code === 'PGRST116') {
                        const { data: allProfiles, error: allError } = await supabase
                            .from('admin_profiles')
                            .select('*')
                            .eq('id', data.user.id);
                        
                        console.log('Tous les profils pour cet ID:', allProfiles);
                        
                        if (allError || !allProfiles || allProfiles.length === 0) {
                            throw new Error('Aucun profil administrateur trouvé pour cet utilisateur');
                        }
                        
                        if (allProfiles[0].is_active !== true) {
                            throw new Error('Profil administrateur désactivé');
                        }
                        
                        // Utiliser le premier profil trouvé
                        adminProfile = allProfiles[0];
                    } else {
                        throw new Error('Erreur lors de la vérification du profil administrateur');
                    }
                }

                if (!adminProfile) {
                    throw new Error('Accès non autorisé - Profil administrateur requis');
                }

                // Connexion réussie
                console.log('Connexion admin réussie:', adminProfile);
                showNotification(`Bienvenue ${adminProfile.full_name}. Accès administrateur activé.`, 'success');
                enableRealAdminFeatures(adminProfile, data.user);
                closeAdminModal();

                // Mettre à jour les statistiques de connexion
                await updateLoginStats(adminProfile.id);

            } catch (error) {
                console.error('Erreur connexion admin complète:', error);
                let message = 'Erreur de connexion';
                
                if (error.message.includes('Invalid login credentials')) {
                    message = 'Email ou mot de passe incorrect';
                } else if (error.message.includes('Email not confirmed')) {
                    message = 'Veuillez confirmer votre email';
                } else if (error.message.includes('non autorisé') || error.message.includes('Aucun profil')) {
                    message = error.message;
                } else if (error.message.includes('désactivé')) {
                    message = 'Compte administrateur désactivé';
                } else {
                    message = `Erreur: ${error.message}`;
                }
                
                showError(message);
            } finally {
                spinner.style.display = 'none';
                loginButton.disabled = false;
            }

            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                console.error('Erreur affichée:', message);
            }
        };

        async function updateLoginStats(adminId) {
            try {
                await supabase
                    .from('admin_profiles')
                    .update({
                        last_login: new Date().toISOString(),
                        login_count: supabase.raw('login_count + 1')
                    })
                    .eq('id', adminId);
            } catch (error) {
                console.warn('Erreur mise à jour stats connexion:', error);
            }
        }

        function enableRealAdminFeatures(adminProfile, user) {
            const adminAccess = document.querySelector('.admin-access');
            adminAccess.innerHTML = `<i class="fas fa-user-shield"></i><span>${adminProfile.full_name}</span>`;
            adminAccess.onclick = showAdminDashboard;
            
            // Stocker les informations admin dans la session
            window.adminUser = {
                profile: adminProfile,
                user: user,
                isAuthenticated: true
            };
        }

        function showAdminDashboard() {
            if (!window.adminUser || !window.adminUser.isAuthenticated) {
                checkAdminAccess();
                return;
            }

            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2c5530; margin: 0;">Dashboard Administrateur</h3>
                            <button onclick="closeDashboard()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="color: #4a7c59; margin: 0 0 10px 0;">Profil Admin</h4>
                                <p style="margin: 5px 0;"><strong>Nom:</strong> ${window.adminUser.profile.full_name}</p>
                                <p style="margin: 5px 0;"><strong>Rôle:</strong> ${window.adminUser.profile.role}</p>
                                <p style="margin: 5px 0;"><strong>Connexions:</strong> ${window.adminUser.profile.login_count || 0}</p>
                            </div>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h4 style="color: #4a7c59; margin: 0 0 10px 0;">Actions</h4>
                                <button onclick="viewPayments()" style="background: #4a7c59; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">Voir Paiements</button>
                                <button onclick="adminLogout()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; margin: 5px; cursor: pointer;">Déconnexion</button>
                            </div>
                        </div>
                        
                        <div id="dashboardContent" style="min-height: 200px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <p style="text-align: center; color: #666;">Sélectionnez une action ci-dessus</p>
                        </div>
                    </div>
                </div>
            `;
            modal.id = 'dashboardModal';
            document.body.appendChild(modal);

            // Fonctions du dashboard
            window.closeDashboard = function() {
                document.getElementById('dashboardModal').remove();
            };

            window.viewPayments = async function() {
                const content = document.getElementById('dashboardContent');
                content.innerHTML = '<p style="text-align: center;">Chargement des paiements...</p>';
                
                try {
                    const { data: payments, error } = await supabase
                        .from('payments')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (error) throw error;

                    let html = '<h4>Derniers Paiements</h4>';
                    if (payments && payments.length > 0) {
                        html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                        html += '<tr style="background: #e9ecef;"><th style="padding: 8px; border: 1px solid #ddd;">Date</th><th style="padding: 8px; border: 1px solid #ddd;">Format</th><th style="padding: 8px; border: 1px solid #ddd;">Montant</th><th style="padding: 8px; border: 1px solid #ddd;">Statut</th></tr>';
                        
                        payments.forEach(payment => {
                            html += `<tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${new Date(payment.created_at).toLocaleDateString('fr-FR')}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${payment.print_format || 'N/A'}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${payment.amount} ${payment.currency}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;"><span style="padding: 2px 6px; border-radius: 3px; background: ${payment.status === 'success' ? '#d4edda' : '#f8d7da'}; color: ${payment.status === 'success' ? '#155724' : '#721c24'};">${payment.status}</span></td>
                            </tr>`;
                        });
                        html += '</table></div>';
                    } else {
                        html += '<p>Aucun paiement trouvé</p>';
                    }
                    
                    content.innerHTML = html;
                } catch (error) {
                    content.innerHTML = `<p style="color: red;">Erreur: ${error.message}</p>`;
                }
            };

            window.adminLogout = async function() {
                try {
                    await supabase.auth.signOut();
                    window.adminUser = null;
                    
                    const adminAccess = document.querySelector('.admin-access');
                    adminAccess.innerHTML = `<i class="fas fa-cog"></i><span>Admin</span>`;
                    adminAccess.onclick = checkAdminAccess;
                    
                    closeDashboard();
                    showNotification('Déconnexion admin réussie', 'info');
                } catch (error) {
                    console.error('Erreur déconnexion:', error);
                    showNotification('Erreur lors de la déconnexion', 'error');
                }
            };
        }

        // =================================================================
        // FONCTIONS DE GÉNÉRATION D'EXPORTATION AVANCÉES
        // =================================================================

        async function generateMapFile(exportData) {
            // Cette fonction sera appelée en production pour générer le fichier réel
            console.log('🔧 Génération du fichier carte (fonction de production)');
            
            try {
                // En production, cette fonction ferait appel à une API backend
                // qui utiliserait des bibliothèques comme:
                // - Puppeteer pour capture HTML/CSS vers PDF/PNG
                // - JSPDF pour génération PDF programmatique  
                // - Canvas API pour rendu personnalisé
                // - MapProxy ou similaire pour export haute résolution
                
                const response = await fetch('/api/generate-map', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                });
                
                if (!response.ok) {
                    throw new Error('Erreur lors de la génération');
                }
                
                const blob = await response.blob();
                return blob;
                
            } catch (error) {
                console.error('Erreur génération:', error);
                throw error;
            }
        }

        function getMapLayers() {
            // Récupérer les couches actives pour l'export
            const layers = [];
            
            if (map.hasLayer(baseLayers.standard)) {
                layers.push({
                    type: 'basemap',
                    name: 'standard',
                    url: baseLayers.standard._url
                });
            }
            
            if (map.hasLayer(baseLayers.satellite)) {
                layers.push({
                    type: 'basemap', 
                    name: 'satellite',
                    url: baseLayers.satellite._url
                });
            }
            
            // Ajouter les couches de données si actives
            Object.keys(mapLayers).forEach(layerKey => {
                if (mapLayers[layerKey] && map.hasLayer(mapLayers[layerKey])) {
                    layers.push({
                        type: 'data',
                        name: layerKey,
                        data: getLayerData(layerKey)
                    });
                }
            });
            
            return layers;
        }

        function getLayerData(layerKey) {
            // Extraire les données GeoJSON des couches pour l'export
            if (!mapLayers[layerKey]) return null;
            
            const features = [];
            mapLayers[layerKey].eachLayer(layer => {
                if (layer.feature) {
                    features.push(layer.feature);
                } else if (layer.toGeoJSON) {
                    features.push(layer.toGeoJSON());
                }
            });
            
            return {
                type: 'FeatureCollection',
                features: features
            };
        }

        function calculateMapExtent() {
            // Calculer l'étendue de la carte pour l'export
            const bounds = map.getBounds();
            const zoom = map.getZoom();
            const center = map.getCenter();
            
            // Calculer la résolution en fonction de l'échelle demandée
            const scale = printConfig.scale;
            const dpi = 300; // DPI pour impression haute qualité
            
            // Calcul de la résolution (mètres par pixel)
            const resolution = scale / (dpi * 39.37); // 39.37 inches per meter
            
            return {
                bounds: bounds,
                center: center,
                zoom: zoom,
                scale: scale,
                resolution: resolution,
                dpi: dpi
            };
        }

        function generateMapMetadata() {
            // Générer les métadonnées pour l'export
            const now = new Date();
            const extent = calculateMapExtent();
            
            return {
                title: printConfig.title,
                subtitle: `Échelle 1:${printConfig.scale.toLocaleString()}`,
                date: now.toLocaleDateString('fr-FR'),
                time: now.toLocaleTimeString('fr-FR'),
                format: printConfig.format,
                outputType: printConfig.outputFormat,
                extent: extent,
                projection: 'WGS84 (EPSG:4326)',
                source: 'MonVillage - Cartographie du Cameroun',
                contact: 'monvillage.cm@gmail.com',
                website: 'https://monvillage.cm',
                copyright: '© 2024 MonVillage',
                activeLayers: getActiveLayers(),
                options: {
                    showNorthArrow: printConfig.showNorthArrow,
                    showScale: printConfig.showScale,
                    showLegend: printConfig.showLegend,
                    showCoordinates: printConfig.showCoordinates
                }
            };
        }

        // =================================================================
        // GESTION DES ERREURS ET RETRY
        // =================================================================

        async function retryOperation(operation, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await operation();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    
                    console.log(`Tentative ${i + 1} échouée, retry dans ${delay}ms`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Backoff exponentiel
                }
            }
        }

        // =================================================================
        // INITIALISATION PRINCIPALE
        // =================================================================

        // Initialisation de l'application
        function initApp() {
            console.log('🚀 Initialisation MonVillage...');
            
            // Vérifier que tous les scripts sont chargés
            if (typeof L === 'undefined') {
                console.log('⏳ Attente du chargement de Leaflet...');
                setTimeout(initApp, 500);
                return;
            }
            
            if (typeof supabase === 'undefined' && window.supabase) {
                supabase = window.supabase;
            }
            
            try {
                // Initialiser Supabase
                initSupabase();
                
                // Initialiser la carte
                setTimeout(() => {
                    initMap();
                }, 100);
                
                // Charger les données
                setTimeout(() => {
                    loadInitialData();
                }, 500);
                
                // Initialiser les événements
                initEventListeners();
                
                console.log('✅ MonVillage initialisé avec succès');
                showNotification('MonVillage chargé avec succès', 'success');
            } catch (error) {
                console.error('❌ Erreur initialisation:', error);
                showNotification('Erreur d\'initialisation de l\'application', 'error');
            }
        }
        
        // Démarrage de l'application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
        
        // Fallback si les scripts ne se chargent pas
        setTimeout(() => {
            if (typeof L === 'undefined') {
                console.error('❌ Leaflet non chargé après 5 secondes');
                document.body.innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: #f5f5f5; font-family: Arial, sans-serif;">
                        <div style="text-align: center; padding: 2rem; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h2 style="color: #e74c3c; margin-bottom: 1rem;">⚠️ Erreur de Chargement</h2>
                            <p>Les ressources cartographiques n'ont pas pu être chargées.</p>
                            <p>Veuillez vérifier votre connexion internet et actualiser la page.</p>
                            <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                🔄 Actualiser
                            </button>
                        </div>
                    </div>
                `;
            }
        }, 5000);
        
        // Gestion des erreurs globales
        window.addEventListener('error', (event) => {
            console.error('❌ Erreur globale:', event.error);
            if (event.error.message.includes('L is not defined')) {
                console.error('❌ Problème de chargement Leaflet détecté');
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Promise rejetée:', event.reason);
        });

        // Gestion du redimensionnement
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            // Invalider la taille de la carte pour le redimensionnement
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        });

        // Gestion de la déconnexion/fermeture
        window.addEventListener('beforeunload', function(e) {
            // Nettoyer les ressources si nécessaire
            if (measurementLayer) {
                measurementLayer.clearLayers();
            }
        });

        // =================================================================
        // FONCTIONS UTILITAIRES SUPPLÉMENTAIRES
        // =================================================================

        function formatPrice(price) {
            return `${price.toLocaleString()} XAF`;
        }

        function validatePrintConfig() {
            const errors = [];
            
            if (!printConfig.title || printConfig.title.trim().length === 0) {
                errors.push('Le titre de la carte est requis');
            }
            
            if (printConfig.scale < 1000 || printConfig.scale > 10000000) {
                errors.push('L\'échelle doit être entre 1:1,000 et 1:10,000,000');
            }
            
            if (!CONFIG.print.formats[printConfig.format]) {
                errors.push('Format de papier invalide');
            }
            
            return errors;
        }

        function showPrintErrors(errors) {
            if (errors.length > 0) {
                const errorMessage = 'Erreurs de configuration:\n' + errors.join('\n');
                showNotification(errorMessage, 'error', 6000);
                return false;
            }
            return true;
        }

        // Test de la configuration Flutterwave
        function testFlutterwaveConfig() {
            if (!CONFIG.flutterwave.publicKey) {
                console.warn('⚠️  Clé publique Flutterwave manquante');
                return false;
            }
            
            if (typeof FlutterwaveCheckout === 'undefined') {
                console.warn('⚠️  SDK Flutterwave non chargé');
                return false;
            }
            
            console.log('✅ Configuration Flutterwave OK');
            return true;
        }

        // Initialisation des tests de configuration
        setTimeout(() => {
            testFlutterwaveConfig();
        }, 2000);

        console.log('🎯 MonVillage - Système d\'impression complet initialisé');
        console.log('📋 Raccourcis: Ctrl+D (distance), Ctrl+S (surface), Ctrl+P (impression), Escape (fermer)');
        console.log('💰 Tarifs: A4(500), A3(1000), A2(2000), A1(4000), A0(6000) XAF');
    </script>
</body>
</html>