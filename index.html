<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonVillage - Cartographie des Villages du Cameroun</title>
    
    <!-- Leaflet CSS uniquement -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; background: #1a1a1a; color: #333; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        .header { background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; padding: 8px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; position: relative; }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; height: 50px; }
        .logo-section { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .logo { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .app-title { font-size: 20px; font-weight: bold; margin: 0; line-height: 1; }
        .search-container { position: relative; flex: 1; max-width: 450px; margin: 0 20px; }
        .search-input { width: 100%; padding: 8px 35px 8px 12px; border: none; border-radius: 20px; font-size: 13px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); height: 34px; }
        .search-btn { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: #4a7c59; border: none; color: white; padding: 6px 10px; border-radius: 50%; cursor: pointer; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .admin-access { color: rgba(255,255,255,0.9); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 15px; transition: background 0.2s; height: 34px; flex-shrink: 0; }
        .admin-access:hover { background: rgba(255,255,255,0.1); }

        /* Main Content */
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s ease; }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .sidebar { width: 300px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: transform 0.3s ease; z-index: 1000; overflow-y: auto; position: relative; }
        .sidebar.collapsed { transform: translateX(-280px); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e0e0e0; background: #f8f9fa; position: relative; }
        .sidebar-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c5530; }
        .sidebar-close-btn { background: none; border: none; font-size: 18px; color: #666; cursor: pointer; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: none; align-items: center; justify-content: center; transition: all 0.2s; position: absolute; top: 15px; right: 15px; }
        .sidebar-close-btn:hover { background: #e0e0e0; color: #333; }
        .layer-controls { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .layer-control-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .layer-toggle { position: relative; width: 50px; height: 25px; background: #ccc; border-radius: 25px; cursor: pointer; transition: background 0.2s; }
        .layer-toggle.active { background: #4a7c59; }
        .layer-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: white; border-radius: 50%; transition: transform 0.2s; }
        .layer-toggle.active::after { transform: translateX(25px); }
        .legend-section { padding: 15px 20px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .legend-item:hover { background: #f0f0f0; }
        .legend-symbol { width: 20px; height: 20px; margin-right: 10px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .legend-label { font-size: 14px; color: #333; }

        /* Map Container */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .toolbar { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 600; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { background: none; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; color: #666; transition: all 0.2s; min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .tool-btn:hover { background: #f0f0f0; color: #333; }
        .tool-btn.active { background: #4a7c59; color: white; }
        .toggle-sidebar { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 18px; cursor: pointer; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 600; color: #4a7c59; transition: all 0.2s ease; }
        .toggle-sidebar:hover { background: rgba(255,255,255,1); transform: scale(1.05); }

        /* Notification System */
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10000; transform: translateX(400px); transition: transform 0.3s ease; max-width: 350px; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #4CAF50; color: white; }
        .notification.error { background: #F44336; color: white; }
        .notification.warning { background: #FF9800; color: white; }
        .notification.info { background: #2196F3; color: white; }

        /* Measurement styles */
        .measurement-tooltip { background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 5px; font-size: 13px; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* Footer */
        .footer { background: #2c5530; color: white; padding: 15px 20px; text-align: center; font-size: 14px; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .contact-info { display: flex; gap: 20px; align-items: center; }
        .contact-item { display: flex; align-items: center; gap: 5px; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content { flex-direction: row; gap: 8px; padding: 4px 8px; height: 45px; justify-content: space-between; }
            .logo { width: 28px; height: 28px; font-size: 12px; }
            .app-title { font-size: 14px; }
            .search-container { flex: 1; margin: 0 10px; }
            .search-input { height: 32px; font-size: 12px; padding: 6px 30px 6px 10px; }
            .search-btn { width: 24px; height: 24px; font-size: 11px; }
            .admin-access { font-size: 11px; height: 32px; padding: 6px 8px; gap: 4px; }
            .admin-access span { display: none; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); }
            .sidebar-close-btn { display: flex !important; }
            .sidebar-header { padding-top: 25px; }
            .toolbar { flex-direction: row; top: auto; bottom: 20px; right: 20px; left: 20px; justify-content: center; }
            .footer-content { flex-direction: column; gap: 10px; text-align: center; }
            .contact-info { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo"><i class="fas fa-map-marked-alt"></i></div>
                    <h1 class="app-title">MonVillage</h1>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Rechercher un village..." id="searchInput">
                    <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
                    <div class="search-results" id="searchResults"></div>
                </div>
                <div class="admin-access" onclick="checkAdminAccess()">
                    <i class="fas fa-cog"></i>
                    <span>Admin</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="sidebar-close-btn" id="closeSidebar"><i class="fas fa-times"></i></button>
                    <div><h3 class="sidebar-title">Légende</h3><p>Couches cartographiques</p></div>
                </div>
                <div class="layer-controls">
                    <div class="layer-control-item"><span>Régions</span><div class="layer-toggle active" data-layer="regions"></div></div>
                    <div class="layer-control-item"><span>Départements</span><div class="layer-toggle active" data-layer="departements"></div></div>
                    <div class="layer-control-item"><span>Arrondissements</span><div class="layer-toggle active" data-layer="arrondissements"></div></div>
                    <div class="layer-control-item"><span>Villages</span><div class="layer-toggle active" data-layer="villages"></div></div>
                    <div class="layer-control-item"><span>Points d'intérêt</span><div class="layer-toggle active" data-layer="poi"></div></div>
                    <div class="layer-control-item"><span>Géonymes</span><div class="layer-toggle active" data-layer="geonames"></div></div>
                </div>
                <div class="legend-section">
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 3px solid #d62728;"></div><span class="legend-label">Régions</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px solid #000000;"></div><span class="legend-label">Départements</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px dashed #8B008B;"></div><span class="legend-label">Arrondissements</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: rgba(74, 124, 89, 0.3); border: 2px solid #4a7c59;"></div><span class="legend-label">Villages</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FFD700;"><i class="fas fa-crown" style="font-size: 10px; color: #333;"></i></div><span class="legend-label">Chefferies</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #4CAF50;"><i class="fas fa-school" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Écoles</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #F44336;"><i class="fas fa-hospital" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Centres de santé</span></div>
                </div>
            </aside>

            <!-- Map Container -->
            <div class="map-container">
                <button class="toggle-sidebar" id="toggleSidebar"><i class="fas fa-bars"></i></button>
                <div class="toolbar">
                    <button class="tool-btn" id="measureDistance" title="Mesurer une distance"><i class="fas fa-ruler"></i></button>
                    <button class="tool-btn" id="measureArea" title="Mesurer une surface"><i class="fas fa-draw-polygon"></i></button>
                    <button class="tool-btn" id="clearMeasurements" title="Effacer les mesures"><i class="fas fa-eraser"></i></button>
                    <button class="tool-btn" id="printMap" title="Imprimer la carte"><i class="fas fa-print"></i></button>
                    <button class="tool-btn" id="zoomHome" title="Vue d'ensemble"><i class="fas fa-home"></i></button>
                    <button class="tool-btn" id="toggleSatellite" title="Vue satellite"><i class="fas fa-satellite"></i></button>
                </div>
                <div id="map"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="contact-info">
                    <div class="contact-item"><i class="fas fa-envelope"></i><span>monvillage.cm@gmail.com</span></div>
                    <div class="contact-item"><i class="fas fa-phone"></i><span>+237 697 182 925</span></div>
                </div>
                <div>© 2024 MonVillage - Cartographie des Villages du Cameroun</div>
            </div>
        </footer>

        <!-- Notification Container -->
        <div id="notification" class="notification"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        console.log('🚀 MonVillage - Initialisation complète');
        
        // =================================================================
        // CONFIGURATION ET VARIABLES GLOBALES
        // =================================================================
        
        const CONFIG = {
            supabase: {
                url: 'https://hrlufnjhwhgddxkpyzst.supabase.co',
                anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybHVmbmpod2hnZGR4a3B5enN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MzIwMzcsImV4cCI6MjA2ODMwODAzN30.0gMYonFDAU84i3boEIKZDK4OQhDrAXXJySGDa80wTZ8'
            },
            mapbox: {
                accessToken: 'pk.eyJ1IjoiZWthbnNvbiIsImEiOiJjbWUyeDFxZDUwMTVrMmlvcHMzaDlwOXRvIn0.r7nOAUE0YU8c4miQFeJZWg'
            },
            map: { center: [4.1485, 9.504], zoom: 7 }
        };

        let map, supabase;
        let mapLayers = { regions: null, departements: null, arrondissements: null, villages: null, poi: null, geonames: null };
        let baseLayers = { standard: null, satellite: null };
        let currentBaseLayer = 'standard';
        
        let measurementLayer;
        let isDistanceMeasuring = false;
        let isAreaMeasuring = false;
        let distanceMarkers = [];
        let measurementLines = [];
        let measurementPolygons = [];
        let polygonPoints = [];
        let tempPolygon = null;

        // =================================================================
        // TOUTES LES FONCTIONS UTILITAIRES (DÉFINIES EN PREMIER)
        // =================================================================

        function parseGeometry(geom) {
            if (!geom) return null;
            try {
                return typeof geom === 'object' ? geom : JSON.parse(geom);
            } catch (error) {
                console.error('Erreur parsing géométrie:', error);
                return null;
            }
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function calculateDistance(latlng1, latlng2) {
            const R = 6371000;
            const lat1 = latlng1.lat * Math.PI / 180;
            const lat2 = latlng2.lat * Math.PI / 180;
            const deltaLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
            const deltaLng = (latlng2.lng - latlng1.lng) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function calculatePolygonArea(latlngs) {
            if (latlngs.length < 3) return 0;
            
            const R = 6371000;
            let area = 0;
            const n = latlngs.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                const lat1 = latlngs[i].lat * Math.PI / 180;
                const lat2 = latlngs[j].lat * Math.PI / 180;
                const deltaLng = (latlngs[j].lng - latlngs[i].lng) * Math.PI / 180;
                
                area += deltaLng * (2 + Math.sin(lat1) + Math.sin(lat2));
            }
            
            area = Math.abs(area) * R * R / 2;
            return area;
        }

        function calculateAreaFromGeometry(geometry) {
            if (!geometry || !geometry.coordinates) {
                console.log('Géométrie invalide pour calcul superficie');
                return 'Non calculé';
            }
            
            try {
                console.log('Calcul superficie pour géométrie:', geometry.type);
                
                let coordinates;
                if (geometry.type === 'Polygon') {
                    coordinates = geometry.coordinates[0];
                } else if (geometry.type === 'MultiPolygon') {
                    let totalArea = 0;
                    geometry.coordinates.forEach(polygon => {
                        const polygonCoords = polygon[0].map(coord => ({lat: coord[1], lng: coord[0]}));
                        totalArea += calculatePolygonArea(polygonCoords);
                    });
                    console.log('Superficie MultiPolygon calculée:', totalArea);
                    return totalArea;
                }
                
                if (coordinates && coordinates.length > 3) {
                    const latlngs = coordinates.map(coord => ({lat: coord[1], lng: coord[0]}));
                    const area = calculatePolygonArea(latlngs);
                    console.log('Superficie Polygon calculée:', area);
                    return area;
                }
                
                console.log('Coordonnées insuffisantes pour calcul');
                return 0;
            } catch (error) {
                console.error('Erreur calcul superficie:', error);
                return 'Erreur calcul';
            }
        }

        function formatDistance(distance) {
            if (distance < 1000) {
                return `${Math.round(distance)} m`;
            } else {
                return `${(distance / 1000).toFixed(2)} km`;
            }
        }

        function formatArea(area) {
            if (area < 1000) {
                return `${Math.round(area)} m²`;
            } else if (area < 10000) {
                return `${(area / 1000).toFixed(2)} k m²`;
            } else if (area < 1000000) {
                const hectares = area / 10000;
                return `${hectares.toFixed(2)} ha`;
            } else {
                const km2 = area / 1000000;
                if (km2 < 10) {
                    return `${km2.toFixed(3)} km²`;
                } else if (km2 < 1000) {
                    return `${km2.toFixed(2)} km²`;
                } else {
                    return `${Math.round(km2).toLocaleString()} km²`;
                }
            }
        }

        function disableAdministrativeLayers() {
            console.log('Désactivation temporaire des popups administratives');
            
            if (mapLayers.regions) {
                mapLayers.regions.eachLayer(layer => {
                    layer.off('click');
                });
            }
            if (mapLayers.departements) {
                mapLayers.departements.eachLayer(layer => {
                    layer.off('click');
                });
            }
            if (mapLayers.arrondissements) {
                mapLayers.arrondissements.eachLayer(layer => {
                    layer.off('click');
                });
            }
        }

        function enableAdministrativeLayers() {
            console.log('Réactivation des popups administratives');
            
            if (mapLayers.regions) {
                mapLayers.regions.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
            if (mapLayers.departements) {
                mapLayers.departements.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
            if (mapLayers.arrondissements) {
                mapLayers.arrondissements.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
        }

        function clearActiveMeasurements() {
            if (isDistanceMeasuring) {
                stopDistanceMeasurement();
            }
            if (isAreaMeasuring) {
                stopAreaMeasurement();
            }

            distanceMarkers.forEach(marker => {
                if (map.hasLayer(marker)) map.removeLayer(marker);
            });
            distanceMarkers = [];

            measurementLines.forEach(line => {
                if (map.hasLayer(line)) map.removeLayer(line);
            });
            measurementLines = [];

            map.closePopup();
        }

        function clearAllMeasurements() {
            clearActiveMeasurements();
            
            measurementPolygons.forEach(item => {
                if (map.hasLayer(item)) map.removeLayer(item);
            });
            measurementPolygons = [];
            
            measurementLayer.clearLayers();
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
            
            map.closePopup();
            showNotification('Toutes les mesures effacées', 'info');
        }

        // =================================================================
        // FONCTIONS D'INITIALISATION
        // =================================================================

        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                console.log('✅ Supabase initialisé');
            } catch (error) {
                console.error('❌ Erreur Supabase:', error);
                showNotification('Mode hors ligne - données démo', 'warning');
            }
        }

        function initializeMap() {
            console.log('🗺️ Initialisation de la carte');
            
            map = L.map('map', { 
                center: CONFIG.map.center, 
                zoom: CONFIG.map.zoom, 
                zoomControl: false 
            });
            
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            baseLayers.standard = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: '© Mapbox © OpenStreetMap',
                id: 'mapbox/streets-v11',
                accessToken: CONFIG.mapbox.accessToken,
                maxZoom: 18
            });

            baseLayers.satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                attribution: '© Google',
                maxZoom: 20
            });

            baseLayers.standard.addTo(map);
            console.log('✅ Carte initialisée');
        }

        function initializeNativeMeasurementTools() {
            console.log('📏 Initialisation des outils de mesure natifs');
            
            measurementLayer = new L.FeatureGroup();
            map.addLayer(measurementLayer);
            
            console.log('✅ Outils de mesure prêts');
        }

        // =================================================================
        // FONCTIONS DE CHARGEMENT DES DONNÉES
        // =================================================================

        async function loadInitialData() {
            console.log('📊 Chargement des données...');
            if (!supabase) {
                showNotification('Mode démo - pas de données', 'warning');
                return;
            }
            try {
                await loadRegions();
                await loadDepartements();
                await loadArrondissements();
                console.log('✅ Données chargées avec succès');
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                showNotification('Erreur de chargement des données', 'error');
            }
        }

        async function loadRegions() {
            try {
                const { data, error } = await supabase.from('regions').select('*');
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.regions = L.layerGroup().addTo(map);
                
                data.forEach(region => {
                    if (region.geom) {
                        const geometry = parseGeometry(region.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#d62728', 
                                weight: 3, 
                                opacity: 1, 
                                fillOpacity: 0 
                            }
                        }).addTo(mapLayers.regions);

                        console.log('Calcul superficie région:', region.nom_region);
                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : area;
                        console.log('Superficie région calculée:', areaText);

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #d62728; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${region.nom_region}
                                </h4>
                                <p><strong>Type:</strong> Région</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function() {
                            layer.openPopup();
                        });
                    }
                });
                
                console.log(`✅ ${data.length} régions chargées avec superficies`);
            } catch (error) {
                console.error('Erreur régions:', error);
                throw error;
            }
        }

        async function loadDepartements() {
            try {
                const { data, error } = await supabase.from('departements').select('*');
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.departements = L.layerGroup().addTo(map);
                
                data.forEach(departement => {
                    if (departement.geom) {
                        const geometry = parseGeometry(departement.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#000000', 
                                weight: 2, 
                                opacity: 1, 
                                fillOpacity: 0 
                            }
                        }).addTo(mapLayers.departements);

                        console.log('Calcul superficie département:', departement.nom_departement);
                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : area;
                        console.log('Superficie département calculée:', areaText);

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #000000; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${departement.nom_departement}
                                </h4>
                                <p><strong>Type:</strong> Département</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function() {
                            layer.openPopup();
                        });
                    }
                });
                
                console.log(`✅ ${data.length} départements chargés avec superficies`);
            } catch (error) {
                console.error('Erreur départements:', error);
                throw error;
            }
        }

        async function loadArrondissements() {
            try {
                const { data, error } = await supabase.from('arrondissements').select('*');
                if (error) throw error;
                if (!data || data.length === 0) {
                    console.log('⚠️ Aucun arrondissement trouvé dans la base de données');
                    return;
                }

                mapLayers.arrondissements = L.layerGroup().addTo(map);
                
                data.forEach(arrondissement => {
                    if (arrondissement.geom) {
                        const geometry = parseGeometry(arrondissement.geom);
                        if (!geometry) {
                            console.warn('Géométrie invalide pour arrondissement:', arrondissement.nom_arrondissement);
                            return;
                        }

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#8B008B', 
                                weight: 2, 
                                opacity: 0.8,
                                fillOpacity: 0, 
                                dashArray: '8, 8'
                            }
                        }).addTo(mapLayers.arrondissements);

                        console.log('Calcul superficie arrondissement:', arrondissement.nom_arrondissement);
                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : area;
                        console.log('Superficie arrondissement calculée:', areaText);

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                    console.log('Tentative de connexion:', { email, password });
                    console.log('Identifiants attendus:', CONFIG.adminCredentials);
                    
                                <h4 style="color: #8B008B; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${arrondissement.nom_arrondissement}
                                </h4>
                                <p><strong>Type:</strong> Arrondissement</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                    // Vérification insensible à la casse et aux espaces
                    const emailMatch = email.toLowerCase() === CONFIG.adminCredentials.email.toLowerCase();
                    const passwordMatch = password === CONFIG.adminCredentials.password;
                    
                    console.log('Vérifications:', { emailMatch, passwordMatch });
                    
                    if (emailMatch && passwordMatch) {
                        `);

                        layer.on('click', function() {
                            layer.openPopup();
                        console.log('Connexion admin réussie');
                        });
                    } else {
                        console.log('Échec de connexion - identifiants incorrects');
                        console.warn('Pas de géométrie pour arrondissement:', arrondissement.nom_arrondissement);
                    }
                });
                
                console.log(`✅ ${data.length} arrondissements chargés avec superficies`);
            } catch (error) {
                console.error('Erreur arrondissements:', error);
                throw error;
            }
        }

        // =================================================================
        // OUTILS DE MESURE
        // =================================================================

        function startDistanceMeasurement() {
            clearActiveMeasurements();
            
            const button = document.getElementById('measureDistance');
            if (isDistanceMeasuring) {
                stopDistanceMeasurement();
                return;
            }

            isDistanceMeasuring = true;
            button.classList.add('active');
            
            showNotification('Cliquez sur deux points pour mesurer la distance', 'info');
            
            disableAdministrativeLayers();
            
            map.on('click', onDistanceClick);
            map.getContainer().style.cursor = 'crosshair';
        }

        function stopDistanceMeasurement() {
            isDistanceMeasuring = false;
            document.getElementById('measureDistance').classList.remove('active');
            map.off('click', onDistanceClick);
            map.getContainer().style.cursor = '';
            
            enableAdministrativeLayers();
            
            if (distanceMarkers.length === 1) {
                map.removeLayer(distanceMarkers[0]);
                distanceMarkers = [];
            }
        }

        function onDistanceClick(e) {
            if (!isDistanceMeasuring) return;

            L.DomEvent.stopPropagation(e);

            const marker = L.circleMarker(e.latlng, {
                radius: 6,
                color: '#ff4757',
                fillColor: '#ff4757',
                fillOpacity: 1,
                weight: 2
            }).addTo(measurementLayer);

            distanceMarkers.push(marker);

            if (distanceMarkers.length === 2) {
                const distance = calculateDistance(
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                );

                const line = L.polyline([
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                ], {
                    color: '#ff4757',
                    weight: 3,
                    dashArray: '8, 12'
                }).addTo(measurementLayer);

                measurementLines.push(line);

                const midPoint = L.latLngBounds([
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                ]).getCenter();

                L.popup({
                    closeButton: true,
                    autoClose: false,
                    className: 'measurement-tooltip'
                })
                .setLatLng(midPoint)
                .setContent(`<strong>Distance: ${formatDistance(distance)}</strong>`)
                .openOn(map);

                showNotification(`Distance: ${formatDistance(distance)}`, 'success');
                stopDistanceMeasurement();
            }
        }

        function startAreaMeasurement() {
            clearActiveMeasurements();
            
            const button = document.getElementById('measureArea');
            if (isAreaMeasuring) {
                stopAreaMeasurement();
                return;
            }

            isAreaMeasuring = true;
            button.classList.add('active');
            polygonPoints = [];
            
            showNotification('Cliquez pour dessiner un polygone. Double-clic pour terminer.', 'info');
            
            disableAdministrativeLayers();
            
            map.on('click', onPolygonClick);
            map.on('dblclick', onPolygonFinish);
            map.on('mousemove', onPolygonMouseMove);
            map.getContainer().style.cursor = 'crosshair';
        }

        function stopAreaMeasurement() {
            isAreaMeasuring = false;
            document.getElementById('measureArea').classList.remove('active');
            
            map.off('click', onPolygonClick);
            map.off('dblclick', onPolygonFinish);
            map.off('mousemove', onPolygonMouseMove);
            map.getContainer().style.cursor = '';
            
            enableAdministrativeLayers();
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
        }

        function onPolygonClick(e) {
            if (!isAreaMeasuring) return;
            
            L.DomEvent.stopPropagation(e);
            
            polygonPoints.push(e.latlng);
            
            const marker = L.circleMarker(e.latlng, {
                radius: 5,
                color: '#4CAF50',
                fillColor: '#4CAF50',
                fillOpacity: 1,
                weight: 2
            }).addTo(measurementLayer);
            
            measurementPolygons.push(marker);
            
            if (polygonPoints.length >= 2) {
                if (tempPolygon) {
                    map.removeLayer(tempPolygon);
                }
                
                tempPolygon = L.polyline(polygonPoints, {
                    color: '#4CAF50',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 10'
                }).addTo(map);
            }
        }

        function onPolygonFinish(e) {
            if (!isAreaMeasuring || polygonPoints.length < 3) return;
            
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
            
            const finalPolygon = L.polygon(polygonPoints, {
                color: '#4CAF50',
                weight: 3,
                fillColor: '#4CAF50',
                fillOpacity: 0.2
            }).addTo(measurementLayer);
            
            measurementPolygons.push(finalPolygon);
            
            const area = calculatePolygonArea(polygonPoints);
            const center = finalPolygon.getBounds().getCenter();
            
            L.popup({
                closeButton: true,
                autoClose: false,
                className: 'measurement-tooltip'
            })
            .setLatLng(center)
            .setContent(`<strong>Surface: ${formatArea(area)}</strong>`)
            .openOn(map);

            showNotification(`Surface: ${formatArea(area)}`, 'success');
            
            stopAreaMeasurement();
        }

        function onPolygonMouseMove(e) {
            if (!isAreaMeasuring || polygonPoints.length === 0) return;
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
            }
            
            const tempPoints = [...polygonPoints, e.latlng];
            tempPolygon = L.polyline(tempPoints, {
                color: '#4CAF50',
                weight: 2,
                opacity: 0.5,
                dashArray: '5, 10'
            }).addTo(map);
        }

        // =================================================================
        // AUTRES FONCTIONS
        // =================================================================

        function printMap() {
            showNotification('Fonctionnalité d\'impression en développement', 'info');
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>MonVillage - Impression</title>
                    <style>
                        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .map-print { width: 100%; height: 80vh; border: 1px solid #ccc; background: #f9f9f9; display: flex; align-items: center; justify-content: center; }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MonVillage - Cartographie du Cameroun</h1>
                        <p>Date: ${new Date().toLocaleDateString('fr-FR')}</p>
                    </div>
                    <div class="map-print">
                        <p>Capture de carte sera disponible prochainement</p>
                    </div>
                    <div class="footer">
                        <p>© 2024 MonVillage - monvillage.cm@gmail.com - +237 697 182 925</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 500);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth <= 768) {
                if (sidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    sidebar.classList.add('open');
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleSatelliteView() {
            const button = document.getElementById('toggleSatellite');
            if (currentBaseLayer === 'standard') {
                map.removeLayer(baseLayers.standard);
                map.addLayer(baseLayers.satellite);
                currentBaseLayer = 'satellite';
                button.classList.add('active');
            } else {
                map.removeLayer(baseLayers.satellite);
                map.addLayer(baseLayers.standard);
                currentBaseLayer = 'standard';
                button.classList.remove('active');
            }
        }

        // =================================================================
        // GESTION DES ÉVÉNEMENTS
        // =================================================================

        function initializeEventListeners() {
            console.log('🎯 Initialisation des événements');
            
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            document.getElementById('zoomHome').addEventListener('click', () => map.setView(CONFIG.map.center, CONFIG.map.zoom));
            document.getElementById('toggleSatellite').addEventListener('click', toggleSatelliteView);
            
            document.getElementById('measureDistance').addEventListener('click', startDistanceMeasurement);
            document.getElementById('measureArea').addEventListener('click', startAreaMeasurement);
            document.getElementById('clearMeasurements').addEventListener('click', clearAllMeasurements);
            document.getElementById('printMap').addEventListener('click', printMap);

            document.querySelectorAll('.layer-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const layer = this.dataset.layer;
                    if (mapLayers[layer]) {
                        if (map.hasLayer(mapLayers[layer])) {
                            map.removeLayer(mapLayers[layer]);
                        } else {
                            map.addLayer(mapLayers[layer]);
                        }
                    }
                });
            });

            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    startDistanceMeasurement();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    startAreaMeasurement();
                } else if (e.key === 'Escape') {
                    clearActiveMeasurements();
                }
            });
            
            console.log('✅ Événements initialisés');
        }

        // =================================================================
        // ADMINISTRATION
        // =================================================================

        window.checkAdminAccess = function() {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
                        <h3 style="margin-bottom: 20px; color: #2c5530;">Accès Administrateur</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Email:</label>
                            <input type="email" id="adminEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="admin@monvillage.cm">
                        </div>
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mot de passe:</label>
                            <input type="password" id="adminPassword" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="text-align: center;">
                            <button onclick="processAdminLogin()" style="background: #4a7c59; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Se connecter</button>
                            <button onclick="closeAdminModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Annuler</button>
                        </div>
                    </div>
                </div>
            `;
            modal.id = 'adminModal';
            document.body.appendChild(modal);
        };

        window.processAdminLogin = function() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            
            if (email && password) {
                showNotification('Connexion admin simulée réussie', 'success');
                enableAdminFeatures({ name: 'Admin Demo', role: 'admin' });
                closeAdminModal();
            } else {
                showNotification('Veuillez saisir email et mot de passe', 'warning');
            }
        };

        window.closeAdminModal = function() {
            const modal = document.getElementById('adminModal');
            if (modal) modal.remove();
        };

        function enableAdminFeatures(profile) {
            const adminAccess = document.querySelector('.admin-access');
            adminAccess.innerHTML = `<i class="fas fa-user-shield"></i><span>${profile.name}</span>`;
            
            showNotification(`Bienvenue ${profile.name}. Mode admin activé.`, 'success');
        }

        // =================================================================
        // INITIALISATION PRINCIPALE
        // =================================================================

        document.addEventListener('DOMContentLoaded', function() {
            console.log('📋 Initialisation du DOM');
            initializeSupabase();
            initializeMap();
            initializeNativeMeasurementTools();
            initializeEventListeners();
            loadInitialData();
        });

        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        console.log('✅ MonVillage initialisé - Version Finale');
        console.log('🎮 Raccourcis: Ctrl+D (distance), Ctrl+S (surface), Escape (annuler)');
    </script>
</body>
</html>