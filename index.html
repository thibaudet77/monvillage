<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonVillage - Cartographie des Villages du Cameroun</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; background: #1a1a1a; color: #333; }
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        /* Header */
        .header { background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; padding: 8px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); z-index: 1000; position: relative; }
        .header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1400px; margin: 0 auto; height: 50px; }
        .logo-section { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .logo { width: 32px; height: 32px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .app-title { font-size: 20px; font-weight: bold; margin: 0; line-height: 1; }
        .search-container { position: relative; flex: 1; max-width: 450px; margin: 0 20px; }
        .search-input { width: 100%; padding: 8px 35px 8px 12px; border: none; border-radius: 20px; font-size: 13px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); height: 34px; }
        .search-btn { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); background: #4a7c59; border: none; color: white; padding: 6px 10px; border-radius: 50%; cursor: pointer; width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .admin-access { color: rgba(255,255,255,0.9); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: 15px; transition: background 0.2s; height: 34px; flex-shrink: 0; }
        .admin-access:hover { background: rgba(255,255,255,0.1); }

        /* Main Content */
        .main-content { display: flex; flex: 1; overflow: hidden; position: relative; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999; backdrop-filter: blur(2px); opacity: 0; transition: opacity 0.3s ease; }
        .sidebar-overlay.active { display: block; opacity: 1; }
        .sidebar { width: 300px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); box-shadow: 2px 0 10px rgba(0,0,0,0.1); transition: transform 0.3s ease; z-index: 1000; overflow-y: auto; position: relative; }
        .sidebar.collapsed { transform: translateX(-280px); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #e0e0e0; background: #f8f9fa; position: relative; }
        .sidebar-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #2c5530; }
        .sidebar-close-btn { background: none; border: none; font-size: 18px; color: #666; cursor: pointer; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: none; align-items: center; justify-content: center; transition: all 0.2s; position: absolute; top: 15px; right: 15px; }
        .sidebar-close-btn:hover { background: #e0e0e0; color: #333; }
        .layer-controls { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .layer-control-item { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .layer-toggle { position: relative; width: 50px; height: 25px; background: #ccc; border-radius: 25px; cursor: pointer; transition: background 0.2s; }
        .layer-toggle.active { background: #4a7c59; }
        .layer-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 21px; height: 21px; background: white; border-radius: 50%; transition: transform 0.2s; }
        .layer-toggle.active::after { transform: translateX(25px); }
        .legend-section { padding: 15px 20px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 12px; padding: 8px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .legend-item:hover { background: #f0f0f0; }
        .legend-symbol { width: 20px; height: 20px; margin-right: 10px; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .legend-label { font-size: 14px; color: #333; }

        /* Map Container */
        .map-container { flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        .toolbar { position: absolute; top: 70px; right: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 600; padding: 10px; display: flex; flex-direction: column; gap: 10px; }
        .tool-btn { background: none; border: none; padding: 10px; border-radius: 10px; cursor: pointer; font-size: 16px; color: #666; transition: all 0.2s; min-width: 40px; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .tool-btn:hover { background: #f0f0f0; color: #333; }
        .tool-btn.active { background: #4a7c59; color: white; }
        .toggle-sidebar { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 18px; cursor: pointer; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 600; color: #4a7c59; transition: all 0.2s ease; }
        .toggle-sidebar:hover { background: rgba(255,255,255,1); transform: scale(1.05); }

        /* Locate Button */
        .locate-btn { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; width: 32px; height: 32px; font-size: 14px; cursor: pointer; box-shadow: 0 1px 4px rgba(0,0,0,0.15); z-index: 600; color: #666; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; }
        .locate-btn:hover { background: rgba(255,255,255,1); color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .locate-btn.locating { background: #007bff; color: white; animation: pulse-button 1s infinite; }
        .locate-btn.located { background: #007bff; color: white; }

        /* Print Area Selection */
        .print-area-selector { border: 3px dashed #007bff; background: rgba(0, 123, 255, 0.1); cursor: move; }
        .print-area-handle { width: 12px; height: 12px; background: #007bff; border: 2px solid white; border-radius: 50%; position: absolute; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .print-area-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .print-area-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .print-area-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .print-area-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
        .print-area-info { position: absolute; top: -30px; left: 0; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; }

        /* Notification System */
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10000; transform: translateX(400px); transition: transform 0.3s ease; max-width: 350px; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #4CAF50; color: white; }
        .notification.error { background: #F44336; color: white; }
        .notification.warning { background: #FF9800; color: white; }
        .notification.info { background: #2196F3; color: white; }

        /* Village Detail Modal Styles */
        .village-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; backdrop-filter: blur(3px); }
        .village-modal.active { display: flex; align-items: center; justify-content: center; }
        .village-modal-content { background: white; border-radius: 15px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .village-modal-header { padding: 20px 30px; border-bottom: 1px solid #e0e0e0; background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; border-radius: 15px 15px 0 0; position: relative; }
        .village-modal-title { font-size: 28px; font-weight: bold; margin: 0; margin-bottom: 10px; }
        .village-modal-subtitle { font-size: 16px; opacity: 0.9; margin: 0; }
        .village-modal-close { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; transition: background 0.2s; }
        .village-modal-close:hover { background: rgba(255,255,255,0.3); }
        .village-modal-body { padding: 0; }

        .village-hero { background: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #e0e0e0; }
        .village-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .village-info-item { background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0; }
        .village-info-label { font-weight: bold; color: #2c5530; margin-bottom: 5px; font-size: 12px; text-transform: uppercase; }
        .village-info-value { color: #333; }

        .village-photos { margin-bottom: 20px; }
        .village-photos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .village-photo { border-radius: 8px; overflow: hidden; aspect-ratio: 1; position: relative; }
        .village-photo img { width: 100%; height: 100%; object-fit: cover; }
        .village-photo-caption { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); color: white; padding: 10px; font-size: 12px; }

        .village-description { padding: 30px; }
        .description-section { margin-bottom: 30px; }
        .description-title { font-size: 18px; font-weight: bold; color: #2c5530; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0; }
        .description-content { color: #333; line-height: 1.6; white-space: pre-wrap; }
        .description-empty { color: #999; font-style: italic; }

        .village-tabs { display: flex; border-bottom: 1px solid #e0e0e0; background: #f8f9fa; }
        .village-tab { padding: 15px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 500; transition: all 0.2s; }
        .village-tab:hover { background: #e9ecef; }
        .village-tab.active { border-bottom-color: #4a7c59; background: white; color: #4a7c59; }
        .village-tab-content { display: none; }
        .village-tab-content.active { display: block; }

        /* Print Modal Styles */
        .print-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10001; backdrop-filter: blur(3px); }
        .print-modal.active { display: flex; align-items: center; justify-content: center; }
        .print-modal-content { background: white; border-radius: 15px; max-width: 1100px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .print-modal-header { padding: 20px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 15px 15px 0 0; }
        .print-modal-title { font-size: 24px; font-weight: bold; color: #2c5530; margin: 0; }
        .print-modal-close { background: none; border: none; font-size: 24px; color: #666; cursor: pointer; padding: 5px; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .print-modal-close:hover { background: #e0e0e0; }
        .print-modal-body { padding: 30px; }
        
        .print-config { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .print-preview { background: #f8f9fa; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: #4a7c59; }
        
        .format-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; }
        .format-option { border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.2s; background: white; }
        .format-option:hover { border-color: #4a7c59; background: #f0f8f1; }
        .format-option.selected { border-color: #4a7c59; background: #4a7c59; color: white; }
        .format-size { font-weight: bold; margin-bottom: 5px; }
        .format-price { font-size: 12px; opacity: 0.8; }
        
        .scale-input-group { display: flex; align-items: center; gap: 10px; }
        .scale-input { flex: 1; }
        .scale-preset { background: #f0f0f0; border: 1px solid #ccc; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; }
        .scale-preset:hover { background: #e0e0e0; }
        
        /* Enhanced Preview Container */
        .preview-container { width: 350px; height: 450px; border: 2px solid #ddd; border-radius: 8px; background: white; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .preview-header { background: #f8f9fa; padding: 8px; text-align: center; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd; }
        .preview-map { width: 100%; height: 350px; position: relative; overflow: hidden; }
        .preview-map-canvas { width: 100%; height: 100%; border: none; }
        .preview-footer { padding: 8px; background: #f8f9fa; text-align: center; font-size: 10px; border-top: 1px solid #ddd; }
        .preview-north-arrow { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; z-index: 10; }
        .preview-scale { position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 4px 8px; border-radius: 4px; font-size: 10px; z-index: 10; }

        .print-area-controls { margin-bottom: 20px; text-align: center; }
        .area-select-btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 0 10px; font-size: 14px; font-weight: 600; }
        .area-select-btn:hover { background: #0056b3; }
        .area-select-btn.active { background: #28a745; }
        
        .print-summary { background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .summary-label { font-weight: 600; }
        .summary-value { color: #4a7c59; font-weight: bold; }
        .total-price { font-size: 18px; color: #2c5530; }
        
        .print-actions { display: flex; gap: 15px; justify-content: center; margin-top: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 120px; }
        .btn-primary { background: #4a7c59; color: white; }
        .btn-primary:hover { background: #3d6249; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        
        /* Enhanced Payment Modal */
        .payment-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10002; }
        .payment-modal.active { display: flex; align-items: center; justify-content: center; }
        .payment-content { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; text-align: center; }
        .payment-title { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: #2c5530; }
        .payment-amount { font-size: 28px; color: #4a7c59; font-weight: bold; margin-bottom: 20px; }
        .payment-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left; }
        .payment-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .payment-method { border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; text-align: center; }
        .payment-method:hover { border-color: #4a7c59; background: #f0f8f1; }
        .payment-method.selected { border-color: #4a7c59; background: #4a7c59; color: white; }
        .payment-method-icon { font-size: 24px; margin-bottom: 8px; }
        .payment-method-name { font-weight: bold; margin-bottom: 4px; }
        .payment-method-desc { font-size: 12px; opacity: 0.8; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4a7c59; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Loading overlay */
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; align-items: center; justify-content: center; }
        .loading-overlay.active { display: flex; }
        .loading-content { background: white; padding: 40px; border-radius: 15px; text-align: center; }

        /* Geolocation styles */
        .user-location-marker { 
            background: #007bff; 
            border: 3px solid white; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
            animation: pulse-location 2s infinite;
        }
        
        .user-location-accuracy { 
            border: 2px solid rgba(0, 123, 255, 0.3); 
            background: rgba(0, 123, 255, 0.1); 
        }

        @keyframes pulse-location {
            0% { box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 123, 255, 0.8); }
            100% { box-shadow: 0 0 10px rgba(0, 123, 255, 0.5); }
        }

        .tool-btn.locating {
            background: #007bff !important;
            color: white !important;
            animation: pulse-button 1s infinite;
        }

        @keyframes pulse-button {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Measurement styles */
        .measurement-tooltip { background: rgba(0,0,0,0.8); color: white; padding: 8px 12px; border-radius: 5px; font-size: 13px; white-space: nowrap; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* Footer */
        .footer { background: #2c5530; color: white; padding: 15px 20px; text-align: center; font-size: 14px; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .contact-info { display: flex; gap: 20px; align-items: center; }
        .contact-item { display: flex; align-items: center; gap: 5px; }

        /* Styles pour la barre de recherche intelligente */
        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .search-result-badge {
            background: #4a7c59;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }

        .search-result-details {
            font-size: 12px;
            color: #666;
        }

        .search-result-chief, .search-result-location {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 2px;
        }

        .search-result-chief i, .search-result-location i {
            width: 12px;
            text-align: center;
        }

        mark {
            background-color: #ffeb3b;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Amélioration de l'input de recherche */
        .search-container {
            position: relative;
        }

        .search-input:focus {
            outline: none;
            border-color: #4a7c59;
            box-shadow: 0 0 0 2px rgba(74, 124, 89, 0.1);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content { flex-direction: row; gap: 8px; padding: 4px 8px; height: 45px; justify-content: space-between; }
            .logo { width: 28px; height: 28px; font-size: 12px; }
            .app-title { font-size: 14px; }
            .search-container { flex: 1; margin: 0 10px; }
            .search-input { height: 32px; font-size: 12px; padding: 6px 30px 6px 10px; }
            .search-btn { width: 24px; height: 24px; font-size: 11px; }
            .admin-access { font-size: 11px; height: 32px; padding: 6px 8px; gap: 4px; }
            .admin-access span { display: none; }
            .sidebar { position: fixed; top: 0; left: 0; height: 100vh; z-index: 1000; transform: translateX(-100%); width: 280px; }
            .sidebar.open { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); }
            .sidebar-close-btn { display: flex !important; }
            .sidebar-header { padding-top: 25px; }
            .toolbar { flex-direction: row; top: auto; bottom: 20px; right: 30px; left: 30px; justify-content: center; max-width: calc(100% - 80px); }
            .footer-content { flex-direction: column; gap: 10px; text-align: center; }
            .contact-info { flex-direction: column; gap: 10px; }
            .print-config { grid-template-columns: 1fr; gap: 20px; }
            .format-grid { grid-template-columns: repeat(3, 1fr); }
            .locate-btn { top: 15px; right: 15px; width: 36px; height: 36px; font-size: 16px; }
            .village-info-grid { grid-template-columns: 1fr; }
            .payment-methods { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo"><i class="fas fa-map-marked-alt"></i></div>
                    <h1 class="app-title">MonVillage</h1>
                </div>
                <div class="search-container">
                    <input type="text" class="search-input" placeholder="Rechercher un village ou un chef..." id="searchInput">
                    <button class="search-btn" id="searchBtn"><i class="fas fa-search"></i></button>
                    <div class="search-results-container" id="searchResults"></div>
                </div>
                <div class="admin-access" onclick="checkAdminAccess()">
                    <i class="fas fa-cog"></i>
                    <span>Admin</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <div class="sidebar-overlay" id="sidebarOverlay"></div>
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <button class="sidebar-close-btn" id="closeSidebar"><i class="fas fa-times"></i></button>
                    <div><h3 class="sidebar-title">Légende</h3><p>Couches cartographiques</p></div>
                </div>
                <div class="layer-controls">
                    <div class="layer-control-item"><span>Régions</span><div class="layer-toggle active" data-layer="regions"></div></div>
                    <div class="layer-control-item"><span>Départements</span><div class="layer-toggle active" data-layer="departements"></div></div>
                    <div class="layer-control-item"><span>Arrondissements</span><div class="layer-toggle active" data-layer="arrondissements"></div></div>
                    <div class="layer-control-item"><span>Villages</span><div class="layer-toggle active" data-layer="villages"></div></div>
                    <div class="layer-control-item"><span>Points d'intérêt</span><div class="layer-toggle active" data-layer="poi"></div></div>
                    <div class="layer-control-item"><span>Géonymes</span><div class="layer-toggle active" data-layer="geonames"></div></div>
                </div>
                <div class="legend-section">
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 3px solid #d62728;"></div><span class="legend-label">Régions</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px solid #000000;"></div><span class="legend-label">Départements</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px dashed #8B008B;"></div><span class="legend-label">Arrondissements</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: transparent; border: 2px dashed #cc6600;"></div><span class="legend-label">Villages</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FFD700;"><i class="fas fa-crown" style="font-size: 10px; color: #333;"></i></div><span class="legend-label">Chefferie 1er degré</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FFA500;"><i class="fas fa-crown" style="font-size: 10px; color: #333;"></i></div><span class="legend-label">Chefferie 2ème degré</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #FF6347;"><i class="fas fa-crown" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Chefferie 3ème degré</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #4CAF50;"><i class="fas fa-school" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Écoles</span></div>
                    <div class="legend-item"><div class="legend-symbol" style="background: #F44336;"><i class="fas fa-hospital" style="font-size: 10px; color: white;"></i></div><span class="legend-label">Centres de santé</span></div>
                </div>
            </aside>

            <!-- Map Container -->
            <div class="map-container">
                <button class="toggle-sidebar" id="toggleSidebar"><i class="fas fa-bars"></i></button>
                <div class="toolbar">
                    <button class="tool-btn" id="measureDistance" title="Mesurer une distance"><i class="fas fa-ruler"></i></button>
                    <button class="tool-btn" id="measureArea" title="Mesurer une surface"><i class="fas fa-draw-polygon"></i></button>
                    <button class="tool-btn" id="clearMeasurements" title="Effacer les mesures"><i class="fas fa-eraser"></i></button>
                    <button class="tool-btn" id="printMap" title="Imprimer la carte"><i class="fas fa-print"></i></button>
                    <button class="tool-btn" id="zoomHome" title="Vue d'ensemble"><i class="fas fa-home"></i></button>
                    <button class="tool-btn" id="toggleSatellite" title="Vue satellite"><i class="fas fa-satellite"></i></button>
                </div>
                <button class="locate-btn" id="locateUser" title="Ma position"><i class="fas fa-crosshairs"></i></button>
                <div id="map"></div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="contact-info">
                    <div class="contact-item"><i class="fas fa-envelope"></i><span>monvillage.cm@gmail.com</span></div>
                    <div class="contact-item"><i class="fas fa-phone"></i><span>+237 697 182 925</span></div>
                </div>
                <div>© 2024 MonVillage - Cartographie des Villages du Cameroun</div>
            </div>
        </footer>

        <!-- Village Detail Modal -->
        <div id="villageModal" class="village-modal">
            <div class="village-modal-content">
                <div class="village-modal-header">
                    <button class="village-modal-close" id="closeVillageModal"><i class="fas fa-times"></i></button>
                    <h2 class="village-modal-title" id="villageModalTitle">Nom du Village</h2>
                    <p class="village-modal-subtitle" id="villageModalSubtitle">Arrondissement</p>
                </div>
                
                <div class="village-hero">
                    <div class="village-info-grid">
                        <div class="village-info-item">
                            <div class="village-info-label"><i class="fas fa-user-tie"></i> Chef de Village</div>
                            <div class="village-info-value" id="villageChiefName">Non renseigné</div>
                        </div>
                        <div class="village-info-item">
                            <div class="village-info-label"><i class="fas fa-calendar-alt"></i> Date de Prise de Service</div>
                            <div class="village-info-value" id="villageChiefStartDate">Non renseignée</div>
                        </div>
                        <div class="village-info-item">
                            <div class="village-info-label"><i class="fas fa-phone"></i> Téléphone</div>
                            <div class="village-info-value" id="villageTelephone">Non disponible</div>
                        </div>
                        <div class="village-info-item">
                            <div class="village-info-label"><i class="fas fa-envelope"></i> Email</div>
                            <div class="village-info-value" id="villageEmail">Non disponible</div>
                        </div>
                        <div class="village-info-item">
                            <div class="village-info-label"><i class="fas fa-expand-arrows-alt"></i> Superficie</div>
                            <div class="village-info-value" id="villageArea">Non calculée</div>
                        </div>
                        <div class="village-info-item">
                            <div class="village-info-label"><i class="fas fa-users"></i> Population Estimée</div>
                            <div class="village-info-value" id="villagePopulation">Non renseignée</div>
                        </div>
                    </div>
                    
                    <div class="village-photos" id="villagePhotosSection" style="display: none;">
                        <h3 style="color: #2c5530; margin-bottom: 15px;"><i class="fas fa-images"></i> Photos</h3>
                        <div class="village-photos-grid" id="villagePhotosGrid"></div>
                    </div>
                </div>

                <div class="village-tabs">
                    <div class="village-tab active" onclick="switchTab('info')">Informations</div>
                    <div class="village-tab" onclick="switchTab('description')" id="descriptionTab" style="display: none;">Description Complète</div>
                </div>

                <div class="village-modal-body">
                    <div id="infoTabContent" class="village-tab-content active">
                        <div class="village-description">
                            <div class="description-section">
                                <div class="description-title">Informations Générales</div>
                                <div class="description-content">
                                    Ce village fait partie de l'arrondissement <span id="villageArrondissementInfo"></span>. 
                                    <span id="villageBasicInfo"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="descriptionTabContent" class="village-tab-content">
                        <div class="village-description">
                            <!-- Présentation générale -->
                            <div class="description-section" id="presentationSection" style="display: none;">
                                <div class="description-title">1. Présentation Générale</div>
                                <div class="description-subsection" id="histoireOrigineSec" style="display: none;">
                                    <h4>Histoire et Origine</h4>
                                    <div class="description-content" id="histoireOrigineContent"></div>
                                </div>
                                <div class="description-subsection" id="limitesSection" style="display: none;">
                                    <h4>Description des Limites</h4>
                                    <div class="description-content" id="limitesContent"></div>
                                </div>
                                <div class="description-subsection" id="importanceSection" style="display: none;">
                                    <h4>Importance dans la Région</h4>
                                    <div class="description-content" id="importanceContent"></div>
                                </div>
                            </div>

                            <!-- Culture & Traditions -->
                            <div class="description-section" id="cultureSection" style="display: none;">
                                <div class="description-title">2. Culture & Traditions</div>
                                <div class="description-subsection" id="dansesSection" style="display: none;">
                                    <h4>Danses, Musiques et Rites</h4>
                                    <div class="description-content" id="dansesContent"></div>
                                </div>
                                <div class="description-subsection" id="gastronomieSection" style="display: none;">
                                    <h4>Gastronomie Locale</h4>
                                    <div class="description-content" id="gastronomieContent"></div>
                                </div>
                                <div class="description-subsection" id="fetesSection" style="display: none;">
                                    <h4>Fêtes Traditionnelles</h4>
                                    <div class="description-content" id="fetesContent"></div>
                                </div>
                            </div>

                            <!-- Population -->
                            <div class="description-section" id="populationSection" style="display: none;">
                                <div class="description-title">3. Population</div>
                                <div class="description-subsection" id="demographieSection" style="display: none;">
                                    <h4>Structure Démographique</h4>
                                    <div class="description-content" id="demographieContent"></div>
                                </div>
                                <div class="description-subsection" id="ethniesSection" style="display: none;">
                                    <h4>Groupes Ethniques</h4>
                                    <div class="description-content" id="ethniesContent"></div>
                                </div>
                            </div>

                            <!-- Économie -->
                            <div class="description-section" id="economieSection" style="display: none;">
                                <div class="description-title">4. Économie Locale</div>
                                <div class="description-subsection" id="activitesSection" style="display: none;">
                                    <h4>Activités Génératrices de Revenus</h4>
                                    <div class="description-content" id="activitesContent"></div>
                                </div>
                                <div class="description-subsection" id="produitsSection" style="display: none;">
                                    <h4>Produits du Terroir</h4>
                                    <div class="description-content" id="produitsContent"></div>
                                </div>
                            </div>

                            <!-- Infrastructures -->
                            <div class="description-section" id="infrastructuresSection" style="display: none;">
                                <div class="description-title">5. Infrastructures</div>
                                <div class="description-subsection" id="ecolesSection" style="display: none;">
                                    <h4>Établissements Scolaires</h4>
                                    <div class="description-content" id="ecolesContent"></div>
                                </div>
                                <div class="description-subsection" id="santeSection" style="display: none;">
                                    <h4>Centres de Santé</h4>
                                    <div class="description-content" id="santeContent"></div>
                                </div>
                                <div class="description-subsection" id="routesSection" style="display: none;">
                                    <h4>Routes et Transport</h4>
                                    <div class="description-content" id="routesContent"></div>
                                </div>
                                <div class="description-subsection" id="servicesSection" style="display: none;">
                                    <h4>Électricité et Eau</h4>
                                    <div class="description-content" id="servicesContent"></div>
                                </div>
                            </div>

                            <!-- Tourisme -->
                            <div class="description-section" id="tourismeSection" style="display: none;">
                                <div class="description-title">6. Tourisme & Attractions</div>
                                <div class="description-subsection" id="sitesNaturelsSection" style="display: none;">
                                    <h4>Sites Naturels</h4>
                                    <div class="description-content" id="sitesNaturelsContent"></div>
                                </div>
                                <div class="description-subsection" id="sitesCulturelsSection" style="display: none;">
                                    <h4>Sites Culturels</h4>
                                    <div class="description-content" id="sitesCulturelsContent"></div>
                                </div>
                            </div>

                            <!-- Personnalités -->
                            <div class="description-section" id="personnalitesSection" style="display: none;">
                                <div class="description-title">7. Personnalités</div>
                                <div class="description-subsection" id="personnalitesOriginairesSection" style="display: none;">
                                    <h4>Personnalités Originaires</h4>
                                    <div class="description-content" id="personnalitesOriginairesContent"></div>
                                </div>
                            </div>

                            <div id="noDescriptionMessage" class="description-section">
                                <div class="description-content description-empty">
                                    <i class="fas fa-info-circle"></i> Aucune description détaillée n'est disponible pour ce village pour le moment.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Print Modal -->
        <div id="printModal" class="print-modal">
            <div class="print-modal-content">
                <div class="print-modal-header">
                    <h2 class="print-modal-title"><i class="fas fa-print"></i> Exporter la Carte</h2>
                    <button class="print-modal-close" id="closePrintModal"><i class="fas fa-times"></i></button>
                </div>
                <div class="print-modal-body">
                    <!-- Print Area Selection Controls -->
                    <div class="print-area-controls">
                        <h4 style="margin-bottom: 15px; color: #2c5530;">Sélection de la zone à imprimer</h4>
                        <button class="area-select-btn" id="selectPrintArea">📐 Sélectionner une zone</button>
                        <button class="area-select-btn" id="useCurrentView">🗺️ Utiliser la vue actuelle</button>
                        <button class="area-select-btn" id="clearPrintArea">❌ Effacer la sélection</button>
                    </div>
                    
                    <div class="print-config">
                        <div class="print-options">
                            <div class="form-group">
                                <label class="form-label">Titre de la carte</label>
                                <input type="text" class="form-input" id="mapTitle" placeholder="Carte des Villages - MonVillage" value="Carte des Villages - MonVillage">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Format de sortie</label>
                                <select class="form-select" id="outputFormat">
                                    <option value="pdf">PDF (recommandé)</option>
                                    <option value="png">PNG (image)</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Taille du papier</label>
                                <div class="format-grid">
                                    <div class="format-option" data-format="A4" data-price="500">
                                        <div class="format-size">A4</div>
                                        <div class="format-price">500 XAF</div>
                                    </div>
                                    <div class="format-option" data-format="A3" data-price="1000">
                                        <div class="format-size">A3</div>
                                        <div class="format-price">1000 XAF</div>
                                    </div>
                                    <div class="format-option selected" data-format="A2" data-price="2000">
                                        <div class="format-size">A2</div>
                                        <div class="format-price">2000 XAF</div>
                                    </div>
                                    <div class="format-option" data-format="A1" data-price="4000">
                                        <div class="format-size">A1</div>
                                        <div class="format-price">4000 XAF</div>
                                    </div>
                                    <div class="format-option" data-format="A0" data-price="6000">
                                        <div class="format-size">A0</div>
                                        <div class="format-price">6000 XAF</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Échelle numérique</label>
                                <div class="scale-input-group">
                                    <span>1:</span>
                                    <input type="number" class="form-input scale-input" id="mapScale" value="50000" min="1000" max="10000000">
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                    <span class="scale-preset" data-scale="25000">1:25,000</span>
                                    <span class="scale-preset" data-scale="50000">1:50,000</span>
                                    <span class="scale-preset" data-scale="100000">1:100,000</span>
                                    <span class="scale-preset" data-scale="250000">1:250,000</span>
                                    <span class="scale-preset" data-scale="500000">1:500,000</span>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Options d'affichage</label>
                                <label><input type="checkbox" id="showNorthArrow" checked> Flèche Nord</label><br>
                                <label><input type="checkbox" id="showScale" checked> Échelle graphique</label><br>
                                <label><input type="checkbox" id="showLegend" checked> Légende</label><br>
                                <label><input type="checkbox" id="showCoordinates" checked> Coordonnées</label>
                            </div>
                        </div>
                        
                        <div class="print-preview">
                            <h4 style="margin-bottom: 15px; color: #2c5530;">Aperçu de l'exportation</h4>
                            <div class="preview-container" id="previewContainer">
                                <div class="preview-header" id="previewTitle">Carte des Villages - MonVillage</div>
                                <div class="preview-map">
                                    <div id="previewMap" class="preview-map-canvas"></div>
                                    <div class="preview-north-arrow" id="previewNorthArrow">⇑</div>
                                    <div class="preview-scale" id="previewScale">1:50,000</div>
                                </div>
                                <div class="preview-footer">
                                    Format: <span id="previewFormat">A2</span> | 
                                    <span id="previewDate"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-summary">
                        <div class="summary-row">
                            <span class="summary-label">Format sélectionné:</span>
                            <span class="summary-value" id="summaryFormat">A2</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Type de fichier:</span>
                            <span class="summary-value" id="summaryFileType">PDF</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Échelle:</span>
                            <span class="summary-value" id="summaryScale">1:50,000</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">Zone sélectionnée:</span>
                            <span class="summary-value" id="summaryArea">Vue actuelle</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label total-price">Prix total:</span>
                            <span class="summary-value total-price" id="summaryPrice">2,000 XAF</span>
                        </div>
                    </div>
                    
                    <div class="print-actions">
                        <button class="btn btn-secondary" id="cancelPrint">Annuler</button>
                        <button class="btn btn-primary" id="proceedToPay">Payer et Exporter</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Payment Modal -->
        <div id="paymentModal" class="payment-modal">
            <div class="payment-content">
                <h3 class="payment-title">💳 Paiement sécurisé</h3>
                <div class="payment-amount" id="paymentAmount">2,000 XAF</div>
                <div class="payment-info">
                    <strong>Détails de l'exportation:</strong><br>
                    <span id="paymentDetails">Format A2 - PDF</span>
                </div>
                
                <!-- Enhanced Payment Methods Selection -->
                <div class="payment-methods">
                    <div class="payment-method" data-method="mobilemoney">
                        <div class="payment-method-icon">📱</div>
                        <div class="payment-method-name">Mobile Money</div>
                        <div class="payment-method-desc">Orange Money, MTN MoMo</div>
                    </div>
                    <div class="payment-method" data-method="card">
                        <div class="payment-method-icon">💳</div>
                        <div class="payment-method-name">Carte Bancaire</div>
                        <div class="payment-method-desc">Visa, Mastercard</div>
                    </div>
                </div>
                
                <div id="paymentSpinner" class="spinner" style="display: none;"></div>
                <div id="paymentStatus"></div>
                <div class="print-actions">
                    <button class="btn btn-secondary" id="cancelPayment">Annuler</button>
                    <button class="btn btn-primary" id="confirmPayment">Procéder au paiement</button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <h3>Génération de votre carte...</h3>
                <p>Veuillez patienter pendant que nous préparons votre exportation.</p>
            </div>
        </div>

        <!-- Notification Container -->
        <div id="notification" class="notification"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    
    <script type="module">
        console.log('🚀 MonVillage - Initialisation avec priorité des clics sur les villages');
        
        // CONFIGURATION AVEC VARIABLES D'ENVIRONNEMENT
        const CONFIG = {
            supabase: {
                url: import.meta.env?.VITE_SUPABASE_URL || 'https://hrlufnjhwhgddxkpyzst.supabase.co',
                anonKey: import.meta.env?.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhybHVmbmpod2hnZGR4a3B5enN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MzIwMzcsImV4cCI6MjA2ODMwODAzN30.0gMYonFDAU84i3boEIKZDK4OQhDrAXXJySGDa80wTZ8'
            },
            mapbox: {
                accessToken: import.meta.env?.VITE_MAPBOX_ACCESS_TOKEN || 'pk.eyJ1IjoiZWthbnNvbiIsImEiOiJjbWUyeDFxZDUwMTVrMmlvcHMzaDlwOXRvIn0.r7nOAUE0YU8c4miQFeJZWg'
            },
            flutterwave: {
                publicKey: import.meta.env?.VITE_FLUTTERWAVE_PUBLIC_KEY || 'FLWPUBK-de06efbef44902ddb3aa4a1680436c38-X'
            },
            map: { center: [5.2, 12.7], zoom: 7 },
            print: {
                formats: {
                    A4: { price: 500, width: 210, height: 297 },
                    A3: { price: 1000, width: 297, height: 420 },
                    A2: { price: 2000, width: 420, height: 594 },
                    A1: { price: 4000, width: 594, width: 841 },
                    A0: { price: 6000, width: 841, height: 1189 }
                }
            }
        };

        let map, supabase, previewMap;
        let mapLayers = { regions: null, departements: null, arrondissements: null, villages: null, poi: null, geonames: null };
        let baseLayers = { standard: null, satellite: null };
        let currentBaseLayer = 'standard';
        
        let measurementLayer;
        let isDistanceMeasuring = false;
        let isAreaMeasuring = false;
        let distanceMarkers = [];
        let measurementLines = [];
        let measurementPolygons = [];
        let polygonPoints = [];
        let tempPolygon = null;

        // Variables pour la sélection de zone d'impression
        let printAreaSelector = null;
        let printBounds = null;
        let isSelectingPrintArea = false;
        let selectedPaymentMethod = 'mobilemoney';

        // Variables pour l'impression
        let printConfig = {
            title: 'Carte des Villages - MonVillage',
            format: 'A2',
            scale: 50000,
            outputFormat: 'pdf',
            showNorthArrow: true,
            showScale: true,
            showLegend: true,
            showCoordinates: true,
            price: 2000,
            bounds: null
        };

        // Variables pour la géolocalisation
        let userLocationMarker = null;
        let userLocationAccuracy = null;
        let isLocating = false;

        // Variables pour la recherche intelligente
        let searchTimeout;
        let currentSearchResults = [];

        // FONCTIONS UTILITAIRES
        function parseGeometry(geom) {
            if (!geom) return null;
            try {
                return typeof geom === 'object' ? geom : JSON.parse(geom);
            } catch (error) {
                console.error('Erreur parsing géométrie:', error);
                return null;
            }
        }

        function showNotification(message, type = 'info', duration = 4000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        function calculateDistance(latlng1, latlng2) {
            const R = 6371000;
            const lat1 = latlng1.lat * Math.PI / 180;
            const lat2 = latlng2.lat * Math.PI / 180;
            const deltaLat = (latlng2.lat - latlng1.lat) * Math.PI / 180;
            const deltaLng = (latlng2.lng - latlng1.lng) * Math.PI / 180;

            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function calculatePolygonArea(latlngs) {
            if (latlngs.length < 3) return 0;
            
            const R = 6371000;
            let area = 0;
            const n = latlngs.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                const lat1 = latlngs[i].lat * Math.PI / 180;
                const lat2 = latlngs[j].lat * Math.PI / 180;
                const deltaLng = (latlngs[j].lng - latlngs[i].lng) * Math.PI / 180;
                
                area += deltaLng * (2 + Math.sin(lat1) + Math.sin(lat2));
            }
            
            area = Math.abs(area) * R * R / 2;
            return area;
        }

        function calculateAreaFromGeometry(geometry) {
            if (!geometry || !geometry.coordinates) {
                return 'Non calculé';
            }
            
            try {
                let coordinates;
                if (geometry.type === 'Polygon') {
                    coordinates = geometry.coordinates[0];
                } else if (geometry.type === 'MultiPolygon') {
                    let totalArea = 0;
                    geometry.coordinates.forEach(polygon => {
                        const polygonCoords = polygon[0].map(coord => ({lat: coord[1], lng: coord[0]}));
                        totalArea += calculatePolygonArea(polygonCoords);
                    });
                    return totalArea;
                }
                
                if (coordinates && coordinates.length > 3) {
                    const latlngs = coordinates.map(coord => ({lat: coord[1], lng: coord[0]}));
                    const area = calculatePolygonArea(latlngs);
                    return area;
                }
                
                return 0;
            } catch (error) {
                console.error('Erreur calcul superficie:', error);
                return 'Erreur calcul';
            }
        }

        function formatDistance(distance) {
            if (distance < 1000) {
                return `${Math.round(distance)} m`;
            } else {
                return `${(distance / 1000).toFixed(2)} km`;
            }
        }

        function formatArea(area) {
            if (area < 1000) {
                return `${Math.round(area)} m²`;
            } else if (area < 10000) {
                return `${(area / 1000).toFixed(2)} k m²`;
            } else if (area < 1000000) {
                const hectares = area / 10000;
                return `${hectares.toFixed(2)} ha`;
            } else {
                const km2 = area / 1000000;
                if (km2 < 10) {
                    return `${km2.toFixed(3)} km²`;
                } else if (km2 < 1000) {
                    return `${km2.toFixed(2)} km²`;
                } else {
                    return `${Math.round(km2).toLocaleString()} km²`;
                }
            }
        }

        // FONCTIONS D'INITIALISATION
        function initializeSupabase() {
            try {
                supabase = window.supabase.createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);
                console.log('✅ Supabase initialisé avec variables d\'environnement');
            } catch (error) {
                console.error('❌ Erreur Supabase:', error);
                showNotification('Mode hors ligne - données démo', 'warning');
            }
        }

        function initializeMap() {
            console.log('🗺️ Initialisation de la carte avec optimisations');
            
            map = L.map('map', { 
                center: CONFIG.map.center, 
                zoom: CONFIG.map.zoom, 
                zoomControl: false,
                preferCanvas: true,
                renderer: L.canvas({ padding: 0.5 })
            });
            
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Couche Mapbox standard
            baseLayers.standard = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: '© Mapbox © OpenStreetMap',
                id: 'mapbox/streets-v11',
                accessToken: CONFIG.mapbox.accessToken,
                maxZoom: 18,
                updateWhenIdle: true,
                updateWhenZooming: false
            });

            // Couche satellite alternative
            baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 20,
                updateWhenIdle: true,
                updateWhenZooming: false
            });

            baseLayers.standard.addTo(map);
            
            // Événement de zoom pour chargement conditionnel
            map.on('zoomend', loadLayersByZoom);
            
            console.log('✅ Carte initialisée avec optimisations de performance');
        }

        function initializePreviewMap() {
            // Initialiser la carte d'aperçu dans le modal d'impression
            const previewElement = document.getElementById('previewMap');
            if (previewElement && !previewMap) {
                setTimeout(() => {
                    try {
                        previewMap = L.map('previewMap', {
                            center: CONFIG.map.center,
                            zoom: CONFIG.map.zoom - 1,
                            zoomControl: false,
                            attributionControl: false,
                            dragging: false,
                            touchZoom: false,
                            doubleClickZoom: false,
                            scrollWheelZoom: false,
                            boxZoom: false,
                            keyboard: false
                        });

                        // Ajouter la couche de base à l'aperçu
                        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                            id: 'mapbox/streets-v11',
                            accessToken: CONFIG.mapbox.accessToken,
                            maxZoom: 18
                        }).addTo(previewMap);

                        console.log('✅ Carte d\'aperçu initialisée');
                    } catch (error) {
                        console.error('Erreur initialisation carte aperçu:', error);
                    }
                }, 500);
            }
        }

        function initializeNativeMeasurementTools() {
            measurementLayer = new L.FeatureGroup();
            map.addLayer(measurementLayer);
        }

        // ================================================================
        // FONCTIONS DE RECHERCHE INTELLIGENTE
        // ================================================================

        function initializeIntelligentSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            
            // Événement de saisie avec debounce
            searchInput.addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    performIntelligentSearch(query);
                }, 300);
            });
            
            // Événement de focus
            searchInput.addEventListener('focus', function() {
                if (currentSearchResults.length > 0) {
                    showSearchResults();
                }
            });
            
            // Événement de touche Entrée
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentSearchResults.length > 0) {
                        selectSearchResult(currentSearchResults[0]);
                    }
                } else if (e.key === 'Escape') {
                    hideSearchResults();
                }
            });
            
            // Cacher les résultats quand on clique ailleurs
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    hideSearchResults();
                }
            });
        }

        async function performIntelligentSearch(query) {
            if (!supabase) {
                showNotification('Recherche hors ligne limitée', 'warning');
                return;
            }
            
            try {
                // Recherche dans les villages et noms de chefs
                const { data, error } = await supabase
                    .from('villages_complete')
                    .select('*')
                    .or(`village_name.ilike.%${query}%,chief_name.ilike.%${query}%`)
                    .eq('is_active', true)
                    .limit(10);
                
                if (error) throw error;
                
                currentSearchResults = data || [];
                displaySearchResults(currentSearchResults, query);
                
            } catch (error) {
                console.error('Erreur recherche:', error);
                showNotification('Erreur lors de la recherche', 'error');
            }
        }

        function displaySearchResults(results, query) {
            const searchResults = document.getElementById('searchResults');
            
            if (!results || results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">Aucun résultat trouvé</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            const resultsHTML = results.map((village, index) => {
                const villageName = highlightMatch(village.village_name, query);
                const chiefName = village.chief_name ? highlightMatch(village.chief_name, query) : 'Non renseigné';
                
                return `
                    <div class="search-result-item" data-village-id="${village.id}" data-index="${index}">
                        <div class="search-result-main">
                            <strong>${villageName}</strong>
                            <span class="search-result-badge">Village</span>
                        </div>
                        <div class="search-result-details">
                            <div class="search-result-chief">
                                <i class="fas fa-user-tie"></i> ${chiefName}
                            </div>
                            <div class="search-result-location">
                                <i class="fas fa-map-marker-alt"></i> 
                                ${village.arrondissement_name} → ${village.departement_name} → ${village.region_name}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            searchResults.innerHTML = resultsHTML;
            searchResults.style.display = 'block';
            
            // Ajouter les événements de clic
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const villageId = this.getAttribute('data-village-id');
                    selectSearchResult(results.find(r => r.id === villageId));
                });
            });
        }

        function highlightMatch(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function hideSearchResults() {
            const searchResults = document.getElementById('searchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
            }
        }

        function showSearchResults() {
            const searchResults = document.getElementById('searchResults');
            if (searchResults && currentSearchResults.length > 0) {
                searchResults.style.display = 'block';
            }
        }

        function selectSearchResult(village) {
            if (!village) return;
            
            hideSearchResults();
            document.getElementById('searchInput').value = village.village_name;
            
            // Zoomer sur le village
            if (village.centroid) {
                const centroid = parseGeometry(village.centroid);
                if (centroid && centroid.coordinates) {
                    map.setView([centroid.coordinates[1], centroid.coordinates[0]], 15);
                    
                    // Ouvrir le popup après un délai
                    setTimeout(() => {
                        if (mapLayers.villages) {
                            mapLayers.villages.eachLayer(layer => {
                                if (layer.villageData && layer.villageData.id === village.id) {
                                    layer.openPopup();
                                }
                            });
                        }
                    }, 500);
                }
            }
            
            showNotification(`Village "${village.village_name}" trouvé`, 'success');
        }

        // SYSTÈME DE SÉLECTION DE ZONE D'IMPRESSION
        function startPrintAreaSelection() {
            if (isSelectingPrintArea) {
                stopPrintAreaSelection();
                return;
            }

            isSelectingPrintArea = true;
            document.getElementById('selectPrintArea').classList.add('active');
            document.getElementById('selectPrintArea').textContent = '⏹️ Arrêter la sélection';
            
            showNotification('Cliquez et glissez pour sélectionner la zone à imprimer', 'info');
            
            map.getContainer().style.cursor = 'crosshair';
            
            map.on('mousedown', onPrintAreaStart);
            map.on('mousemove', onPrintAreaMove);
            map.on('mouseup', onPrintAreaEnd);
        }

        function stopPrintAreaSelection() {
            isSelectingPrintArea = false;
            document.getElementById('selectPrintArea').classList.remove('active');
            document.getElementById('selectPrintArea').textContent = '📐 Sélectionner une zone';
            
            map.getContainer().style.cursor = '';
            
            map.off('mousedown', onPrintAreaStart);
            map.off('mousemove', onPrintAreaMove);
            map.off('mouseup', onPrintAreaEnd);
        }

        let isDragging = false;
        let dragStartLatLng = null;

        function onPrintAreaStart(e) {
            if (!isSelectingPrintArea) return;
            
            isDragging = true;
            dragStartLatLng = e.latlng;
            
            // Supprimer l'ancien sélecteur s'il existe
            if (printAreaSelector) {
                map.removeLayer(printAreaSelector);
            }
        }

        function onPrintAreaMove(e) {
            if (!isSelectingPrintArea || !isDragging || !dragStartLatLng) return;
            
            const bounds = L.latLngBounds(dragStartLatLng, e.latlng);
            
            if (printAreaSelector) {
                map.removeLayer(printAreaSelector);
            }
            
            printAreaSelector = L.rectangle(bounds, {
                className: 'print-area-selector',
                color: '#007bff',
                weight: 3,
                fillColor: '#007bff',
                fillOpacity: 0.1,
                dashArray: '10, 5'
            }).addTo(map);
        }

        function onPrintAreaEnd(e) {
            if (!isSelectingPrintArea || !isDragging || !dragStartLatLng) return;
            
            isDragging = false;
            
            const bounds = L.latLngBounds(dragStartLatLng, e.latlng);
            printBounds = bounds;
            
            // Mettre à jour l'aperçu avec la zone sélectionnée
            updatePreviewWithBounds(bounds);
            updatePrintAreaSummary(bounds);
            
            stopPrintAreaSelection();
            showNotification('Zone d\'impression sélectionnée', 'success');
        }

        function useCurrentMapView() {
            printBounds = map.getBounds();
            
            if (printAreaSelector) {
                map.removeLayer(printAreaSelector);
            }
            
            printAreaSelector = L.rectangle(printBounds, {
                className: 'print-area-selector',
                color: '#007bff',
                weight: 3,
                fillColor: '#007bff',
                fillOpacity: 0.1,
                dashArray: '10, 5'
            }).addTo(map);
            
            updatePreviewWithBounds(printBounds);
            updatePrintAreaSummary(printBounds);
            
            showNotification('Vue actuelle sélectionnée pour l\'impression', 'success');
        }

        function clearPrintAreaSelection() {
            if (printAreaSelector) {
                map.removeLayer(printAreaSelector);
                printAreaSelector = null;
            }
            
            printBounds = null;
            
            // Réinitialiser l'aperçu
            if (previewMap) {
                previewMap.setView(CONFIG.map.center, CONFIG.map.zoom - 1);
            }
            
            document.getElementById('summaryArea').textContent = 'Aucune sélection';
            
            showNotification('Sélection effacée', 'info');
        }

        function updatePreviewWithBounds(bounds) {
            if (!previewMap || !bounds) return;
            
            try {
                // Centrer et ajuster le zoom de l'aperçu sur la zone sélectionnée
                previewMap.fitBounds(bounds);
                
                // Ajouter un rectangle pour montrer la zone sélectionnée
                previewMap.eachLayer(layer => {
                    if (layer instanceof L.Rectangle) {
                        previewMap.removeLayer(layer);
                    }
                });
                
                L.rectangle(bounds, {
                    color: '#ff0000',
                    weight: 2,
                    fillOpacity: 0,
                    dashArray: '5, 5'
                }).addTo(previewMap);
                
            } catch (error) {
                console.error('Erreur mise à jour aperçu:', error);
            }
        }

        function updatePrintAreaSummary(bounds) {
            if (!bounds) {
                document.getElementById('summaryArea').textContent = 'Aucune sélection';
                return;
            }
            
            const center = bounds.getCenter();
            const area = (bounds.getNorth() - bounds.getSouth()) * (bounds.getEast() - bounds.getWest());
            
            document.getElementById('summaryArea').textContent = 
                `Zone sélectionnée (${area.toFixed(4)}° × ${area.toFixed(4)}°)`;
        }

        // CHARGEMENT DES DONNÉES VILLAGES AVEC DESCRIPTIONS
        async function loadInitialData() {
            console.log('📊 Chargement ultra-rapide des données...');
            if (!supabase) {
                showNotification('Mode démo - pas de données', 'warning');
                return;
            }
            
            try {
                showNotification('Chargement des couches...', 'info');
                
                // MODIFICATION : Chargement séquentiel pour garantir l'ordre
                await loadRegionsOptimized();
                await loadDepartementsOptimized(); 
                await loadArrondissementsOptimized();
                // Villages chargés APRÈS les arrondissements pour priorité des clics
                await loadVillagesOptimized();
                
                showNotification('Données chargées rapidement', 'success', 2000);
                console.log('✅ Toutes les données chargées en séquence');
            } catch (error) {
                console.error('❌ Erreur chargement:', error);
                showNotification('Erreur de chargement des données', 'error');
            }
        }

        async function loadVillagesOptimized() {
            try {
                const { data, error } = await supabase
                    .from('villages_complete_extended')
                    .select('*')
                    .eq('is_active', true);
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.villages = L.layerGroup();
                
                data.forEach(village => {
                    if (village.geom) {
                        const geometry = parseGeometry(village.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#cc6600', 
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0,
                                dashArray: '8, 6'
                            },
                            interactive: true
                        }).addTo(mapLayers.villages);

                        // Popup améliorée avec nouvelles informations
                        const popupContent = createVillagePopup(village);
                        layer.bindPopup(popupContent, {
                            maxWidth: 350,
                            className: 'village-popup'
                        });

                        // MODIFICATION : Gestion des clics avec priorité haute
                        // Les villages sont chargés APRÈS les arrondissements
                        layer.on('click', function(e) {
                            if (!isDistanceMeasuring && !isAreaMeasuring) {
                                // Marquer l'événement comme traité par un village
                                e.originalEvent._processedByVillage = true;
                                e.originalEvent._villagesProcessed = true;
                                
                                L.DomEvent.stopPropagation(e); // Empêche la propagation aux autres couches
                                layer.openPopup();
                            }
                        });

                        // Stocker les données du village pour le modal
                        layer.villageData = village;
                    }
                });
                
                map.addLayer(mapLayers.villages);
                console.log(`${data.length} villages chargés avec informations complètes`);
                
            } catch (error) {
                console.error('Erreur villages:', error);
                throw error;
            }
        }

        function createVillagePopup(village) {
            const areaText = village.area_hectares ? 
                `${village.area_hectares.toFixed(2)} ha` : 'Non calculée';
            
            const populationText = village.population ? 
                village.population.toLocaleString() + ' habitants' : 'Non renseignée';
            
            const phoneText = village.telephone || 'Non disponible';
            
            const chiefPhotoHtml = village.chief_photo_url ? 
                `<img src="${village.chief_photo_url}" alt="Photo du chef" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 10px;">` 
                : `<div style="width: 60px; height: 60px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: #666;"><i class="fas fa-user"></i></div>`;

            const chiefServiceYears = village.chief_years_of_service ? 
                ` (${village.chief_years_of_service} ans de service)` : '';

            return `
                <div style="font-family: inherit; min-width: 320px;">
                    <div style="background: linear-gradient(135deg, #2c5530 0%, #4a7c59 100%); color: white; padding: 15px; margin: -10px -15px 15px; border-radius: 8px;">
                        <h3 style="margin: 0 0 5px; font-size: 18px;">
                            <i class="fas fa-home"></i> ${village.village_name}
                        </h3>
                        <p style="margin: 0; opacity: 0.9; font-size: 14px;">
                            ${village.arrondissement_name}
                        </p>
                    </div>
                    
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        ${chiefPhotoHtml}
                        <div>
                            <div style="font-weight: bold; color: #2c5530;">Chef de Village</div>
                            <div style="color: #666;">${village.chief_name || 'Non renseigné'}${chiefServiceYears}</div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase;">Superficie</div>
                            <div style="font-weight: bold; color: #2c5530;">${areaText}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #666; text-transform: uppercase;">Population</div>
                            <div style="font-weight: bold; color: #2c5530;">${populationText}</div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; margin-bottom: 5px;">
                            <i class="fas fa-phone" style="color: #4a7c59; margin-right: 8px;"></i>
                            <span style="color: #333;">${phoneText}</span>
                        </div>
                        ${village.email ? `
                        <div style="display: flex; align-items: center;">
                            <i class="fas fa-envelope" style="color: #4a7c59; margin-right: 8px;"></i>
                            <span style="color: #333;">${village.email}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div style="text-align: center;">
                        <button onclick="openVillageDetails('${village.id}')" 
                                style="background: #4a7c59; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s;">
                            <i class="fas fa-info-circle"></i> En savoir plus
                        </button>
                    </div>
                </div>
            `;
        }

        // FONCTIONS DU MODAL VILLAGE
        window.openVillageDetails = function(villageId) {
            map.closePopup();
            
            let villageData = null;
            if (mapLayers.villages) {
                mapLayers.villages.eachLayer(layer => {
                    if (layer.villageData && layer.villageData.id === villageId) {
                        villageData = layer.villageData;
                    }
                });
            }
            
            if (!villageData) {
                showNotification('Impossible de charger les détails du village', 'error');
                return;
            }
            
            displayVillageDetails(villageData);
        };

        async function displayVillageDetails(village) {
            // Remplir les informations de base
            document.getElementById('villageModalTitle').textContent = village.village_name;
            document.getElementById('villageModalSubtitle').textContent = village.arrondissement_name;
            document.getElementById('villageChiefName').textContent = village.chief_name || 'Non renseigné';
            
            // Date de prise de service du chef
            document.getElementById('villageChiefStartDate').textContent = 
                village.chief_start_date ? 
                new Date(village.chief_start_date).toLocaleDateString('fr-FR') + 
                (village.chief_years_of_service ? ` (${village.chief_years_of_service} ans)` : '') : 
                'Non renseignée';
            
            document.getElementById('villageTelephone').textContent = village.telephone || 'Non disponible';
            document.getElementById('villageEmail').textContent = village.email || 'Non disponible';
            document.getElementById('villageArea').textContent = village.area_hectares ? 
                `${village.area_hectares.toFixed(2)} ha` : 'Non calculée';
            document.getElementById('villagePopulation').textContent = village.population ? 
                village.population.toLocaleString() + ' habitants' : 'Non renseignée';
            
            // Afficher les photos
            await displayVillagePhotos(village);
            
            // Charger et afficher la description détaillée
            await loadVillageDescription(village.id);
            
            // Remplir les informations de base
            document.getElementById('villageArrondissementInfo').textContent = village.arrondissement_name;
            
            let basicInfo = '';
            if (village.chief_name) {
                basicInfo += `Le village est dirigé par ${village.chief_name}. `;
            }
            if (village.area_hectares) {
                basicInfo += `Sa superficie est d'environ ${village.area_hectares.toFixed(2)} hectares. `;
            }
            if (village.population) {
                basicInfo += `La population est estimée à ${village.population.toLocaleString()} habitants.`;
            }
            document.getElementById('villageBasicInfo').textContent = basicInfo;
            
            // Activer l'onglet par défaut
            switchTab('info');
            
            // Afficher le modal
            document.getElementById('villageModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        async function displayVillagePhotos(village) {
            const photosSection = document.getElementById('villagePhotosSection');
            const photosGrid = document.getElementById('villagePhotosGrid');
            
            let photos = [];
            
            // Photo du chef
            if (village.chief_photo_url) {
                photos.push({
                    url: village.chief_photo_url,
                    caption: `${village.chief_name || 'Chef du village'}`
                });
            }
            
            // Charger les photos du village depuis la base de données
            if (supabase) {
                try {
                    const { data: villagePhotos, error } = await supabase
                        .from('village_photos')
                        .select('*')
                        .eq('village_id', village.id)
                        .order('photo_order');
                    
                    if (!error && villagePhotos) {
                        villagePhotos.forEach((photo, index) => {
                            photos.push({
                                url: photo.photo_url,
                                caption: `Village ${village.village_name} (${index + 1})`
                            });
                        });
                    }
                } catch (error) {
                    console.error('Erreur chargement photos village:', error);
                }
            }
            
            if (photos.length > 0) {
                photosSection.style.display = 'block';
                photosGrid.innerHTML = photos.map(photo => `
                    <div class="village-photo">
                        <img src="${photo.url}" alt="${photo.caption}" loading="lazy" 
                             onerror="this.style.display='none'">
                        <div class="village-photo-caption">${photo.caption}</div>
                    </div>
                `).join('');
            } else {
                photosSection.style.display = 'none';
            }
        }

        async function loadVillageDescription(villageId) {
            if (!supabase) {
                document.getElementById('descriptionTab').style.display = 'none';
                return;
            }
            
            try {
                const { data: description, error } = await supabase
                    .from('village_descriptions')
                    .select('*')
                    .eq('village_id', villageId)
                    .eq('is_published', true)
                    .single();
                
                if (error || !description) {
                    document.getElementById('descriptionTab').style.display = 'none';
                    return;
                }
                
                const hasContent = checkHasDescriptionContent(description);
                
                if (hasContent) {
                    document.getElementById('descriptionTab').style.display = 'block';
                    populateDescriptionContent(description);
                } else {
                    document.getElementById('descriptionTab').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Erreur chargement description:', error);
                document.getElementById('descriptionTab').style.display = 'none';
            }
        }

        function checkHasDescriptionContent(description) {
            return description.histoire_origine || description.description_limites || 
                   description.importance_region || description.danses_musiques_rites ||
                   description.gastronomie_locale || description.fetes_traditionnelles ||
                   description.structure_demographique || description.groupes_ethniques ||
                   description.activites_generatrices || description.produits_terroir ||
                   description.infrastructures_scolaires || description.infrastructures_sante ||
                   description.infrastructures_routes || description.acces_electricite_eau ||
                   description.sites_naturels || description.sites_culturels ||
                   description.personnalites_originaires;
        }

        function populateDescriptionContent(description) {
            // Cacher le message "pas de description"
            document.getElementById('noDescriptionMessage').style.display = 'none';
            
            // Présentation générale
            populateSection('presentationSection', [
                { id: 'histoireOrigineSec', contentId: 'histoireOrigineContent', data: description.histoire_origine },
                { id: 'limitesSection', contentId: 'limitesContent', data: description.description_limites },
                { id: 'importanceSection', contentId: 'importanceContent', data: description.importance_region }
            ]);
            
            // Culture & Traditions
            populateSection('cultureSection', [
                { id: 'dansesSection', contentId: 'dansesContent', data: description.danses_musiques_rites },
                { id: 'gastronomieSection', contentId: 'gastronomieContent', data: description.gastronomie_locale },
                { id: 'fetesSection', contentId: 'fetesContent', data: description.fetes_traditionnelles }
            ]);
            
            // Population
            populateSection('populationSection', [
                { id: 'demographieSection', contentId: 'demographieContent', data: description.structure_demographique },
                { id: 'ethniesSection', contentId: 'ethniesContent', data: description.groupes_ethniques }
            ]);
            
            // Économie
            populateSection('economieSection', [
                { id: 'activitesSection', contentId: 'activitesContent', data: description.activites_generatrices },
                { id: 'produitsSection', contentId: 'produitsContent', data: description.produits_terroir }
            ]);
            
            // Infrastructures
            populateSection('infrastructuresSection', [
                { id: 'ecolesSection', contentId: 'ecolesContent', data: description.infrastructures_scolaires },
                { id: 'santeSection', contentId: 'santeContent', data: description.infrastructures_sante },
                { id: 'routesSection', contentId: 'routesContent', data: description.infrastructures_routes },
                { id: 'servicesSection', contentId: 'servicesContent', data: description.acces_electricite_eau }
            ]);
            
            // Tourisme
            populateSection('tourismeSection', [
                { id: 'sitesNaturelsSection', contentId: 'sitesNaturelsContent', data: description.sites_naturels },
                { id: 'sitesCulturelsSection', contentId: 'sitesCulturelsContent', data: description.sites_culturels }
            ]);
            
            // Personnalités
            populateSection('personnalitesSection', [
                { id: 'personnalitesOriginairesSection', contentId: 'personnalitesOriginairesContent', data: description.personnalites_originaires }
            ]);
        }

        function populateSection(sectionId, subsections) {
            const section = document.getElementById(sectionId);
            let hasContent = false;
            
            subsections.forEach(subsection => {
                const element = document.getElementById(subsection.id);
                const content = document.getElementById(subsection.contentId);
                
                if (subsection.data && subsection.data.trim()) {
                    element.style.display = 'block';
                    content.textContent = subsection.data.trim();
                    hasContent = true;
                } else {
                    element.style.display = 'none';
                }
            });
            
            section.style.display = hasContent ? 'block' : 'none';
        }

        window.switchTab = function(tabName) {
            // Désactiver tous les onglets
            document.querySelectorAll('.village-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.village-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Activer l'onglet sélectionné
            document.querySelector(`.village-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'TabContent').classList.add('active');
        };

        function closeVillageModal() {
            document.getElementById('villageModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // CHARGEMENT DES COUCHES ADMINISTRATIVES
        async function loadRegionsOptimized() {
            try {
                const { data, error } = await supabase
                    .from('regions')
                    .select('id_region, nom_region, geom');
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.regions = L.layerGroup();
                
                data.forEach(region => {
                    if (region.geom) {
                        const geometry = parseGeometry(region.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#d62728', 
                                weight: 2,
                                opacity: 0.8,
                                fillOpacity: 0 
                            },
                            interactive: true
                        }).addTo(mapLayers.regions);

                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #d62728; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${region.nom_region}
                                </h4>
                                <p><strong>Type:</strong> Région</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function(e) {
                            // Vérifier si un village n'a pas déjà traité ce clic
                            if (!e.originalEvent._processedByVillage && !isDistanceMeasuring && !isAreaMeasuring) {
                                layer.openPopup();
                            }
                        });
                    }
                });
                
                map.addLayer(mapLayers.regions);
                console.log(`${data.length} régions chargées complètement`);
                
            } catch (error) {
                console.error('Erreur régions:', error);
                throw error;
            }
        }

        async function loadDepartementsOptimized() {
            try {
                const { data, error } = await supabase
                    .from('departements')
                    .select('id_departement, nom_departement, geom');
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.departements = L.layerGroup();
                
                data.forEach(departement => {
                    if (departement.geom) {
                        const geometry = parseGeometry(departement.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#000000', 
                                weight: 1.5,
                                opacity: 0.7,
                                fillOpacity: 0 
                            },
                            interactive: true
                        }).addTo(mapLayers.departements);

                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #000000; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${departement.nom_departement}
                                </h4>
                                <p><strong>Type:</strong> Département</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        layer.on('click', function(e) {
                            // Vérifier si un village n'a pas déjà traité ce clic
                            if (!e.originalEvent._processedByVillage && !isDistanceMeasuring && !isAreaMeasuring) {
                                layer.openPopup();
                            }
                        });
                    }
                });
                
                map.addLayer(mapLayers.departements);
                console.log(`${data.length} départements chargés complètement`);
                
            } catch (error) {
                console.error('Erreur départements:', error);
                throw error;
            }
        }

        async function loadArrondissementsOptimized() {
            try {
                const { data, error } = await supabase
                    .from('arrondissements')
                    .select('id_arrondissement, nom_arrondissement, geom');
                
                if (error) throw error;
                if (!data || data.length === 0) return;

                mapLayers.arrondissements = L.layerGroup();
                
                data.forEach(arrondissement => {
                    if (arrondissement.geom) {
                        const geometry = parseGeometry(arrondissement.geom);
                        if (!geometry) return;

                        const layer = L.geoJSON(geometry, {
                            style: { 
                                fillColor: 'transparent', 
                                color: '#8B008B', 
                                weight: 1,
                                opacity: 0.6,
                                fillOpacity: 0, 
                                dashArray: '4, 4'
                            },
                            interactive: true
                        }).addTo(mapLayers.arrondissements);

                        const area = calculateAreaFromGeometry(geometry);
                        const areaText = typeof area === 'number' ? formatArea(area) : 'Non calculé';

                        layer.bindPopup(`
                            <div style="font-family: inherit;">
                                <h4 style="color: #8B008B; margin-bottom: 8px;">
                                    <i class="fas fa-map"></i> ${arrondissement.nom_arrondissement}
                                </h4>
                                <p><strong>Type:</strong> Arrondissement</p>
                                <p><strong>Superficie:</strong> ${areaText}</p>
                            </div>
                        `);

                        // MODIFICATION : Gestion des clics avec priorité basse
                        // Les arrondissements sont chargés AVANT les villages
                        layer.on('click', function(e) {
                            // Vérifier si un village n'a pas déjà traité ce clic
                            if (!e.originalEvent._processedByVillage && !isDistanceMeasuring && !isAreaMeasuring) {
                                L.DomEvent.stopPropagation(e);
                                layer.openPopup();
                            }
                        });
                    }
                });
                
                map.addLayer(mapLayers.arrondissements);
                console.log(`TOUS les ${data.length} arrondissements chargés complètement`);
                
            } catch (error) {
                console.error('Erreur arrondissements:', error);
                throw error;
            }
        }

        function loadLayersByZoom() {
            const zoom = map.getZoom();
            
            if (zoom < 6) {
                if (mapLayers.departements && map.hasLayer(mapLayers.departements)) {
                    map.removeLayer(mapLayers.departements);
                }
                if (mapLayers.arrondissements && map.hasLayer(mapLayers.arrondissements)) {
                    map.removeLayer(mapLayers.arrondissements);
                }
            } else if (zoom < 9) {
                if (mapLayers.departements && !map.hasLayer(mapLayers.departements)) {
                    map.addLayer(mapLayers.departements);
                }
                if (mapLayers.arrondissements && map.hasLayer(mapLayers.arrondissements)) {
                    map.removeLayer(mapLayers.arrondissements);
                }
            } else {
                if (mapLayers.departements && !map.hasLayer(mapLayers.departements)) {
                    map.addLayer(mapLayers.departements);
                }
                if (mapLayers.arrondissements && !map.hasLayer(mapLayers.arrondissements)) {
                    map.addLayer(mapLayers.arrondissements);
                }
            }
        }

        // GÉOLOCALISATION
        function locateUser() {
            console.log('🔍 Demande de géolocalisation utilisateur');
            
            const button = document.getElementById('locateUser');
            
            if (isLocating) {
                stopLocationTracking();
                return;
            }

            if (userLocationMarker && !isLocating) {
                clearUserLocation();
                showNotification('Localisation désactivée', 'info', 2000);
                return;
            }

            if (!navigator.geolocation) {
                showNotification('Géolocalisation non supportée par ce navigateur', 'error');
                return;
            }

            isLocating = true;
            button.classList.add('locating');
            showNotification('Recherche de votre position...', 'info');

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                onLocationSuccess,
                onLocationError,
                options
            );
        }

        function onLocationSuccess(position) {
            console.log('✅ Position trouvée:', position.coords);
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;

            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            if (userLocationAccuracy) {
                map.removeLayer(userLocationAccuracy);
            }

            userLocationAccuracy = L.circle([lat, lng], {
                radius: accuracy,
                className: 'user-location-accuracy'
            }).addTo(map);

            const locationIcon = L.divIcon({
                className: 'user-location-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            userLocationMarker = L.marker([lat, lng], {
                icon: locationIcon
            }).addTo(map);

            userLocationMarker.bindPopup(`
                <div style="font-family: inherit; text-align: center;">
                    <h4 style="color: #007bff; margin-bottom: 8px;">
                        <i class="fas fa-crosshairs"></i> Votre Position
                    </h4>
                    <p><strong>Latitude:</strong> ${lat.toFixed(6)}</p>
                    <p><strong>Longitude:</strong> ${lng.toFixed(6)}</p>
                    <p><strong>Précision:</strong> ±${Math.round(accuracy)}m</p>
                    <p style="font-size: 12px; color: #666; margin-top: 10px;">
                        <i class="fas fa-clock"></i> ${new Date().toLocaleTimeString('fr-FR')}
                    </p>
                </div>
            `);

            map.setView([lat, lng], Math.max(map.getZoom(), 15));

            const button = document.getElementById('locateUser');
            button.classList.remove('locating');
            button.classList.add('located');
            isLocating = false;
            
            showNotification(`Position trouvée avec précision de ±${Math.round(accuracy)}m`, 'success');
            
            setTimeout(() => {
                userLocationMarker.openPopup();
            }, 500);
        }

        function onLocationError(error) {
            console.error('❌ Erreur de géolocalisation:', error);
            
            let message = 'Impossible de déterminer votre position';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Autorisation de géolocalisation refusée';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Position non disponible';
                    break;
                case error.TIMEOUT:
                    message = 'Délai de géolocalisation dépassé';
                    break;
            }
            
            showNotification(message, 'error');
            stopLocationTracking();
        }

        function stopLocationTracking() {
            isLocating = false;
            const button = document.getElementById('locateUser');
            button.classList.remove('locating');
        }

        function clearUserLocation() {
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
                userLocationMarker = null;
            }
            if (userLocationAccuracy) {
                map.removeLayer(userLocationAccuracy);
                userLocationAccuracy = null;
            }
            
            const button = document.getElementById('locateUser');
            button.classList.remove('locating', 'located');
            isLocating = false;
        }

        // OUTILS DE MESURE
        function disableAdministrativeLayers() {
            if (mapLayers.regions) {
                mapLayers.regions.eachLayer(layer => {
                    layer.off('click');
                });
            }
            if (mapLayers.departements) {
                mapLayers.departements.eachLayer(layer => {
                    layer.off('click');
                });
            }
            if (mapLayers.arrondissements) {
                mapLayers.arrondissements.eachLayer(layer => {
                    layer.off('click');
                });
            }
        }

        function enableAdministrativeLayers() {
            if (mapLayers.regions) {
                mapLayers.regions.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
            if (mapLayers.departements) {
                mapLayers.departements.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
            if (mapLayers.arrondissements) {
                mapLayers.arrondissements.eachLayer(layer => {
                    layer.on('click', function() {
                        layer.openPopup();
                    });
                });
            }
        }

        function clearActiveMeasurements() {
            if (isDistanceMeasuring) {
                stopDistanceMeasurement();
            }
            if (isAreaMeasuring) {
                stopAreaMeasurement();
            }

            distanceMarkers.forEach(marker => {
                if (map.hasLayer(marker)) map.removeLayer(marker);
            });
            distanceMarkers = [];

            measurementLines.forEach(line => {
                if (map.hasLayer(line)) map.removeLayer(line);
            });
            measurementLines = [];

            map.closePopup();
        }

        function clearAllMeasurements() {
            clearActiveMeasurements();
            
            measurementPolygons.forEach(item => {
                if (map.hasLayer(item)) map.removeLayer(item);
            });
            measurementPolygons = [];
            
            measurementLayer.clearLayers();
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
            
            map.closePopup();
            showNotification('Toutes les mesures effacées', 'info');
        }

        function startDistanceMeasurement() {
            clearActiveMeasurements();
            
            const button = document.getElementById('measureDistance');
            if (isDistanceMeasuring) {
                stopDistanceMeasurement();
                return;
            }

            isDistanceMeasuring = true;
            button.classList.add('active');
            
            showNotification('Cliquez sur deux points pour mesurer la distance', 'info');
            
            disableAdministrativeLayers();
            
            map.on('click', onDistanceClick);
            map.getContainer().style.cursor = 'crosshair';
        }

        function stopDistanceMeasurement() {
            isDistanceMeasuring = false;
            document.getElementById('measureDistance').classList.remove('active');
            map.off('click', onDistanceClick);
            map.getContainer().style.cursor = '';
            
            enableAdministrativeLayers();
            
            if (distanceMarkers.length === 1) {
                map.removeLayer(distanceMarkers[0]);
                distanceMarkers = [];
            }
        }

        function onDistanceClick(e) {
            if (!isDistanceMeasuring) return;

            L.DomEvent.stopPropagation(e);

            const marker = L.circleMarker(e.latlng, {
                radius: 6,
                color: '#ff4757',
                fillColor: '#ff4757',
                fillOpacity: 1,
                weight: 2
            }).addTo(measurementLayer);

            distanceMarkers.push(marker);

            if (distanceMarkers.length === 2) {
                const distance = calculateDistance(
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                );

                const line = L.polyline([
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                ], {
                    color: '#ff4757',
                    weight: 3,
                    dashArray: '8, 12'
                }).addTo(measurementLayer);

                measurementLines.push(line);

                const midPoint = L.latLngBounds([
                    distanceMarkers[0].getLatLng(),
                    distanceMarkers[1].getLatLng()
                ]).getCenter();

                L.popup({
                    closeButton: true,
                    autoClose: false,
                    className: 'measurement-tooltip'
                })
                .setLatLng(midPoint)
                .setContent(`<strong>Distance: ${formatDistance(distance)}</strong>`)
                .openOn(map);

                showNotification(`Distance: ${formatDistance(distance)}`, 'success');
                stopDistanceMeasurement();
            }
        }

        function startAreaMeasurement() {
            clearActiveMeasurements();
            
            const button = document.getElementById('measureArea');
            if (isAreaMeasuring) {
                stopAreaMeasurement();
                return;
            }

            isAreaMeasuring = true;
            button.classList.add('active');
            polygonPoints = [];
            
            showNotification('Cliquez pour dessiner un polygone. Double-clic pour terminer.', 'info');
            
            disableAdministrativeLayers();
            
            map.on('click', onPolygonClick);
            map.on('dblclick', onPolygonFinish);
            map.on('mousemove', onPolygonMouseMove);
            map.getContainer().style.cursor = 'crosshair';
        }

        function stopAreaMeasurement() {
            isAreaMeasuring = false;
            document.getElementById('measureArea').classList.remove('active');
            
            map.off('click', onPolygonClick);
            map.off('dblclick', onPolygonFinish);
            map.off('mousemove', onPolygonMouseMove);
            map.getContainer().style.cursor = '';
            
            enableAdministrativeLayers();
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
        }

        function onPolygonClick(e) {
            if (!isAreaMeasuring) return;
            
            L.DomEvent.stopPropagation(e);
            
            polygonPoints.push(e.latlng);
            
            const marker = L.circleMarker(e.latlng, {
                radius: 5,
                color: '#4CAF50',
                fillColor: '#4CAF50',
                fillOpacity: 1,
                weight: 2
            }).addTo(measurementLayer);
            
            measurementPolygons.push(marker);
            
            if (polygonPoints.length >= 2) {
                if (tempPolygon) {
                    map.removeLayer(tempPolygon);
                }
                
                tempPolygon = L.polyline(polygonPoints, {
                    color: '#4CAF50',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '5, 10'
                }).addTo(map);
            }
        }

        function onPolygonFinish(e) {
            if (!isAreaMeasuring || polygonPoints.length < 3) return;
            
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
                tempPolygon = null;
            }
            
            const finalPolygon = L.polygon(polygonPoints, {
                color: '#4CAF50',
                weight: 3,
                fillColor: '#4CAF50',
                fillOpacity: 0.2
            }).addTo(measurementLayer);
            
            measurementPolygons.push(finalPolygon);
            
            const area = calculatePolygonArea(polygonPoints);
            const center = finalPolygon.getBounds().getCenter();
            
            L.popup({
                closeButton: true,
                autoClose: false,
                className: 'measurement-tooltip'
            })
            .setLatLng(center)
            .setContent(`<strong>Surface: ${formatArea(area)}</strong>`)
            .openOn(map);

            showNotification(`Surface: ${formatArea(area)}`, 'success');
            
            stopAreaMeasurement();
        }

        function onPolygonMouseMove(e) {
            if (!isAreaMeasuring || polygonPoints.length === 0) return;
            
            if (tempPolygon) {
                map.removeLayer(tempPolygon);
            }
            
            const tempPoints = [...polygonPoints, e.latlng];
            tempPolygon = L.polyline(tempPoints, {
                color: '#4CAF50',
                weight: 2,
                opacity: 0.5,
                dashArray: '5, 10'
            }).addTo(map);
        }

        // SYSTÈME D'IMPRESSION AVANCÉ
        function openPrintModal() {
            console.log('🖨️ Ouverture du modal d\'impression avancé');
            
            const modal = document.getElementById('printModal');
            modal.classList.add('active');
            
            // Initialiser la carte d'aperçu si elle n'existe pas
            initializePreviewMap();
            
            document.getElementById('previewDate').textContent = new Date().toLocaleDateString('fr-FR');
            updatePrintPreview();
            showNotification('Configurez vos options d\'impression', 'info');
        }

        function closePrintModal() {
            const modal = document.getElementById('printModal');
            modal.classList.remove('active');
            
            // Arrêter la sélection de zone si active
            if (isSelectingPrintArea) {
                stopPrintAreaSelection();
            }
        }

        function updatePrintPreview() {
            const title = document.getElementById('mapTitle').value || 'Carte des Villages - MonVillage';
            document.getElementById('previewTitle').textContent = title;
            printConfig.title = title;
            
            const scale = document.getElementById('mapScale').value || 50000;
            document.getElementById('previewScale').textContent = `1:${parseInt(scale).toLocaleString()}`;
            printConfig.scale = parseInt(scale);
            
            document.getElementById('previewFormat').textContent = printConfig.format;
            
            const northArrow = document.getElementById('previewNorthArrow');
            const scaleElement = document.getElementById('previewScale');
            
            northArrow.style.display = document.getElementById('showNorthArrow').checked ? 'flex' : 'none';
            scaleElement.style.display = document.getElementById('showScale').checked ? 'block' : 'none';
            
            document.getElementById('summaryFormat').textContent = printConfig.format;
            document.getElementById('summaryFileType').textContent = document.getElementById('outputFormat').value.toUpperCase();
            document.getElementById('summaryScale').textContent = `1:${parseInt(scale).toLocaleString()}`;
            document.getElementById('summaryPrice').textContent = `${printConfig.price.toLocaleString()} XAF`;
            
            // Mettre à jour l'aperçu de la carte si des bornes sont sélectionnées
            if (printBounds && previewMap) {
                updatePreviewWithBounds(printBounds);
            }
        }

        function selectFormat(format, price) {
            document.querySelectorAll('.format-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            document.querySelector(`[data-format="${format}"]`).classList.add('selected');
            
            printConfig.format = format;
            printConfig.price = price;
            
            updatePrintPreview();
        }

        function setScale(scale) {
            document.getElementById('mapScale').value = scale;
            updatePrintPreview();
        }

        // SYSTÈME DE PAIEMENT FLUTTERWAVE AMÉLIORÉ
        async function proceedToPayment() {
            printConfig.title = document.getElementById('mapTitle').value;
            printConfig.outputFormat = document.getElementById('outputFormat').value;
            printConfig.showNorthArrow = document.getElementById('showNorthArrow').checked;
            printConfig.showScale = document.getElementById('showScale').checked;
            printConfig.showLegend = document.getElementById('showLegend').checked;
            printConfig.showCoordinates = document.getElementById('showCoordinates').checked;
            printConfig.bounds = printBounds;
            
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.add('active');
            
            document.getElementById('paymentAmount').textContent = `${printConfig.price.toLocaleString()} XAF`;
            document.getElementById('paymentDetails').textContent = 
                `Format ${printConfig.format} - ${printConfig.outputFormat.toUpperCase()}`;
            
            closePrintModal();
        }

        function cancelPayment() {
            const paymentModal = document.getElementById('paymentModal');
            paymentModal.classList.remove('active');
            openPrintModal();
        }

        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');
            
            // Mettre à jour le texte du bouton selon la méthode
            const confirmButton = document.getElementById('confirmPayment');
            if (method === 'mobilemoney') {
                confirmButton.innerHTML = '📱 Payer par Mobile Money';
            } else if (method === 'card') {
                confirmButton.innerHTML = '💳 Payer par Carte';
            }
        }

        async function processPayment() {
            try {
                document.getElementById('paymentSpinner').style.display = 'block';
                document.getElementById('confirmPayment').disabled = true;
                
                const txRef = `PRINT_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                let paymentOptions = "card,mobilemoney,ussd";
                let preferredOption = selectedPaymentMethod === 'card' ? 'card' : 'mobilemoney';
                
                FlutterwaveCheckout({
                    public_key: CONFIG.flutterwave.publicKey,
                    tx_ref: txRef,
                    amount: printConfig.price,
                    currency: "XAF",
                    payment_options: paymentOptions,
                    redirect_url: window.location.href,
                    customer: {
                        email: "client@monvillage.cm",
                        phone_number: "+237000000000",
                        name: "Client MonVillage"
                    },
                    customizations: {
                        title: "MonVillage - Exportation de Carte",
                        description: `Exportation ${printConfig.format} - ${selectedPaymentMethod === 'mobilemoney' ? 'Orange Money, MTN MoMo disponibles' : 'Visa, Mastercard acceptées'}`,
                        logo: "https://via.placeholder.com/150x50?text=MonVillage"
                    },
                    meta: {
                        print_format: printConfig.format,
                        print_title: printConfig.title,
                        payment_method: selectedPaymentMethod
                    },
                    callback: function(data) {
                        console.log('Paiement réussi:', data);
                        handlePaymentSuccess(data, txRef, data.payment_type || selectedPaymentMethod);
                    },
                    onclose: function() {
                        console.log('Paiement fermé par l\'utilisateur');
                        handlePaymentCancel();
                    }
                });
                
            } catch (error) {
                console.error('❌ Erreur lors du paiement:', error);
                showNotification('Erreur lors du traitement du paiement', 'error');
                
                document.getElementById('paymentSpinner').style.display = 'none';
                document.getElementById('confirmPayment').disabled = false;
            }
        }

        async function handlePaymentSuccess(paymentData, txRef, paymentType = 'flutterwave') {
            console.log(`Paiement confirmé via ${paymentType}`, paymentData);
            
            let successMessage = 'Paiement réussi';
            if (paymentType === 'mobilemoney') {
                successMessage = 'Paiement Mobile Money réussi';
            } else if (paymentType === 'card') {
                successMessage = 'Paiement par carte réussi';
            } else if (paymentType === 'ussd') {
                successMessage = 'Paiement USSD réussi';
            }
            
            try {
                if (supabase) {
                    const { error } = await supabase.from('payments').insert({
                        transaction_id: txRef,
                        amount: printConfig.price,
                        currency: 'XAF',
                        status: 'success',
                        payment_method: 'flutterwave',
                        payment_type: paymentType,
                        flutterwave_tx_ref: txRef,
                        flutterwave_tx_id: paymentData.transaction_id,
                        print_format: printConfig.format,
                        print_title: printConfig.title,
                        map_bounds: printBounds ? JSON.stringify({
                            north: printBounds.getNorth(),
                            south: printBounds.getSouth(),
                            east: printBounds.getEast(),
                            west: printBounds.getWest()
                        }) : JSON.stringify(map.getBounds())
                    });
                    
                    if (error) {
                        console.error('Erreur enregistrement paiement:', error);
                    } else {
                        console.log('Paiement enregistré en base');
                    }
                }
                
                document.getElementById('paymentModal').classList.remove('active');
                showNotification(successMessage, 'success');
                await generateMapExport();
                
            } catch (error) {
                console.error('Erreur post-paiement:', error);
                showNotification('Paiement réussi mais erreur lors de la génération', 'warning');
            }
        }

        function handlePaymentCancel() {
            document.getElementById('paymentSpinner').style.display = 'none';
            document.getElementById('confirmPayment').disabled = false;
            showNotification('Paiement annulé', 'info');
        }

        async function generateMapExport() {
            console.log('🗺️ Génération de l\'exportation en cours...');
            
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('active');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const bounds = printBounds || map.getBounds();
                const center = bounds.getCenter();
                
                const exportData = {
                    config: printConfig,
                    mapView: {
                        center: [center.lat, center.lng],
                        bounds: [
                            [bounds.getSouth(), bounds.getWest()],
                            [bounds.getNorth(), bounds.getEast()]
                        ],
                        zoom: map.getZoom()
                    },
                    layers: getActiveLayers(),
                    timestamp: new Date().toISOString()
                };
                
                const fileName = generateFileName();
                simulateFileDownload(fileName);
                
                loadingOverlay.classList.remove('active');
                showNotification(`Exportation réussie: ${fileName}`, 'success', 6000);
                
                // Nettoyer la sélection de zone après export
                clearPrintAreaSelection();
                
            } catch (error) {
                console.error('❌ Erreur lors de la génération:', error);
                loadingOverlay.classList.remove('active');
                showNotification('Erreur lors de la génération de la carte', 'error');
            }
        }

        function getActiveLayers() {
            const activeLayers = [];
            
            document.querySelectorAll('.layer-toggle.active').forEach(toggle => {
                activeLayers.push(toggle.dataset.layer);
            });
            
            return activeLayers;
        }

        function generateFileName() {
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const title = printConfig.title.replace(/[^a-zA-Z0-9]/g, '_');
            
            return `${title}_${printConfig.format}_${timestamp}.${printConfig.outputFormat}`;
        }

        function simulateFileDownload(fileName) {
            const link = document.createElement('a');
            link.href = '#';
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`📥 Téléchargement simulé: ${fileName}`);
        }

        // AUTRES FONCTIONS
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth <= 768) {
                if (sidebar.classList.contains('open')) {
                    closeSidebar();
                } else {
                    sidebar.classList.add('open');
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            } else {
                sidebar.classList.toggle('collapsed');
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function toggleSatelliteView() {
            const button = document.getElementById('toggleSatellite');
            if (currentBaseLayer === 'standard') {
                map.removeLayer(baseLayers.standard);
                map.addLayer(baseLayers.satellite);
                currentBaseLayer = 'satellite';
                button.classList.add('active');
            } else {
                map.removeLayer(baseLayers.satellite);
                map.addLayer(baseLayers.standard);
                currentBaseLayer = 'standard';
                button.classList.remove('active');
            }
        }

        // GESTION DES ÉVÉNEMENTS
        function initializeEventListeners() {
            // Navigation et interface
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            document.getElementById('zoomHome').addEventListener('click', () => map.setView(CONFIG.map.center, CONFIG.map.zoom));
            document.getElementById('toggleSatellite').addEventListener('click', toggleSatelliteView);
            
            // Géolocalisation
            document.getElementById('locateUser').addEventListener('click', locateUser);
            
            // Outils de mesure
            document.getElementById('measureDistance').addEventListener('click', startDistanceMeasurement);
            document.getElementById('measureArea').addEventListener('click', startAreaMeasurement);
            document.getElementById('clearMeasurements').addEventListener('click', clearAllMeasurements);
            
            // Impression
            document.getElementById('printMap').addEventListener('click', openPrintModal);
            document.getElementById('closePrintModal').addEventListener('click', closePrintModal);
            document.getElementById('cancelPrint').addEventListener('click', closePrintModal);
            document.getElementById('proceedToPay').addEventListener('click', proceedToPayment);
            
            // Sélection de zone d'impression
            document.getElementById('selectPrintArea').addEventListener('click', startPrintAreaSelection);
            document.getElementById('useCurrentView').addEventListener('click', useCurrentMapView);
            document.getElementById('clearPrintArea').addEventListener('click', clearPrintAreaSelection);
            
            // Modal village
            document.getElementById('closeVillageModal').addEventListener('click', closeVillageModal);
            
            // Paiement
            document.getElementById('cancelPayment').addEventListener('click', cancelPayment);
            document.getElementById('confirmPayment').addEventListener('click', processPayment);
            
            // Sélection des méthodes de paiement
            document.querySelectorAll('.payment-method').forEach(method => {
                method.addEventListener('click', function() {
                    selectPaymentMethod(this.dataset.method);
                });
            });
            
            // Sélectionner Mobile Money par défaut
            selectPaymentMethod('mobilemoney');

            // Événements pour l'impression
            document.getElementById('mapTitle').addEventListener('input', updatePrintPreview);
            document.getElementById('outputFormat').addEventListener('change', updatePrintPreview);
            document.getElementById('mapScale').addEventListener('input', updatePrintPreview);
            document.getElementById('showNorthArrow').addEventListener('change', updatePrintPreview);
            document.getElementById('showScale').addEventListener('change', updatePrintPreview);
            document.getElementById('showLegend').addEventListener('change', updatePrintPreview);
            document.getElementById('showCoordinates').addEventListener('change', updatePrintPreview);

            document.querySelectorAll('.format-option').forEach(option => {
                option.addEventListener('click', function() {
                    const format = this.dataset.format;
                    const price = parseInt(this.dataset.price);
                    selectFormat(format, price);
                });
            });

            document.querySelectorAll('.scale-preset').forEach(preset => {
                preset.addEventListener('click', function() {
                    const scale = this.dataset.scale;
                    setScale(scale);
                });
            });

            document.querySelectorAll('.layer-toggle').forEach(toggle => {
                toggle.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const layer = this.dataset.layer;
                    if (mapLayers[layer]) {
                        if (map.hasLayer(mapLayers[layer])) {
                            map.removeLayer(mapLayers[layer]);
                        } else {
                            map.addLayer(mapLayers[layer]);
                        }
                    }
                });
            });

            // Recherche intelligente
            document.getElementById('searchBtn').addEventListener('click', function() {
                const query = document.getElementById('searchInput').value.trim();
                if (query.length >= 2) {
                    performIntelligentSearch(query);
                }
            });

            // Raccourcis clavier
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    startDistanceMeasurement();
                } else if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    startAreaMeasurement();
                } else if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    openPrintModal();
                } else if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    locateUser();
                } else if (e.key === 'Escape') {
                    if (document.getElementById('villageModal').classList.contains('active')) {
                        closeVillageModal();
                    } else if (document.getElementById('printModal').classList.contains('active')) {
                        closePrintModal();
                    } else if (document.getElementById('paymentModal').classList.contains('active')) {
                        cancelPayment();
                    } else if (isLocating) {
                        stopLocationTracking();
                    } else if (isSelectingPrintArea) {
                        stopPrintAreaSelection();
                    }
                }
            });
        }

        // ADMINISTRATION
        window.checkAdminAccess = function() {
            window.location.href = 'login.html';
        };

        // INITIALISATION PRINCIPALE
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('🚀 Initialisation MonVillage avec priorités de clic et recherche intelligente');
                
                initializeSupabase();
                initializeMap();
                initializeNativeMeasurementTools();
                initializeEventListeners();
                initializeIntelligentSearch();
                loadInitialData();
                
                showNotification('MonVillage chargé avec succès', 'success');
                
            } catch (error) {
                console.error('Erreur lors de l\'initialisation:', error);
                showNotification('Erreur lors du chargement de l\'application', 'error');
            }
        });

        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (window.innerWidth > 768) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
            
            if (previewMap) {
                setTimeout(() => previewMap.invalidateSize(), 100);
            }
        });

        // Gestion des erreurs globales
        window.addEventListener('error', function(e) {
            console.error('Erreur globale:', e.error);
            showNotification('Une erreur inattendue s\'est produite', 'error');
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Promise non gérée:', e.reason);
            showNotification('Erreur de connexion - vérifiez votre réseau', 'warning');
        });
    </script>
</body>
</html>